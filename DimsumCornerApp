//This is an MVP for teh Dimsum Corner App - A comprehensive platform for managing the entire Dimsum Corner production and distribution, from raw material procurement production and sales& delivery with sales reporting. It helps manage the entire operational lifecycle, with role-based credentials to maximize productivity, traceability and transparency across departments.
//https://dimsumcornercebu.base44.app/

// 489 DASHBOARD
// 817 DELIVERIES // 1310 DELIVERIES SCHEDULE 
// 1567 INVENTORY REPORT 
// 4738 PROFILE
// 4961 PURCHASE ORDERS
// 5576 RAW MATERIALS
// 6021 RAW MATERIALS INVENTORY
// 6424 SALES ORDER
// 7310 SUPPLIERS
// 7666 USER MANAGEMENT



//PAGES********************
//PAGES - Customers*****
import React, { useState } from 'react';
import { base44 } from '@/api/base44Client';
import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';
import PageHeader from '../components/shared/PageHeader';
import DataTable from '../components/shared/DataTable';
import StatusBadge from '../components/shared/StatusBadge';
import { usePermissions } from '../components/shared/PermissionGuard';
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Textarea } from "@/components/ui/textarea";
import {
  Dialog,
  DialogContent,
  DialogHeader,
  DialogTitle,
} from "@/components/ui/dialog";
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from "@/components/ui/select";
import { Search, Users, Phone, Mail, MapPin, MoreVertical, Pencil, Trash2 } from 'lucide-react';
import {
  DropdownMenu,
  DropdownMenuContent,
  DropdownMenuItem,
  DropdownMenuTrigger,
} from "@/components/ui/dropdown-menu";
import { Badge } from "@/components/ui/badge";
import { toast } from "sonner";

const CUSTOMER_TYPES = [
  { value: 'retail', label: 'Retail' },
  { value: 'wholesale', label: 'Wholesale' },
  { value: 'distributor', label: 'Distributor' },
  { value: 'online', label: 'Online' },
  { value: 'restaurant', label: 'Restaurant' },
  { value: 'institution', label: 'Institution' }
];

const PAYMENT_TERMS = [
  { value: 'cod', label: 'Cash on Delivery' },
  { value: 'prepaid', label: 'Prepaid' },
  { value: 'net_7', label: 'Net 7' },
  { value: 'net_15', label: 'Net 15' },
  { value: 'net_30', label: 'Net 30' }
];

const ZONES = [
  { value: 'zone_a', label: 'Zone A' },
  { value: 'zone_b', label: 'Zone B' },
  { value: 'zone_c', label: 'Zone C' },
  { value: 'zone_d', label: 'Zone D' },
  { value: 'pickup', label: 'Pickup' }
];

export default function Customers() {
  const permissions = usePermissions();
  const [isOpen, setIsOpen] = useState(false);
  const [editingCustomer, setEditingCustomer] = useState(null);
  const [search, setSearch] = useState('');
  const [typeFilter, setTypeFilter] = useState('all');
  const [formData, setFormData] = useState({
    name: '',
    customer_type: 'retail',
    contact_person: '',
    email: '',
    phone: '',
    billing_address: '',
    shipping_address: '',
    payment_terms: 'net_30',
    credit_limit: 0,
    discount_rate: 0,
    delivery_zone: 'zone_a',
    status: 'active',
    notes: ''
  });

  const queryClient = useQueryClient();

  const { data: customers = [], isLoading } = useQuery({
    queryKey: ['customers'],
    queryFn: () => base44.entities.Customer.list('-created_date'),
  });

  const createMutation = useMutation({
    mutationFn: (data) => base44.entities.Customer.create(data),
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['customers'] });
      toast.success('Customer created successfully');
      handleClose();
    },
  });

  const updateMutation = useMutation({
    mutationFn: ({ id, data }) => base44.entities.Customer.update(id, data),
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['customers'] });
      toast.success('Customer updated successfully');
      handleClose();
    },
  });

  const deleteMutation = useMutation({
    mutationFn: (id) => base44.entities.Customer.delete(id),
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['customers'] });
      toast.success('Customer deleted successfully');
    },
  });

  const handleOpen = (customer = null) => {
    if (customer) {
      setEditingCustomer(customer);
      setFormData({
        name: customer.name || '',
        customer_type: customer.customer_type || 'retail',
        contact_person: customer.contact_person || '',
        email: customer.email || '',
        phone: customer.phone || '',
        billing_address: customer.billing_address || '',
        shipping_address: customer.shipping_address || '',
        payment_terms: customer.payment_terms || 'net_30',
        credit_limit: customer.credit_limit || 0,
        discount_rate: customer.discount_rate || 0,
        delivery_zone: customer.delivery_zone || 'zone_a',
        status: customer.status || 'active',
        notes: customer.notes || ''
      });
    } else {
      setEditingCustomer(null);
      setFormData({
        name: '',
        customer_type: 'retail',
        contact_person: '',
        email: '',
        phone: '',
        billing_address: '',
        shipping_address: '',
        payment_terms: 'net_30',
        credit_limit: 0,
        discount_rate: 0,
        delivery_zone: 'zone_a',
        status: 'active',
        notes: ''
      });
    }
    setIsOpen(true);
  };

  const handleClose = () => {
    setIsOpen(false);
    setEditingCustomer(null);
  };

  const handleSubmit = (e) => {
    e.preventDefault();
    if (editingCustomer) {
      updateMutation.mutate({ id: editingCustomer.id, data: formData });
    } else {
      createMutation.mutate(formData);
    }
  };

  const filteredCustomers = customers.filter(c => {
    const matchesSearch = c.name?.toLowerCase().includes(search.toLowerCase()) ||
      c.email?.toLowerCase().includes(search.toLowerCase()) ||
      c.contact_person?.toLowerCase().includes(search.toLowerCase());
    const matchesType = typeFilter === 'all' || c.customer_type === typeFilter;
    return matchesSearch && matchesType;
  });

  const columns = [
    {
      header: 'Customer',
      cell: (row) => (
        <div className="flex items-center gap-3">
          <div className="w-10 h-10 rounded-lg bg-purple-100 flex items-center justify-center">
            <Users className="w-5 h-5 text-purple-600" />
          </div>
          <div>
            <p className="font-medium text-slate-900">{row.name}</p>
            <p className="text-sm text-slate-500">{row.contact_person}</p>
          </div>
        </div>
      )
    },
    {
      header: 'Type',
      cell: (row) => (
        <Badge variant="outline" className="capitalize">
          {row.customer_type}
        </Badge>
      )
    },
    {
      header: 'Contact',
      cell: (row) => (
        <div className="space-y-1">
          <div className="flex items-center gap-2 text-sm text-slate-600">
            <Mail className="w-4 h-4" />
            {row.email}
          </div>
          {row.phone && (
            <div className="flex items-center gap-2 text-sm text-slate-500">
              <Phone className="w-4 h-4" />
              {row.phone}
            </div>
          )}
        </div>
      )
    },
    {
      header: 'Credit',
      cell: (row) => (
        <div>
          <p className="font-medium text-slate-900">${(row.credit_limit || 0).toLocaleString()}</p>
          <p className="text-xs text-slate-500">Balance: ${(row.current_balance || 0).toLocaleString()}</p>
        </div>
      )
    },
    {
      header: 'Zone',
      cell: (row) => (
        <span className="text-sm text-slate-600 capitalize">
          {row.delivery_zone?.replace(/_/g, ' ')}
        </span>
      )
    },
    {
      header: 'Status',
      cell: (row) => <StatusBadge status={row.status} />
    },
    {
      header: '',
      className: 'w-12',
      cell: (row) => (
        <DropdownMenu>
          <DropdownMenuTrigger asChild>
            <Button variant="ghost" size="icon">
              <MoreVertical className="w-4 h-4" />
            </Button>
          </DropdownMenuTrigger>
          <DropdownMenuContent align="end">
            <DropdownMenuItem onClick={() => handleOpen(row)}>
              <Pencil className="w-4 h-4 mr-2" />
              Edit
            </DropdownMenuItem>
            <DropdownMenuItem 
              onClick={() => deleteMutation.mutate(row.id)}
              className="text-red-600"
            >
              <Trash2 className="w-4 h-4 mr-2" />
              Delete
            </DropdownMenuItem>
          </DropdownMenuContent>
        </DropdownMenu>
      )
    }
  ];

  return (
    <div>
      <PageHeader
        title="Customers"
        description="Manage your customer database"
        action={permissions.canCreate ? () => handleOpen() : null}
        actionLabel="Add Customer"
      >
        <Select value={typeFilter} onValueChange={setTypeFilter}>
          <SelectTrigger className="w-40">
            <SelectValue placeholder="Type" />
          </SelectTrigger>
          <SelectContent>
            <SelectItem value="all">All Types</SelectItem>
            {CUSTOMER_TYPES.map(t => (
              <SelectItem key={t.value} value={t.value}>{t.label}</SelectItem>
            ))}
          </SelectContent>
        </Select>
        <div className="relative">
          <Search className="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400" />
          <Input
            placeholder="Search customers..."
            value={search}
            onChange={(e) => setSearch(e.target.value)}
            className="pl-10 w-64"
          />
        </div>
      </PageHeader>

      <DataTable
        columns={columns}
        data={filteredCustomers}
        isLoading={isLoading}
        emptyMessage="No customers found. Add your first customer to get started."
      />

      <Dialog open={isOpen} onOpenChange={setIsOpen}>
        <DialogContent className="max-w-lg max-h-[90vh] overflow-y-auto">
          <DialogHeader>
            <DialogTitle>
              {editingCustomer ? 'Edit Customer' : 'Add New Customer'}
            </DialogTitle>
          </DialogHeader>
          <form onSubmit={handleSubmit} className="space-y-4">
            <div className="grid grid-cols-2 gap-4">
              <div className="col-span-2">
                <Label>Company/Customer Name *</Label>
                <Input
                  value={formData.name}
                  onChange={(e) => setFormData({ ...formData, name: e.target.value })}
                  required
                />
              </div>
              <div>
                <Label>Customer Type</Label>
                <Select
                  value={formData.customer_type}
                  onValueChange={(value) => setFormData({ ...formData, customer_type: value })}
                >
                  <SelectTrigger>
                    <SelectValue />
                  </SelectTrigger>
                  <SelectContent>
                    {CUSTOMER_TYPES.map(t => (
                      <SelectItem key={t.value} value={t.value}>{t.label}</SelectItem>
                    ))}
                  </SelectContent>
                </Select>
              </div>
              <div>
                <Label>Contact Person</Label>
                <Input
                  value={formData.contact_person}
                  onChange={(e) => setFormData({ ...formData, contact_person: e.target.value })}
                />
              </div>
              <div>
                <Label>Email *</Label>
                <Input
                  type="email"
                  value={formData.email}
                  onChange={(e) => setFormData({ ...formData, email: e.target.value })}
                  required
                />
              </div>
              <div>
                <Label>Phone</Label>
                <Input
                  value={formData.phone}
                  onChange={(e) => setFormData({ ...formData, phone: e.target.value })}
                />
              </div>
              <div className="col-span-2">
                <Label>Billing Address</Label>
                <Textarea
                  value={formData.billing_address}
                  onChange={(e) => setFormData({ ...formData, billing_address: e.target.value })}
                  rows={2}
                />
              </div>
              <div className="col-span-2">
                <Label>Shipping Address</Label>
                <Textarea
                  value={formData.shipping_address}
                  onChange={(e) => setFormData({ ...formData, shipping_address: e.target.value })}
                  rows={2}
                />
              </div>
              <div>
                <Label>Payment Terms</Label>
                <Select
                  value={formData.payment_terms}
                  onValueChange={(value) => setFormData({ ...formData, payment_terms: value })}
                >
                  <SelectTrigger>
                    <SelectValue />
                  </SelectTrigger>
                  <SelectContent>
                    {PAYMENT_TERMS.map(t => (
                      <SelectItem key={t.value} value={t.value}>{t.label}</SelectItem>
                    ))}
                  </SelectContent>
                </Select>
              </div>
              <div>
                <Label>Delivery Zone</Label>
                <Select
                  value={formData.delivery_zone}
                  onValueChange={(value) => setFormData({ ...formData, delivery_zone: value })}
                >
                  <SelectTrigger>
                    <SelectValue />
                  </SelectTrigger>
                  <SelectContent>
                    {ZONES.map(z => (
                      <SelectItem key={z.value} value={z.value}>{z.label}</SelectItem>
                    ))}
                  </SelectContent>
                </Select>
              </div>
              <div>
                <Label>Credit Limit ($)</Label>
                <Input
                  type="number"
                  min="0"
                  value={formData.credit_limit}
                  onChange={(e) => setFormData({ ...formData, credit_limit: parseFloat(e.target.value) || 0 })}
                />
              </div>
              <div>
                <Label>Discount Rate (%)</Label>
                <Input
                  type="number"
                  min="0"
                  max="100"
                  step="0.1"
                  value={formData.discount_rate}
                  onChange={(e) => setFormData({ ...formData, discount_rate: parseFloat(e.target.value) || 0 })}
                />
              </div>
              <div>
                <Label>Status</Label>
                <Select
                  value={formData.status}
                  onValueChange={(value) => setFormData({ ...formData, status: value })}
                >
                  <SelectTrigger>
                    <SelectValue />
                  </SelectTrigger>
                  <SelectContent>
                    <SelectItem value="active">Active</SelectItem>
                    <SelectItem value="inactive">Inactive</SelectItem>
                    <SelectItem value="on_hold">On Hold</SelectItem>
                    <SelectItem value="blocked">Blocked</SelectItem>
                  </SelectContent>
                </Select>
              </div>
              <div className="col-span-2">
                <Label>Notes</Label>
                <Textarea
                  value={formData.notes}
                  onChange={(e) => setFormData({ ...formData, notes: e.target.value })}
                  rows={2}
                />
              </div>
            </div>
            <div className="flex justify-end gap-3 pt-4">
              <Button type="button" variant="outline" onClick={handleClose}>
                Cancel
              </Button>
              <Button 
                type="submit" 
                className="bg-emerald-600 hover:bg-emerald-700"
                disabled={createMutation.isPending || updateMutation.isPending}
              >
                {editingCustomer ? 'Update' : 'Create'} Customer
              </Button>
            </div>
          </form>
        </DialogContent>
      </Dialog>
    </div>
  );
}

//PAGES - Dashboard*****
import React, { useState, useEffect } from 'react';
import { base44 } from '@/api/base44Client';
import { useQuery } from '@tanstack/react-query';
import { Link } from 'react-router-dom';
import { createPageUrl } from '../utils';
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import StatCard from '../components/shared/StatCard';
import StatusBadge from '../components/shared/StatusBadge';
import { 
  Package, 
  Factory, 
  ShoppingCart, 
  Truck, 
  TrendingUp,
  AlertTriangle,
  Clock,
  DollarSign,
  ArrowRight,
  Boxes
} from 'lucide-react';
import { format } from 'date-fns';
import { 
  AreaChart, 
  Area, 
  XAxis, 
  YAxis, 
  CartesianGrid, 
  Tooltip, 
  ResponsiveContainer,
  BarChart,
  Bar,
  PieChart,
  Pie,
  Cell
} from 'recharts';

const COLORS = ['#10b981', '#3b82f6', '#f59e0b', '#ef4444', '#8b5cf6'];

export default function Dashboard() {
  const { data: salesOrders = [], isLoading: loadingOrders } = useQuery({
    queryKey: ['salesOrders'],
    queryFn: () => base44.entities.SalesOrder.list('-created_date', 100),
  });

  const { data: productionBatches = [], isLoading: loadingBatches } = useQuery({
    queryKey: ['productionBatches'],
    queryFn: () => base44.entities.ProductionBatch.list('-created_date', 50),
  });

  const { data: products = [], isLoading: loadingProducts } = useQuery({
    queryKey: ['products'],
    queryFn: () => base44.entities.Product.list(),
  });

  const { data: rawMaterials = [], isLoading: loadingMaterials } = useQuery({
    queryKey: ['rawMaterials'],
    queryFn: () => base44.entities.RawMaterial.list(),
  });

  const { data: deliveries = [], isLoading: loadingDeliveries } = useQuery({
    queryKey: ['deliveries'],
    queryFn: () => base44.entities.Delivery.list('-created_date', 20),
  });

  // Calculate stats
  const totalSales = salesOrders.reduce((sum, o) => sum + (o.total_amount || 0), 0);
  const pendingOrders = salesOrders.filter(o => ['pending_approval', 'approved', 'processing'].includes(o.status)).length;
  const activeProduction = productionBatches.filter(b => ['scheduled', 'in_progress'].includes(b.status)).length;
  const lowStockItems = rawMaterials.filter(m => (m.current_stock || 0) <= (m.minimum_stock || 0)).length;

  // Sales by status for pie chart
  const ordersByStatus = salesOrders.reduce((acc, order) => {
    acc[order.status] = (acc[order.status] || 0) + 1;
    return acc;
  }, {});

  const statusPieData = Object.entries(ordersByStatus).map(([status, count]) => ({
    name: status.replace(/_/g, ' '),
    value: count
  }));

  // Recent orders
  const recentOrders = salesOrders.slice(0, 5);

  // Production schedule
  const upcomingBatches = productionBatches
    .filter(b => ['scheduled', 'in_progress'].includes(b.status))
    .slice(0, 5);

  // Low stock alerts
  const lowStockAlerts = rawMaterials
    .filter(m => (m.current_stock || 0) <= (m.minimum_stock || 0))
    .slice(0, 5);

  return (
    <div className="space-y-8">
      {/* Stats Grid */}
      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
        <StatCard
          title="Total Sales (This Month)"
          value={`₱${totalSales.toLocaleString()}`}
          change={12.5}
          changeLabel="vs last month"
          icon={DollarSign}
          iconColor="bg-emerald-100 text-emerald-600"
          loading={loadingOrders}
        />
        <StatCard
          title="Pending Orders"
          value={pendingOrders}
          icon={ShoppingCart}
          iconColor="bg-blue-100 text-blue-600"
          loading={loadingOrders}
        />
        <StatCard
          title="Active Production"
          value={activeProduction}
          icon={Factory}
          iconColor="bg-amber-100 text-amber-600"
          loading={loadingBatches}
        />
        <StatCard
          title="Low Stock Alerts"
          value={lowStockItems}
          icon={AlertTriangle}
          iconColor="bg-red-100 text-red-600"
          loading={loadingMaterials}
        />
      </div>

      <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
        {/* Recent Orders */}
        <Card className="lg:col-span-2 bg-white border-slate-200">
          <CardHeader className="flex flex-row items-center justify-between pb-2">
            <CardTitle className="text-lg font-semibold">Recent Orders</CardTitle>
            <Link 
              to={createPageUrl('SalesOrders')}
              className="text-sm text-emerald-600 hover:text-emerald-700 flex items-center gap-1"
            >
              View all <ArrowRight className="w-4 h-4" />
            </Link>
          </CardHeader>
          <CardContent>
            <div className="space-y-4">
              {loadingOrders ? (
                [...Array(5)].map((_, i) => (
                  <div key={i} className="h-14 bg-slate-100 rounded-lg animate-pulse" />
                ))
              ) : recentOrders.length === 0 ? (
                <p className="text-slate-500 text-center py-8">No orders yet</p>
              ) : (
                recentOrders.map((order) => (
                  <div 
                    key={order.id}
                    className="flex items-center justify-between p-4 rounded-xl bg-slate-50 hover:bg-slate-100 transition-colors"
                  >
                    <div className="flex items-center gap-4">
                      <div className="w-10 h-10 rounded-lg bg-blue-100 flex items-center justify-center">
                        <ShoppingCart className="w-5 h-5 text-blue-600" />
                      </div>
                      <div>
                        <p className="font-medium text-slate-900">{order.order_number || `#${order.id.slice(-6)}`}</p>
                        <p className="text-sm text-slate-500">{order.customer_name}</p>
                      </div>
                    </div>
                    <div className="text-right">
                      <p className="font-semibold text-slate-900">₱{(order.total_amount || 0).toLocaleString()}</p>
                      <StatusBadge status={order.status} />
                    </div>
                  </div>
                ))
              )}
            </div>
          </CardContent>
        </Card>

        {/* Order Status Distribution */}
        <Card className="bg-white border-slate-200">
          <CardHeader className="pb-2">
            <CardTitle className="text-lg font-semibold">Order Status</CardTitle>
          </CardHeader>
          <CardContent>
            <div className="h-[250px]">
              {statusPieData.length > 0 ? (
                <ResponsiveContainer width="100%" height="100%">
                  <PieChart>
                    <Pie
                      data={statusPieData}
                      cx="50%"
                      cy="50%"
                      innerRadius={60}
                      outerRadius={80}
                      paddingAngle={5}
                      dataKey="value"
                    >
                      {statusPieData.map((_, index) => (
                        <Cell key={`cell-${index}`} fill={COLORS[index % COLORS.length]} />
                      ))}
                    </Pie>
                    <Tooltip />
                  </PieChart>
                </ResponsiveContainer>
              ) : (
                <div className="h-full flex items-center justify-center text-slate-500">
                  No data available
                </div>
              )}
            </div>
            <div className="flex flex-wrap gap-2 mt-4">
              {statusPieData.map((entry, index) => (
                <div key={entry.name} className="flex items-center gap-2 text-sm">
                  <div 
                    className="w-3 h-3 rounded-full" 
                    style={{ backgroundColor: COLORS[index % COLORS.length] }}
                  />
                  <span className="text-slate-600 capitalize">{entry.name}</span>
                </div>
              ))}
            </div>
          </CardContent>
        </Card>
      </div>

      <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
        {/* Production Schedule */}
        <Card className="bg-white border-slate-200">
          <CardHeader className="flex flex-row items-center justify-between pb-2">
            <CardTitle className="text-lg font-semibold">Production Schedule</CardTitle>
            <Link 
              to={createPageUrl('ProductionBatches')}
              className="text-sm text-emerald-600 hover:text-emerald-700 flex items-center gap-1"
            >
              View all <ArrowRight className="w-4 h-4" />
            </Link>
          </CardHeader>
          <CardContent>
            <div className="space-y-4">
              {loadingBatches ? (
                [...Array(4)].map((_, i) => (
                  <div key={i} className="h-14 bg-slate-100 rounded-lg animate-pulse" />
                ))
              ) : upcomingBatches.length === 0 ? (
                <p className="text-slate-500 text-center py-8">No scheduled batches</p>
              ) : (
                upcomingBatches.map((batch) => (
                  <div 
                    key={batch.id}
                    className="flex items-center justify-between p-4 rounded-xl bg-slate-50"
                  >
                    <div className="flex items-center gap-4">
                      <div className="w-10 h-10 rounded-lg bg-amber-100 flex items-center justify-center">
                        <Factory className="w-5 h-5 text-amber-600" />
                      </div>
                      <div>
                        <p className="font-medium text-slate-900">{batch.batch_number}</p>
                        <p className="text-sm text-slate-500">{batch.product_name}</p>
                      </div>
                    </div>
                    <div className="text-right">
                      <p className="font-medium text-slate-700">{batch.planned_quantity} units</p>
                      <StatusBadge status={batch.status} />
                    </div>
                  </div>
                ))
              )}
            </div>
          </CardContent>
        </Card>

        {/* Low Stock Alerts */}
        <Card className="bg-white border-slate-200">
          <CardHeader className="flex flex-row items-center justify-between pb-2">
            <CardTitle className="text-lg font-semibold">Low Stock Alerts</CardTitle>
            <Link 
              to={createPageUrl('RawMaterialsInventory')}
              className="text-sm text-emerald-600 hover:text-emerald-700 flex items-center gap-1"
            >
              View all <ArrowRight className="w-4 h-4" />
            </Link>
          </CardHeader>
          <CardContent>
            <div className="space-y-4">
              {loadingMaterials ? (
                [...Array(4)].map((_, i) => (
                  <div key={i} className="h-14 bg-slate-100 rounded-lg animate-pulse" />
                ))
              ) : lowStockAlerts.length === 0 ? (
                <div className="text-center py-8">
                  <div className="w-12 h-12 rounded-full bg-emerald-100 flex items-center justify-center mx-auto mb-3">
                    <Boxes className="w-6 h-6 text-emerald-600" />
                  </div>
                  <p className="text-slate-500">All stock levels are healthy</p>
                </div>
              ) : (
                lowStockAlerts.map((material) => (
                  <div 
                    key={material.id}
                    className="flex items-center justify-between p-4 rounded-xl bg-red-50 border border-red-100"
                  >
                    <div className="flex items-center gap-4">
                      <div className="w-10 h-10 rounded-lg bg-red-100 flex items-center justify-center">
                        <AlertTriangle className="w-5 h-5 text-red-600" />
                      </div>
                      <div>
                        <p className="font-medium text-slate-900">{material.name}</p>
                        <p className="text-sm text-slate-500">{material.sku}</p>
                      </div>
                    </div>
                    <div className="text-right">
                      <p className="font-medium text-red-600">
                        {material.current_stock || 0} {material.unit}
                      </p>
                      <p className="text-xs text-slate-500">
                        Min: {material.minimum_stock || 0} {material.unit}
                      </p>
                    </div>
                  </div>
                ))
              )}
            </div>
          </CardContent>
        </Card>
      </div>
    </div>
  );
}

//PAGES - Deliveries *****
import React, { useState } from 'react';
import { base44 } from '@/api/base44Client';
import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';
import PageHeader from '../components/shared/PageHeader';
import DataTable from '../components/shared/DataTable';
import StatusBadge from '../components/shared/StatusBadge';
import { usePermissions } from '../components/shared/PermissionGuard';
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Textarea } from "@/components/ui/textarea";
import { Card } from "@/components/ui/card";
import { Checkbox } from "@/components/ui/checkbox";
import {
  Dialog,
  DialogContent,
  DialogHeader,
  DialogTitle,
} from "@/components/ui/dialog";
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from "@/components/ui/select";
import { 
  Search, 
  Truck, 
  MoreVertical, 
  Pencil, 
  Trash2,
  Play,
  CheckCircle,
  MapPin
} from 'lucide-react';
import {
  DropdownMenu,
  DropdownMenuContent,
  DropdownMenuItem,
  DropdownMenuSeparator,
  DropdownMenuTrigger,
} from "@/components/ui/dropdown-menu";
import { format } from 'date-fns';
import { toast } from "sonner";

const ZONES = [
  { value: 'zone_a', label: 'Zone A' },
  { value: 'zone_b', label: 'Zone B' },
  { value: 'zone_c', label: 'Zone C' },
  { value: 'zone_d', label: 'Zone D' }
];

const TIME_SLOTS = [
  { value: 'morning', label: 'Morning (8AM - 12PM)' },
  { value: 'afternoon', label: 'Afternoon (12PM - 5PM)' },
  { value: 'evening', label: 'Evening (5PM - 9PM)' }
];

export default function Deliveries() {
  const permissions = usePermissions();
  const [isOpen, setIsOpen] = useState(false);
  const [editingDelivery, setEditingDelivery] = useState(null);
  const [search, setSearch] = useState('');
  const [statusFilter, setStatusFilter] = useState('all');
  const [formData, setFormData] = useState({
    scheduled_date: format(new Date(), 'yyyy-MM-dd'),
    scheduled_time_slot: 'morning',
    delivery_zone: 'zone_a',
    driver: '',
    vehicle: '',
    order_ids: [],
    notes: ''
  });

  const queryClient = useQueryClient();

  const { data: deliveries = [], isLoading } = useQuery({
    queryKey: ['deliveries'],
    queryFn: () => base44.entities.Delivery.list('-created_date'),
  });

  const { data: orders = [] } = useQuery({
    queryKey: ['salesOrders'],
    queryFn: () => base44.entities.SalesOrder.list('-created_date'),
  });

  const readyOrders = orders.filter(o => 
    ['ready', 'approved'].includes(o.status) && 
    !deliveries.some(d => d.order_ids?.includes(o.id))
  );

  const createMutation = useMutation({
    mutationFn: (data) => base44.entities.Delivery.create(data),
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['deliveries'] });
      toast.success('Delivery scheduled');
      handleClose();
    },
  });

  const updateMutation = useMutation({
    mutationFn: ({ id, data }) => base44.entities.Delivery.update(id, data),
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['deliveries'] });
      toast.success('Delivery updated');
      handleClose();
    },
  });

  const deleteMutation = useMutation({
    mutationFn: (id) => base44.entities.Delivery.delete(id),
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['deliveries'] });
      toast.success('Delivery deleted');
    },
  });

  const generateDeliveryNumber = () => {
    const date = new Date();
    const prefix = 'DEL';
    const year = date.getFullYear().toString().slice(-2);
    const month = (date.getMonth() + 1).toString().padStart(2, '0');
    const day = date.getDate().toString().padStart(2, '0');
    const random = Math.floor(Math.random() * 100).toString().padStart(2, '0');
    return `${prefix}${year}${month}${day}-${random}`;
  };

  const handleOpen = (delivery = null) => {
    if (delivery) {
      setEditingDelivery(delivery);
      setFormData({
        scheduled_date: delivery.scheduled_date || format(new Date(), 'yyyy-MM-dd'),
        scheduled_time_slot: delivery.scheduled_time_slot || 'morning',
        delivery_zone: delivery.delivery_zone || 'zone_a',
        driver: delivery.driver || '',
        vehicle: delivery.vehicle || '',
        order_ids: delivery.order_ids || [],
        notes: delivery.notes || ''
      });
    } else {
      setEditingDelivery(null);
      setFormData({
        scheduled_date: format(new Date(), 'yyyy-MM-dd'),
        scheduled_time_slot: 'morning',
        delivery_zone: 'zone_a',
        driver: '',
        vehicle: '',
        order_ids: [],
        notes: ''
      });
    }
    setIsOpen(true);
  };

  const handleClose = () => {
    setIsOpen(false);
    setEditingDelivery(null);
  };

  const toggleOrder = (orderId) => {
    setFormData(prev => ({
      ...prev,
      order_ids: prev.order_ids.includes(orderId)
        ? prev.order_ids.filter(id => id !== orderId)
        : [...prev.order_ids, orderId]
    }));
  };

  const handleSubmit = (e) => {
    e.preventDefault();
    
    const selectedOrders = orders.filter(o => formData.order_ids.includes(o.id));
    const stops = selectedOrders.map((order, i) => ({
      order_id: order.id,
      customer_name: order.customer_name,
      address: order.shipping_address,
      sequence: i + 1,
      status: 'pending'
    }));

    const data = {
      ...formData,
      delivery_number: editingDelivery?.delivery_number || generateDeliveryNumber(),
      order_numbers: selectedOrders.map(o => o.order_number || o.id.slice(-6)),
      stops,
      status: 'scheduled'
    };

    if (editingDelivery) {
      updateMutation.mutate({ id: editingDelivery.id, data });
    } else {
      createMutation.mutate(data);
    }
  };

  const handleStatusChange = async (delivery, newStatus) => {
    const updates = { status: newStatus };
    if (newStatus === 'in_transit') {
      updates.departure_time = new Date().toISOString();
    }
    if (newStatus === 'completed') {
      updates.completion_time = new Date().toISOString();
    }
    await updateMutation.mutateAsync({ id: delivery.id, data: updates });
  };

  const filteredDeliveries = deliveries.filter(d => {
    const matchesSearch = d.delivery_number?.toLowerCase().includes(search.toLowerCase()) ||
      d.driver?.toLowerCase().includes(search.toLowerCase());
    const matchesStatus = statusFilter === 'all' || d.status === statusFilter;
    return matchesSearch && matchesStatus;
  });

  const columns = [
    {
      header: 'Delivery',
      cell: (row) => (
        <div className="flex items-center gap-3">
          <div className={`w-10 h-10 rounded-lg flex items-center justify-center ${
            row.status === 'completed' ? 'bg-emerald-100' : 
            row.status === 'in_transit' ? 'bg-blue-100' : 'bg-amber-100'
          }`}>
            <Truck className={`w-5 h-5 ${
              row.status === 'completed' ? 'text-emerald-600' : 
              row.status === 'in_transit' ? 'text-blue-600' : 'text-amber-600'
            }`} />
          </div>
          <div>
            <p className="font-medium text-slate-900">{row.delivery_number}</p>
            <p className="text-sm text-slate-500">{row.driver || 'Unassigned'}</p>
          </div>
        </div>
      )
    },
    {
      header: 'Schedule',
      cell: (row) => (
        <div>
          <p className="text-slate-900">{row.scheduled_date ? format(new Date(row.scheduled_date), 'MMM dd, yyyy') : '-'}</p>
          <p className="text-xs text-slate-500 capitalize">{row.scheduled_time_slot}</p>
        </div>
      )
    },
    {
      header: 'Zone',
      cell: (row) => (
        <span className="text-slate-600 capitalize">{row.delivery_zone?.replace(/_/g, ' ')}</span>
      )
    },
    {
      header: 'Stops',
      cell: (row) => (
        <div className="flex items-center gap-1">
          <MapPin className="w-4 h-4 text-slate-400" />
          <span>{row.stops?.length || 0} stops</span>
        </div>
      )
    },
    {
      header: 'Vehicle',
      cell: (row) => (
        <span className="text-slate-600">{row.vehicle || '-'}</span>
      )
    },
    {
      header: 'Status',
      cell: (row) => <StatusBadge status={row.status} />
    },
    {
      header: '',
      className: 'w-12',
      cell: (row) => (
        <DropdownMenu>
          <DropdownMenuTrigger asChild>
            <Button variant="ghost" size="icon">
              <MoreVertical className="w-4 h-4" />
            </Button>
          </DropdownMenuTrigger>
          <DropdownMenuContent align="end">
            <DropdownMenuItem onClick={() => handleOpen(row)}>
              <Pencil className="w-4 h-4 mr-2" />
              Edit
            </DropdownMenuItem>
            <DropdownMenuSeparator />
            {row.status === 'scheduled' && (
              <DropdownMenuItem onClick={() => handleStatusChange(row, 'loading')}>
                Start Loading
              </DropdownMenuItem>
            )}
            {row.status === 'loading' && (
              <DropdownMenuItem onClick={() => handleStatusChange(row, 'in_transit')}>
                <Play className="w-4 h-4 mr-2 text-blue-600" />
                Start Delivery
              </DropdownMenuItem>
            )}
            {row.status === 'in_transit' && (
              <DropdownMenuItem onClick={() => handleStatusChange(row, 'completed')}>
                <CheckCircle className="w-4 h-4 mr-2 text-green-600" />
                Complete Delivery
              </DropdownMenuItem>
            )}
            <DropdownMenuSeparator />
            <DropdownMenuItem 
              onClick={() => deleteMutation.mutate(row.id)}
              className="text-red-600"
            >
              <Trash2 className="w-4 h-4 mr-2" />
              Delete
            </DropdownMenuItem>
          </DropdownMenuContent>
        </DropdownMenu>
      )
    }
  ];

  return (
    <div>
      <PageHeader
        title="Deliveries"
        description="Schedule and track deliveries"
        action={permissions.canCreate ? () => handleOpen() : null}
        actionLabel="Schedule Delivery"
      >
        <Select value={statusFilter} onValueChange={setStatusFilter}>
          <SelectTrigger className="w-40">
            <SelectValue placeholder="Status" />
          </SelectTrigger>
          <SelectContent>
            <SelectItem value="all">All Status</SelectItem>
            <SelectItem value="scheduled">Scheduled</SelectItem>
            <SelectItem value="loading">Loading</SelectItem>
            <SelectItem value="in_transit">In Transit</SelectItem>
            <SelectItem value="completed">Completed</SelectItem>
          </SelectContent>
        </Select>
        <div className="relative">
          <Search className="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400" />
          <Input
            placeholder="Search deliveries..."
            value={search}
            onChange={(e) => setSearch(e.target.value)}
            className="pl-10 w-64"
          />
        </div>
      </PageHeader>

      <DataTable
        columns={columns}
        data={filteredDeliveries}
        isLoading={isLoading}
        emptyMessage="No deliveries found."
      />

      {/* Create/Edit Dialog */}
      <Dialog open={isOpen} onOpenChange={setIsOpen}>
        <DialogContent className="max-w-lg max-h-[90vh] overflow-y-auto">
          <DialogHeader>
            <DialogTitle>
              {editingDelivery ? 'Edit Delivery' : 'Schedule Delivery'}
            </DialogTitle>
          </DialogHeader>
          <form onSubmit={handleSubmit} className="space-y-4">
            <div className="grid grid-cols-2 gap-4">
              <div>
                <Label>Scheduled Date *</Label>
                <Input
                  type="date"
                  value={formData.scheduled_date}
                  onChange={(e) => setFormData({ ...formData, scheduled_date: e.target.value })}
                  required
                />
              </div>
              <div>
                <Label>Time Slot</Label>
                <Select
                  value={formData.scheduled_time_slot}
                  onValueChange={(value) => setFormData({ ...formData, scheduled_time_slot: value })}
                >
                  <SelectTrigger>
                    <SelectValue />
                  </SelectTrigger>
                  <SelectContent>
                    {TIME_SLOTS.map(t => (
                      <SelectItem key={t.value} value={t.value}>{t.label}</SelectItem>
                    ))}
                  </SelectContent>
                </Select>
              </div>
              <div>
                <Label>Delivery Zone</Label>
                <Select
                  value={formData.delivery_zone}
                  onValueChange={(value) => setFormData({ ...formData, delivery_zone: value })}
                >
                  <SelectTrigger>
                    <SelectValue />
                  </SelectTrigger>
                  <SelectContent>
                    {ZONES.map(z => (
                      <SelectItem key={z.value} value={z.value}>{z.label}</SelectItem>
                    ))}
                  </SelectContent>
                </Select>
              </div>
              <div>
                <Label>Vehicle</Label>
                <Input
                  value={formData.vehicle}
                  onChange={(e) => setFormData({ ...formData, vehicle: e.target.value })}
                  placeholder="e.g., Truck #1"
                />
              </div>
              <div className="col-span-2">
                <Label>Driver</Label>
                <Input
                  value={formData.driver}
                  onChange={(e) => setFormData({ ...formData, driver: e.target.value })}
                  placeholder="Driver name"
                />
              </div>
            </div>

            {/* Orders Selection */}
            <div>
              <Label className="text-base">Select Orders</Label>
              <p className="text-sm text-slate-500 mb-2">
                {formData.order_ids.length} orders selected
              </p>
              {readyOrders.length === 0 ? (
                <Card className="p-4 text-center text-slate-500 border-dashed">
                  No orders ready for delivery
                </Card>
              ) : (
                <div className="space-y-2 max-h-48 overflow-y-auto">
                  {readyOrders.map(order => (
                    <Card 
                      key={order.id} 
                      className={`p-3 cursor-pointer transition-colors ${
                        formData.order_ids.includes(order.id) 
                          ? 'bg-emerald-50 border-emerald-200' 
                          : 'hover:bg-slate-50'
                      }`}
                      onClick={() => toggleOrder(order.id)}
                    >
                      <div className="flex items-center gap-3">
                        <Checkbox
                          checked={formData.order_ids.includes(order.id)}
                          onCheckedChange={() => toggleOrder(order.id)}
                        />
                        <div className="flex-1">
                          <p className="font-medium">{order.order_number || order.id.slice(-6)}</p>
                          <p className="text-sm text-slate-500">{order.customer_name}</p>
                        </div>
                        <span className="text-sm text-slate-600 capitalize">
                          {order.delivery_zone?.replace(/_/g, ' ')}
                        </span>
                      </div>
                    </Card>
                  ))}
                </div>
              )}
            </div>

            <div>
              <Label>Notes</Label>
              <Textarea
                value={formData.notes}
                onChange={(e) => setFormData({ ...formData, notes: e.target.value })}
                rows={2}
              />
            </div>

            <div className="flex justify-end gap-3 pt-4">
              <Button type="button" variant="outline" onClick={handleClose}>
                Cancel
              </Button>
              <Button 
                type="submit" 
                className="bg-emerald-600 hover:bg-emerald-700"
                disabled={createMutation.isPending || updateMutation.isPending}
              >
                {editingDelivery ? 'Update' : 'Schedule'} Delivery
              </Button>
            </div>
          </form>
        </DialogContent>
      </Dialog>
    </div>
  );
}

//PAGES - Deliviries Schedule****
import React, { useState } from 'react';
import { base44 } from '@/api/base44Client';
import { useQuery } from '@tanstack/react-query';
import { Card, CardContent } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import StatusBadge from '../components/shared/StatusBadge';
import { 
  ChevronLeft, 
  ChevronRight, 
  Truck,
  MapPin,
  Clock,
  Calendar as CalendarIcon
} from 'lucide-react';
import { format, startOfWeek, addDays, addWeeks, subWeeks, isSameDay } from 'date-fns';
import { cn } from "@/lib/utils";

const ZONES = ['zone_a', 'zone_b', 'zone_c', 'zone_d'];
const TIME_SLOTS = ['morning', 'afternoon', 'evening'];

export default function DeliverySchedule() {
  const [currentWeek, setCurrentWeek] = useState(startOfWeek(new Date(), { weekStartsOn: 1 }));

  const { data: deliveries = [], isLoading } = useQuery({
    queryKey: ['deliveries'],
    queryFn: () => base44.entities.Delivery.list('-scheduled_date', 100),
  });

  const weekDays = Array.from({ length: 7 }, (_, i) => addDays(currentWeek, i));

  const getDeliveriesForSlot = (date, zone, timeSlot) => {
    return deliveries.filter(d => {
      const deliveryDate = d.scheduled_date ? new Date(d.scheduled_date) : null;
      return deliveryDate && 
             isSameDay(deliveryDate, date) && 
             d.delivery_zone === zone && 
             d.scheduled_time_slot === timeSlot;
    });
  };

  const getStatusColor = (status) => {
    switch (status) {
      case 'completed': return 'bg-emerald-100 border-emerald-300';
      case 'in_transit': return 'bg-blue-100 border-blue-300';
      case 'loading': return 'bg-amber-100 border-amber-300';
      case 'scheduled': return 'bg-slate-100 border-slate-300';
      default: return 'bg-slate-100 border-slate-300';
    }
  };

  // Week stats
  const weekDeliveries = deliveries.filter(d => {
    const deliveryDate = d.scheduled_date ? new Date(d.scheduled_date) : null;
    return deliveryDate && deliveryDate >= currentWeek && deliveryDate < addWeeks(currentWeek, 1);
  });

  const totalDeliveries = weekDeliveries.length;
  const totalStops = weekDeliveries.reduce((sum, d) => sum + (d.stops?.length || 0), 0);
  const completedDeliveries = weekDeliveries.filter(d => d.status === 'completed').length;

  return (
    <div className="space-y-6">
      {/* Header */}
      <div className="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
        <div>
          <h1 className="text-2xl font-bold text-slate-900">Delivery Schedule</h1>
          <p className="text-slate-500">Weekly delivery calendar by zone and time slot</p>
        </div>
        <div className="flex items-center gap-2">
          <Button variant="outline" size="icon" onClick={() => setCurrentWeek(subWeeks(currentWeek, 1))}>
            <ChevronLeft className="w-4 h-4" />
          </Button>
          <Button 
            variant="outline" 
            className="min-w-[200px]"
            onClick={() => setCurrentWeek(startOfWeek(new Date(), { weekStartsOn: 1 }))}
          >
            <CalendarIcon className="w-4 h-4 mr-2" />
            {format(currentWeek, 'MMM dd')} - {format(addDays(currentWeek, 6), 'MMM dd, yyyy')}
          </Button>
          <Button variant="outline" size="icon" onClick={() => setCurrentWeek(addWeeks(currentWeek, 1))}>
            <ChevronRight className="w-4 h-4" />
          </Button>
        </div>
      </div>

      {/* Week Summary */}
      <div className="grid grid-cols-2 md:grid-cols-3 gap-4">
        <Card>
          <CardContent className="pt-6">
            <div className="flex items-center gap-3">
              <div className="w-10 h-10 rounded-lg bg-blue-100 flex items-center justify-center">
                <Truck className="w-5 h-5 text-blue-600" />
              </div>
              <div>
                <p className="text-sm text-slate-500">Total Deliveries</p>
                <p className="text-xl font-bold text-slate-900">{totalDeliveries}</p>
              </div>
            </div>
          </CardContent>
        </Card>
        <Card>
          <CardContent className="pt-6">
            <div className="flex items-center gap-3">
              <div className="w-10 h-10 rounded-lg bg-purple-100 flex items-center justify-center">
                <MapPin className="w-5 h-5 text-purple-600" />
              </div>
              <div>
                <p className="text-sm text-slate-500">Total Stops</p>
                <p className="text-xl font-bold text-slate-900">{totalStops}</p>
              </div>
            </div>
          </CardContent>
        </Card>
        <Card>
          <CardContent className="pt-6">
            <div className="flex items-center gap-3">
              <div className="w-10 h-10 rounded-lg bg-emerald-100 flex items-center justify-center">
                <Truck className="w-5 h-5 text-emerald-600" />
              </div>
              <div>
                <p className="text-sm text-slate-500">Completed</p>
                <p className="text-xl font-bold text-slate-900">{completedDeliveries}</p>
              </div>
            </div>
          </CardContent>
        </Card>
      </div>

      {/* Weekly View by Day */}
      <div className="grid grid-cols-1 md:grid-cols-7 gap-4">
        {weekDays.map((day) => {
          const dayDeliveries = deliveries.filter(d => {
            const deliveryDate = d.scheduled_date ? new Date(d.scheduled_date) : null;
            return deliveryDate && isSameDay(deliveryDate, day);
          });

          return (
            <Card 
              key={day.toISOString()} 
              className={cn(
                "overflow-hidden",
                isSameDay(day, new Date()) && "ring-2 ring-emerald-500"
              )}
            >
              <div className={cn(
                "p-3 text-center border-b",
                isSameDay(day, new Date()) ? "bg-emerald-50" : "bg-slate-50"
              )}>
                <p className="text-xs text-slate-500">{format(day, 'EEE')}</p>
                <p className={cn(
                  "text-lg font-semibold",
                  isSameDay(day, new Date()) ? "text-emerald-600" : "text-slate-900"
                )}>
                  {format(day, 'd')}
                </p>
              </div>
              <CardContent className="p-2 space-y-2">
                {dayDeliveries.length === 0 ? (
                  <p className="text-xs text-slate-400 text-center py-4">No deliveries</p>
                ) : (
                  dayDeliveries.map((delivery) => (
                    <div
                      key={delivery.id}
                      className={cn(
                        "p-2 rounded-lg border text-xs",
                        getStatusColor(delivery.status)
                      )}
                    >
                      <div className="flex items-center gap-1 mb-1">
                        <Truck className="w-3 h-3" />
                        <span className="font-medium">{delivery.delivery_number}</span>
                      </div>
                      <div className="flex items-center gap-1 text-[10px] opacity-75">
                        <MapPin className="w-3 h-3" />
                        <span className="capitalize">{delivery.delivery_zone?.replace(/_/g, ' ')}</span>
                      </div>
                      <div className="flex items-center gap-1 text-[10px] opacity-75">
                        <Clock className="w-3 h-3" />
                        <span className="capitalize">{delivery.scheduled_time_slot}</span>
                      </div>
                      <div className="mt-1 text-[10px]">
                        {delivery.stops?.length || 0} stops • {delivery.driver || 'Unassigned'}
                      </div>
                    </div>
                  ))
                )}
              </CardContent>
            </Card>
          );
        })}
      </div>

      {/* Zone Overview */}
      <Card>
        <CardContent className="p-0">
          <div className="grid grid-cols-5 border-b">
            <div className="p-3 bg-slate-50 border-r font-medium text-sm">Zone</div>
            {ZONES.map(zone => (
              <div key={zone} className="p-3 bg-slate-50 border-r last:border-r-0 text-center">
                <span className="text-sm font-medium capitalize">{zone.replace(/_/g, ' ')}</span>
              </div>
            ))}
          </div>
          {TIME_SLOTS.map(slot => (
            <div key={slot} className="grid grid-cols-5 border-b last:border-b-0">
              <div className="p-3 bg-slate-50 border-r">
                <div className="flex items-center gap-2">
                  <Clock className="w-4 h-4 text-slate-400" />
                  <span className="text-sm capitalize">{slot}</span>
                </div>
              </div>
              {ZONES.map(zone => {
                const count = weekDeliveries.filter(d => 
                  d.delivery_zone === zone && d.scheduled_time_slot === slot
                ).length;
                return (
                  <div key={`${slot}-${zone}`} className="p-3 border-r last:border-r-0 text-center">
                    {count > 0 ? (
                      <span className="inline-flex items-center justify-center w-8 h-8 rounded-full bg-blue-100 text-blue-700 font-medium text-sm">
                        {count}
                      </span>
                    ) : (
                      <span className="text-slate-300">-</span>
                    )}
                  </div>
                );
              })}
            </div>
          ))}
        </CardContent>
      </Card>

      {/* Legend */}
      <div className="flex flex-wrap gap-4 text-sm">
        <div className="flex items-center gap-2">
          <div className="w-4 h-4 rounded bg-slate-100 border border-slate-300" />
          <span className="text-slate-600">Scheduled</span>
        </div>
        <div className="flex items-center gap-2">
          <div className="w-4 h-4 rounded bg-amber-100 border border-amber-300" />
          <span className="text-slate-600">Loading</span>
        </div>
        <div className="flex items-center gap-2">
          <div className="w-4 h-4 rounded bg-blue-100 border border-blue-300" />
          <span className="text-slate-600">In Transit</span>
        </div>
        <div className="flex items-center gap-2">
          <div className="w-4 h-4 rounded bg-emerald-100 border border-emerald-300" />
          <span className="text-slate-600">Completed</span>
        </div>
      </div>
    </div>
  );
}

//PAGES - Inventory Report****

import React from 'react';
import { base44 } from '@/api/base44Client';
import { useQuery } from '@tanstack/react-query';
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import StatCard from '../components/shared/StatCard';
import DataTable from '../components/shared/DataTable';
import { usePermissions } from '../components/shared/PermissionGuard';
import { 
  Package, 
  AlertTriangle,
  DollarSign,
  Download,
  TrendingDown,
  TrendingUp
} from 'lucide-react';
import { Badge } from "@/components/ui/badge";
import { 
  BarChart, 
  Bar, 
  XAxis, 
  YAxis, 
  CartesianGrid, 
  Tooltip, 
  ResponsiveContainer,
  PieChart,
  Pie,
  Cell,
  Legend
} from 'recharts';

const COLORS = ['#10b981', '#3b82f6', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899'];

export default function InventoryReport() {
  const permissions = usePermissions();
  const { data: materials = [], isLoading: loadingMaterials } = useQuery({
    queryKey: ['rawMaterials'],
    queryFn: () => base44.entities.RawMaterial.list(),
  });

  const { data: products = [], isLoading: loadingProducts } = useQuery({
    queryKey: ['products'],
    queryFn: () => base44.entities.Product.list(),
  });

  const { data: transactions = [], isLoading: loadingTx } = useQuery({
    queryKey: ['inventoryTransactions'],
    queryFn: () => base44.entities.InventoryTransaction.list('-created_date', 100),
  });

  const isLoading = loadingMaterials || loadingProducts || loadingTx;

  // Raw Materials Stats
  const totalMaterials = materials.length;
  const lowStockMaterials = materials.filter(m => (m.current_stock || 0) <= (m.minimum_stock || 0)).length;
  const materialsValue = materials.reduce((sum, m) => sum + ((m.current_stock || 0) * (m.unit_cost || 0)), 0);

  // Products Stats
  const totalProducts = products.length;
  const lowStockProducts = products.filter(p => (p.current_stock || 0) <= (p.minimum_stock || 0)).length;
  const productsCostValue = products.reduce((sum, p) => sum + ((p.current_stock || 0) * (p.cost_price || 0)), 0);
  const productsRetailValue = products.reduce((sum, p) => sum + ((p.current_stock || 0) * (p.unit_price || 0)), 0);

  // Materials by category
  const materialsByCategory = materials.reduce((acc, m) => {
    const cat = m.category || 'other';
    if (!acc[cat]) acc[cat] = { count: 0, value: 0 };
    acc[cat].count += 1;
    acc[cat].value += (m.current_stock || 0) * (m.unit_cost || 0);
    return acc;
  }, {});

  const categoryPieData = Object.entries(materialsByCategory).map(([category, data]) => ({
    name: category.replace(/_/g, ' '),
    value: data.value
  }));

  // Products by category
  const productsByCategory = products.reduce((acc, p) => {
    const cat = p.category || 'other';
    if (!acc[cat]) acc[cat] = { count: 0, value: 0 };
    acc[cat].count += 1;
    acc[cat].value += (p.current_stock || 0) * (p.unit_price || 0);
    return acc;
  }, {});

  const productCategoryData = Object.entries(productsByCategory).map(([category, data]) => ({
    category: category.charAt(0).toUpperCase() + category.slice(1),
    value: data.value
  }));

  // Low stock items
  const lowStockItems = [
    ...materials.filter(m => (m.current_stock || 0) <= (m.minimum_stock || 0)).map(m => ({
      ...m,
      type: 'Raw Material',
      stockLevel: ((m.current_stock || 0) / (m.minimum_stock || 1) * 100).toFixed(0)
    })),
    ...products.filter(p => (p.current_stock || 0) <= (p.minimum_stock || 0)).map(p => ({
      ...p,
      type: 'Product',
      stockLevel: ((p.current_stock || 0) / (p.minimum_stock || 1) * 100).toFixed(0)
    }))
  ].slice(0, 10);

  // Recent transactions
  const recentTransactions = transactions.slice(0, 10);

  const lowStockColumns = [
    {
      header: 'Item',
      cell: (row) => (
        <div>
          <p className="font-medium">{row.name}</p>
          <p className="text-sm text-slate-500">{row.sku}</p>
        </div>
      )
    },
    {
      header: 'Type',
      cell: (row) => (
        <Badge variant="outline">{row.type}</Badge>
      )
    },
    {
      header: 'Current',
      cell: (row) => (
        <span className="text-red-600 font-medium">
          {row.current_stock} {row.unit}
        </span>
      )
    },
    {
      header: 'Minimum',
      cell: (row) => `${row.minimum_stock} ${row.unit}`
    },
    {
      header: 'Stock Level',
      cell: (row) => (
        <div className="flex items-center gap-2">
          <div className="w-16 h-2 bg-slate-200 rounded-full overflow-hidden">
            <div 
              className="h-full bg-red-500 rounded-full"
              style={{ width: `${Math.min(row.stockLevel, 100)}%` }}
            />
          </div>
          <span className="text-sm text-red-600">{row.stockLevel}%</span>
        </div>
      )
    }
  ];

  return (
    <div className="space-y-6">
      {/* Header */}
      <div className="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
        <div>
          <h1 className="text-2xl font-bold text-slate-900">Inventory Report</h1>
          <p className="text-slate-500">Overview of all inventory levels and values</p>
        </div>
        {permissions.canExport && (
          <Button variant="outline">
            <Download className="w-4 h-4 mr-2" />
            Export Report
          </Button>
        )}
      </div>

      {/* Stats */}
      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
        <StatCard
          title="Raw Materials Value"
          value={`₱${materialsValue.toLocaleString()}`}
          icon={Package}
          iconColor="bg-blue-100 text-blue-600"
          loading={isLoading}
        />
        <StatCard
          title="Products Cost Value"
          value={`₱${productsCostValue.toLocaleString()}`}
          icon={DollarSign}
          iconColor="bg-amber-100 text-amber-600"
          loading={isLoading}
        />
        <StatCard
          title="Products Retail Value"
          value={`₱${productsRetailValue.toLocaleString()}`}
          icon={TrendingUp}
          iconColor="bg-emerald-100 text-emerald-600"
          loading={isLoading}
        />
        <StatCard
          title="Low Stock Items"
          value={lowStockMaterials + lowStockProducts}
          icon={AlertTriangle}
          iconColor="bg-red-100 text-red-600"
          loading={isLoading}
        />
      </div>

      {/* Charts */}
      <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
        {/* Materials by Category */}
        <Card>
          <CardHeader>
            <CardTitle>Raw Materials by Category</CardTitle>
          </CardHeader>
          <CardContent>
            <div className="h-[300px]">
              {categoryPieData.length > 0 ? (
                <ResponsiveContainer width="100%" height="100%">
                  <PieChart>
                    <Pie
                      data={categoryPieData}
                      cx="50%"
                      cy="50%"
                      innerRadius={60}
                      outerRadius={100}
                      paddingAngle={5}
                      dataKey="value"
                      label={({ name, percent }) => `${name} ${(percent * 100).toFixed(0)}%`}
                    >
                      {categoryPieData.map((_, index) => (
                        <Cell key={`cell-${index}`} fill={COLORS[index % COLORS.length]} />
                      ))}
                    </Pie>
                    <Tooltip formatter={(value) => `₱${value.toLocaleString()}`} />
                  </PieChart>
                </ResponsiveContainer>
              ) : (
                <div className="h-full flex items-center justify-center text-slate-500">
                  No data available
                </div>
              )}
            </div>
          </CardContent>
        </Card>

        {/* Products by Category */}
        <Card>
          <CardHeader>
            <CardTitle>Products Value by Category</CardTitle>
          </CardHeader>
          <CardContent>
            <div className="h-[300px]">
              {productCategoryData.length > 0 ? (
                <ResponsiveContainer width="100%" height="100%">
                  <BarChart data={productCategoryData}>
                    <CartesianGrid strokeDasharray="3 3" stroke="#e2e8f0" />
                    <XAxis dataKey="category" stroke="#64748b" fontSize={11} />
                    <YAxis stroke="#64748b" fontSize={12} />
                    <Tooltip formatter={(value) => `₱${value.toLocaleString()}`} />
                    <Bar dataKey="value" fill="#10b981" radius={[4, 4, 0, 0]} />
                  </BarChart>
                </ResponsiveContainer>
              ) : (
                <div className="h-full flex items-center justify-center text-slate-500">
                  No data available
                </div>
              )}
            </div>
          </CardContent>
        </Card>
      </div>

      {/* Summary Cards */}
      <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
        <Card>
          <CardHeader>
            <CardTitle>Raw Materials Summary</CardTitle>
          </CardHeader>
          <CardContent>
            <div className="space-y-4">
              <div className="flex justify-between items-center p-3 bg-slate-50 rounded-lg">
                <span className="text-slate-600">Total SKUs</span>
                <span className="font-semibold">{totalMaterials}</span>
              </div>
              <div className="flex justify-between items-center p-3 bg-red-50 rounded-lg">
                <span className="text-slate-600">Low Stock Items</span>
                <span className="font-semibold text-red-600">{lowStockMaterials}</span>
              </div>
              <div className="flex justify-between items-center p-3 bg-blue-50 rounded-lg">
                <span className="text-slate-600">Total Value</span>
                <span className="font-semibold text-blue-600">₱{materialsValue.toLocaleString()}</span>
              </div>
            </div>
          </CardContent>
        </Card>

        <Card>
          <CardHeader>
            <CardTitle>Finished Products Summary</CardTitle>
          </CardHeader>
          <CardContent>
            <div className="space-y-4">
              <div className="flex justify-between items-center p-3 bg-slate-50 rounded-lg">
                <span className="text-slate-600">Total SKUs</span>
                <span className="font-semibold">{totalProducts}</span>
              </div>
              <div className="flex justify-between items-center p-3 bg-red-50 rounded-lg">
                <span className="text-slate-600">Low Stock Items</span>
                <span className="font-semibold text-red-600">{lowStockProducts}</span>
              </div>
              <div className="flex justify-between items-center p-3 bg-emerald-50 rounded-lg">
                <span className="text-slate-600">Potential Revenue</span>
                <span className="font-semibold text-emerald-600">₱{productsRetailValue.toLocaleString()}</span>
              </div>
            </div>
          </CardContent>
        </Card>
      </div>

      {/* Low Stock Alert */}
      {lowStockItems.length > 0 && (
        <Card>
          <CardHeader>
            <CardTitle className="flex items-center gap-2 text-red-600">
              <AlertTriangle className="w-5 h-5" />
              Low Stock Alert
            </CardTitle>
          </CardHeader>
          <CardContent>
            <DataTable
              columns={lowStockColumns}
              data={lowStockItems}
              isLoading={isLoading}
              emptyMessage="All items are well stocked"
            />
          </CardContent>
        </Card>
      )}
    </div>
  );
}

// PAGES - inventory transactions*****
import React, { useState } from 'react';
import { base44 } from '@/api/base44Client';
import { useQuery } from '@tanstack/react-query';
import PageHeader from '../components/shared/PageHeader';
import DataTable from '../components/shared/DataTable';
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Badge } from "@/components/ui/badge";
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from "@/components/ui/select";
import { 
  Search, 
  ArrowUpCircle, 
  ArrowDownCircle,
  RefreshCw,
  Trash2,
  RotateCcw
} from 'lucide-react';
import { format } from 'date-fns';

const TRANSACTION_TYPES = [
  { value: 'receipt', label: 'Receipt', icon: ArrowDownCircle, color: 'text-green-600' },
  { value: 'issue', label: 'Issue', icon: ArrowUpCircle, color: 'text-red-600' },
  { value: 'adjustment', label: 'Adjustment', icon: RefreshCw, color: 'text-blue-600' },
  { value: 'transfer', label: 'Transfer', icon: RefreshCw, color: 'text-purple-600' },
  { value: 'waste', label: 'Waste', icon: Trash2, color: 'text-orange-600' },
  { value: 'return', label: 'Return', icon: RotateCcw, color: 'text-cyan-600' }
];

export default function InventoryTransactions() {
  const [search, setSearch] = useState('');
  const [typeFilter, setTypeFilter] = useState('all');
  const [itemTypeFilter, setItemTypeFilter] = useState('all');

  const { data: transactions = [], isLoading } = useQuery({
    queryKey: ['inventoryTransactions'],
    queryFn: () => base44.entities.InventoryTransaction.list('-created_date', 200),
  });

  const filteredTransactions = transactions.filter(t => {
    const matchesSearch = t.item_name?.toLowerCase().includes(search.toLowerCase()) ||
      t.reference_number?.toLowerCase().includes(search.toLowerCase());
    const matchesType = typeFilter === 'all' || t.transaction_type === typeFilter;
    const matchesItemType = itemTypeFilter === 'all' || t.item_type === itemTypeFilter;
    return matchesSearch && matchesType && matchesItemType;
  });

  const getTypeConfig = (type) => TRANSACTION_TYPES.find(t => t.value === type) || TRANSACTION_TYPES[0];

  const columns = [
    {
      header: 'Transaction',
      cell: (row) => {
        const config = getTypeConfig(row.transaction_type);
        const Icon = config.icon;
        return (
          <div className="flex items-center gap-3">
            <div className={`w-10 h-10 rounded-lg bg-slate-100 flex items-center justify-center`}>
              <Icon className={`w-5 h-5 ${config.color}`} />
            </div>
            <div>
              <p className="font-medium text-slate-900 capitalize">{row.transaction_type}</p>
              <p className="text-sm text-slate-500">
                {row.created_date ? format(new Date(row.created_date), 'MMM dd, HH:mm') : '-'}
              </p>
            </div>
          </div>
        );
      }
    },
    {
      header: 'Item',
      cell: (row) => (
        <div>
          <p className="font-medium text-slate-900">{row.item_name}</p>
          <Badge variant="outline" className="capitalize text-xs">
            {row.item_type?.replace(/_/g, ' ')}
          </Badge>
        </div>
      )
    },
    {
      header: 'Quantity',
      cell: (row) => {
        const isIncoming = ['receipt', 'return'].includes(row.transaction_type);
        return (
          <span className={`font-semibold ${isIncoming ? 'text-green-600' : 'text-red-600'}`}>
            {isIncoming ? '+' : '-'}{Math.abs(row.quantity)} {row.unit}
          </span>
        );
      }
    },
    {
      header: 'Stock Change',
      cell: (row) => (
        <div className="text-sm">
          <span className="text-slate-500">{row.before_quantity || 0}</span>
          <span className="mx-2">→</span>
          <span className="font-medium text-slate-900">{row.after_quantity || 0}</span>
        </div>
      )
    },
    {
      header: 'Reference',
      cell: (row) => (
        <div>
          <p className="text-slate-600 capitalize text-sm">{row.reference_type?.replace(/_/g, ' ')}</p>
          {row.reference_number && (
            <p className="text-xs text-slate-500">{row.reference_number}</p>
          )}
        </div>
      )
    },
    {
      header: 'Value',
      cell: (row) => (
        <span className="font-medium text-slate-900">
          {row.total_value ? `₱${row.total_value.toFixed(2)}` : '-'}
        </span>
      )
    },
    {
      header: 'Batch',
      cell: (row) => (
        <span className="text-slate-600 text-sm">{row.batch_number || '-'}</span>
      )
    }
  ];

  return (
    <div>
      <PageHeader
        title="Inventory Transactions"
        description="Track all inventory movements"
      >
        <Select value={typeFilter} onValueChange={setTypeFilter}>
          <SelectTrigger className="w-36">
            <SelectValue placeholder="Type" />
          </SelectTrigger>
          <SelectContent>
            <SelectItem value="all">All Types</SelectItem>
            {TRANSACTION_TYPES.map(t => (
              <SelectItem key={t.value} value={t.value}>{t.label}</SelectItem>
            ))}
          </SelectContent>
        </Select>
        <Select value={itemTypeFilter} onValueChange={setItemTypeFilter}>
          <SelectTrigger className="w-40">
            <SelectValue placeholder="Item Type" />
          </SelectTrigger>
          <SelectContent>
            <SelectItem value="all">All Items</SelectItem>
            <SelectItem value="raw_material">Raw Materials</SelectItem>
            <SelectItem value="finished_product">Finished Products</SelectItem>
          </SelectContent>
        </Select>
        <div className="relative">
          <Search className="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400" />
          <Input
            placeholder="Search transactions..."
            value={search}
            onChange={(e) => setSearch(e.target.value)}
            className="pl-10 w-64"
          />
        </div>
      </PageHeader>

      <DataTable
        columns={columns}
        data={filteredTransactions}
        isLoading={isLoading}
        emptyMessage="No transactions found."
      />
    </div>
  );
}

//PAGES -- New Sales Order****
import React, { useState } from 'react';
import { base44 } from '@/api/base44Client';
import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';
import { useNavigate } from 'react-router-dom';
import { createPageUrl } from '../utils';
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Textarea } from "@/components/ui/textarea";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from "@/components/ui/select";
import { Plus, X, ArrowLeft, ShoppingCart } from 'lucide-react';
import { format } from 'date-fns';
import { toast } from "sonner";

export default function NewSalesOrder() {
  const navigate = useNavigate();
  const queryClient = useQueryClient();
  
  const [formData, setFormData] = useState({
    customer_id: '',
    customer_name: '',
    order_type: 'offline',
    order_date: format(new Date(), 'yyyy-MM-dd'),
    requested_delivery_date: '',
    items: [],
    discount_amount: 0,
    tax_amount: 0,
    delivery_fee: 0,
    shipping_address: '',
    delivery_zone: '',
    payment_method: 'credit',
    payment_proof_url: '',
    notes: ''
  });

  const { data: customers = [] } = useQuery({
    queryKey: ['customers'],
    queryFn: () => base44.entities.Customer.list(),
  });

  const { data: products = [] } = useQuery({
    queryKey: ['products'],
    queryFn: () => base44.entities.Product.list(),
  });

  const createMutation = useMutation({
    mutationFn: (data) => base44.entities.SalesOrder.create(data),
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['salesOrders'] });
      toast.success('Order created successfully');
      navigate(createPageUrl('SalesOrders'));
    },
  });

  const generateOrderNumber = () => {
    const date = new Date();
    const prefix = 'SO';
    const year = date.getFullYear().toString().slice(-2);
    const month = (date.getMonth() + 1).toString().padStart(2, '0');
    const random = Math.floor(Math.random() * 10000).toString().padStart(4, '0');
    return `${prefix}${year}${month}-${random}`;
  };

  const handleCustomerChange = (customerId) => {
    const customer = customers.find(c => c.id === customerId);
    setFormData({
      ...formData,
      customer_id: customerId,
      customer_name: customer?.name || '',
      shipping_address: customer?.shipping_address || customer?.billing_address || '',
      delivery_zone: customer?.delivery_zone || ''
    });
  };

  const addItem = () => {
    setFormData({
      ...formData,
      items: [...formData.items, { 
        product_id: '', 
        product_name: '', 
        quantity: 1, 
        unit: 'pcs', 
        unit_price: 0, 
        discount: 0,
        total: 0 
      }]
    });
  };

  const updateItem = (index, field, value) => {
    const newItems = [...formData.items];
    if (field === 'product_id') {
      const product = products.find(p => p.id === value);
      newItems[index] = {
        ...newItems[index],
        product_id: value,
        product_name: product?.name || '',
        unit: product?.unit || 'pcs',
        unit_price: product?.unit_price || 0
      };
    } else {
      newItems[index] = { ...newItems[index], [field]: value };
    }
    // Calculate total
    const qty = newItems[index].quantity || 0;
    const price = newItems[index].unit_price || 0;
    const discount = newItems[index].discount || 0;
    newItems[index].total = qty * price * (1 - discount / 100);
    setFormData({ ...formData, items: newItems });
  };

  const removeItem = (index) => {
    setFormData({
      ...formData,
      items: formData.items.filter((_, i) => i !== index)
    });
  };

  const subtotal = formData.items.reduce((sum, item) => sum + (item.total || 0), 0);
  const total = subtotal - (formData.discount_amount || 0) + (formData.tax_amount || 0) + (formData.delivery_fee || 0);

  const handleSubmit = async (e) => {
    e.preventDefault();
    
    if (!formData.customer_id) {
      toast.error('Please select a customer');
      return;
    }
    
    if (formData.items.length === 0) {
      toast.error('Please add at least one item');
      return;
    }

    const data = {
      ...formData,
      order_number: generateOrderNumber(),
      subtotal,
      total_amount: total,
      status: 'draft',
      payment_status: 'pending'
    };

    createMutation.mutate(data);

    // Send email to admins if payment proof is attached
    if (formData.payment_proof_url) {
      try {
        const adminUsers = await base44.entities.User.filter({ role: 'admin' });
        const emailBody = `
          <h2>New Sales Order with Payment Proof</h2>
          <p><strong>Order Number:</strong> ${data.order_number}</p>
          <p><strong>Customer:</strong> ${formData.customer_name}</p>
          <p><strong>Total Amount:</strong> ₱${total.toLocaleString()}</p>
          <p><strong>Payment Method:</strong> ${formData.payment_method || 'N/A'}</p>
          <p><strong>Order Date:</strong> ${formData.order_date}</p>
          <br/>
          <p><strong>Payment Proof:</strong></p>
          <img src="${formData.payment_proof_url}" alt="Payment Proof" style="max-width: 400px; border: 1px solid #ddd; border-radius: 8px;"/>
        `;
        
        for (const admin of adminUsers) {
          await base44.integrations.Core.SendEmail({
            to: admin.email,
            subject: `Payment Proof Submitted - Order ${data.order_number}`,
            body: emailBody
          });
        }
      } catch (error) {
        console.error('Failed to send admin emails:', error);
      }
    }
  };

  return (
    <div className="max-w-4xl mx-auto">
      <div className="flex items-center gap-4 mb-8">
        <Button 
          variant="ghost" 
          size="icon"
          onClick={() => navigate(createPageUrl('SalesOrders'))}
        >
          <ArrowLeft className="w-5 h-5" />
        </Button>
        <div>
          <h1 className="text-2xl font-bold text-slate-900">New Sales Order</h1>
          <p className="text-slate-500">Create a new customer order</p>
        </div>
      </div>

      <form onSubmit={handleSubmit} className="space-y-6">
        {/* Customer & Order Info */}
        <Card>
          <CardHeader>
            <CardTitle className="text-lg">Order Information</CardTitle>
          </CardHeader>
          <CardContent className="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <Label>Customer *</Label>
              <Select
                value={formData.customer_id}
                onValueChange={handleCustomerChange}
              >
                <SelectTrigger>
                  <SelectValue placeholder="Select customer" />
                </SelectTrigger>
                <SelectContent>
                  {customers.filter(c => c.status === 'active').map(c => (
                    <SelectItem key={c.id} value={c.id}>{c.name}</SelectItem>
                  ))}
                </SelectContent>
              </Select>
            </div>
            <div>
              <Label>Order Type</Label>
              <Select
                value={formData.order_type}
                onValueChange={(value) => setFormData({ ...formData, order_type: value })}
              >
                <SelectTrigger>
                  <SelectValue />
                </SelectTrigger>
                <SelectContent>
                  <SelectItem value="offline">Offline</SelectItem>
                  <SelectItem value="online">Online</SelectItem>
                  <SelectItem value="phone">Phone</SelectItem>
                  <SelectItem value="recurring">Recurring</SelectItem>
                </SelectContent>
              </Select>
            </div>
            <div>
              <Label>Order Date</Label>
              <Input
                type="date"
                value={formData.order_date}
                onChange={(e) => setFormData({ ...formData, order_date: e.target.value })}
              />
            </div>
            <div>
              <Label>Requested Delivery Date</Label>
              <Input
                type="date"
                value={formData.requested_delivery_date}
                onChange={(e) => setFormData({ ...formData, requested_delivery_date: e.target.value })}
              />
            </div>
            <div className="md:col-span-2">
              <Label>Shipping Address</Label>
              <Textarea
                value={formData.shipping_address}
                onChange={(e) => setFormData({ ...formData, shipping_address: e.target.value })}
                rows={2}
              />
            </div>
          </CardContent>
        </Card>

        {/* Order Items */}
        <Card>
          <CardHeader className="flex flex-row items-center justify-between">
            <CardTitle className="text-lg">Order Items</CardTitle>
            <Button type="button" variant="outline" size="sm" onClick={addItem}>
              <Plus className="w-4 h-4 mr-1" />
              Add Item
            </Button>
          </CardHeader>
          <CardContent>
            {formData.items.length === 0 ? (
              <div className="text-center py-8 text-slate-500 border-2 border-dashed rounded-lg">
                <ShoppingCart className="w-8 h-8 mx-auto mb-2 text-slate-400" />
                <p>No items added yet</p>
                <p className="text-sm">Click "Add Item" to start</p>
              </div>
            ) : (
              <div className="space-y-3">
                {formData.items.map((item, index) => (
                  <Card key={index} className="p-4 bg-slate-50">
                    <div className="flex flex-wrap items-center gap-3">
                      <div className="flex-1 min-w-[200px]">
                        <Label className="text-xs">Product</Label>
                        <Select
                          value={item.product_id}
                          onValueChange={(value) => updateItem(index, 'product_id', value)}
                        >
                          <SelectTrigger>
                            <SelectValue placeholder="Select product" />
                          </SelectTrigger>
                          <SelectContent>
                            {products.filter(p => p.status === 'active').map(p => (
                              <SelectItem key={p.id} value={p.id}>
                                {p.name} (Stock: {p.current_stock || 0})
                              </SelectItem>
                            ))}
                          </SelectContent>
                        </Select>
                      </div>
                      <div className="w-20">
                        <Label className="text-xs">Qty</Label>
                        <Input
                          type="number"
                          min="1"
                          value={item.quantity}
                          onChange={(e) => updateItem(index, 'quantity', parseInt(e.target.value) || 0)}
                        />
                      </div>
                      <div className="w-24">
                        <Label className="text-xs">Unit Price</Label>
                        <Input
                          type="number"
                          step="0.01"
                          value={item.unit_price}
                          onChange={(e) => updateItem(index, 'unit_price', parseFloat(e.target.value) || 0)}
                        />
                      </div>
                      <div className="w-20">
                        <Label className="text-xs">Disc %</Label>
                        <Input
                          type="number"
                          min="0"
                          max="100"
                          value={item.discount}
                          onChange={(e) => updateItem(index, 'discount', parseFloat(e.target.value) || 0)}
                        />
                      </div>
                      <div className="w-24 text-right">
                        <Label className="text-xs">Total</Label>
                        <p className="font-semibold text-slate-900 mt-2">₱{(item.total || 0).toFixed(2)}</p>
                      </div>
                      <Button
                        type="button"
                        variant="ghost"
                        size="icon"
                        className="mt-5"
                        onClick={() => removeItem(index)}
                      >
                        <X className="w-4 h-4 text-red-500" />
                      </Button>
                    </div>
                  </Card>
                ))}
              </div>
            )}
          </CardContent>
        </Card>

        {/* Payment & Totals */}
        <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
          <Card>
            <CardHeader>
              <CardTitle className="text-lg">Payment Details</CardTitle>
            </CardHeader>
            <CardContent className="space-y-4">
              <div>
                <Label>Payment Method</Label>
                <Select
                  value={formData.payment_method}
                  onValueChange={(value) => setFormData({ ...formData, payment_method: value })}
                >
                  <SelectTrigger>
                    <SelectValue />
                  </SelectTrigger>
                  <SelectContent>
                    <SelectItem value="cash">Cash</SelectItem>
                    <SelectItem value="bank_transfer">Bank Transfer</SelectItem>
                    <SelectItem value="check">Check</SelectItem>
                    <SelectItem value="credit">Credit</SelectItem>
                    <SelectItem value="online">Online Payment</SelectItem>
                  </SelectContent>
                </Select>
              </div>
              <div>
                <Label>Payment Proof (Optional)</Label>
                {!formData.payment_proof_url ? (
                  <Input
                    type="file"
                    accept="image/*"
                    onChange={async (e) => {
                      const file = e.target.files?.[0];
                      if (file) {
                        const { file_url } = await base44.integrations.Core.UploadFile({ file });
                        setFormData({ ...formData, payment_proof_url: file_url });
                        toast.success('Payment proof uploaded');
                      }
                    }}
                  />
                ) : (
                  <div className="space-y-2">
                    <img 
                      src={formData.payment_proof_url} 
                      alt="Payment proof" 
                      className="w-full h-48 object-cover rounded-lg border"
                    />
                    <Button
                      type="button"
                      variant="outline"
                      size="sm"
                      className="w-full text-red-600 hover:text-red-700"
                      onClick={() => setFormData({ ...formData, payment_proof_url: '' })}
                    >
                      <X className="w-4 h-4 mr-2" />
                      Remove Attachment
                    </Button>
                  </div>
                )}
              </div>
              <div>
                <Label>Notes</Label>
                <Textarea
                  value={formData.notes}
                  onChange={(e) => setFormData({ ...formData, notes: e.target.value })}
                  rows={3}
                  placeholder="Order notes..."
                />
              </div>
            </CardContent>
          </Card>

          <Card>
            <CardHeader>
              <CardTitle className="text-lg">Order Summary</CardTitle>
            </CardHeader>
            <CardContent className="space-y-4">
              <div className="flex justify-between">
                <span className="text-slate-600">Subtotal</span>
                <span className="font-medium">₱{subtotal.toFixed(2)}</span>
              </div>
              <div className="flex justify-between items-center">
                <span className="text-slate-600">Discount</span>
                <Input
                  type="number"
                  step="0.01"
                  className="w-28 text-right"
                  value={formData.discount_amount}
                  onChange={(e) => setFormData({ ...formData, discount_amount: parseFloat(e.target.value) || 0 })}
                />
              </div>
              <div className="flex justify-between items-center">
                <span className="text-slate-600">Tax</span>
                <Input
                  type="number"
                  step="0.01"
                  className="w-28 text-right"
                  value={formData.tax_amount}
                  onChange={(e) => setFormData({ ...formData, tax_amount: parseFloat(e.target.value) || 0 })}
                />
              </div>
              <div className="flex justify-between items-center">
                <span className="text-slate-600">Delivery Fee</span>
                <Input
                  type="number"
                  step="0.01"
                  className="w-28 text-right"
                  value={formData.delivery_fee}
                  onChange={(e) => setFormData({ ...formData, delivery_fee: parseFloat(e.target.value) || 0 })}
                />
              </div>
              <div className="flex justify-between pt-4 border-t">
                <span className="font-bold text-lg">Total</span>
                <span className="font-bold text-xl text-emerald-600">₱{total.toFixed(2)}</span>
              </div>
            </CardContent>
          </Card>
        </div>

        {/* Actions */}
        <div className="flex justify-end gap-3">
          <Button 
            type="button" 
            variant="outline"
            onClick={() => navigate(createPageUrl('SalesOrders'))}
          >
            Cancel
          </Button>
          <Button 
            type="submit" 
            className="bg-emerald-600 hover:bg-emerald-700"
            disabled={createMutation.isPending}
          >
            Create Order
          </Button>
        </div>
      </form>
    </div>
  );
}

// PPRODUCTION BATCHES*****
import React, { useState } from 'react';
import { base44 } from '@/api/base44Client';
import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';
import PageHeader from '../components/shared/PageHeader';
import DataTable from '../components/shared/DataTable';
import StatusBadge from '../components/shared/StatusBadge';
import { usePermissions } from '../components/shared/PermissionGuard';
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Textarea } from "@/components/ui/textarea";
import { Card } from "@/components/ui/card";
import {
  Dialog,
  DialogContent,
  DialogHeader,
  DialogTitle,
} from "@/components/ui/dialog";
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from "@/components/ui/select";
import { 
  Search, 
  Factory, 
  MoreVertical, 
  Pencil, 
  Trash2, 
  Play,
  Pause,
  CheckCircle,
  Eye,
  ClipboardCheck
} from 'lucide-react';
import {
  DropdownMenu,
  DropdownMenuContent,
  DropdownMenuItem,
  DropdownMenuSeparator,
  DropdownMenuTrigger,
} from "@/components/ui/dropdown-menu";
import { format, addDays } from 'date-fns';
import { toast } from "sonner";

const PRODUCTION_LINES = [
  { value: 'line_1', label: 'Production Line 1' },
  { value: 'line_2', label: 'Production Line 2' },
  { value: 'line_3', label: 'Production Line 3' },
  { value: 'line_4', label: 'Production Line 4' }
];

export default function ProductionBatches() {
  const permissions = usePermissions();
  const [isOpen, setIsOpen] = useState(false);
  const [qcOpen, setQcOpen] = useState(false);
  const [editingBatch, setEditingBatch] = useState(null);
  const [qcBatch, setQcBatch] = useState(null);
  const [search, setSearch] = useState('');
  const [statusFilter, setStatusFilter] = useState('all');
  const [formData, setFormData] = useState({
    product_id: '',
    product_name: '',
    planned_quantity: 0,
    scheduled_date: format(new Date(), 'yyyy-MM-dd'),
    production_line: 'line_1',
    notes: ''
  });
  const [qcData, setQcData] = useState({
    passed: true,
    temperature: '',
    ph_level: '',
    visual_inspection: 'pass',
    notes: ''
  });

  const queryClient = useQueryClient();

  const { data: batches = [], isLoading } = useQuery({
    queryKey: ['productionBatches'],
    queryFn: () => base44.entities.ProductionBatch.list('-created_date'),
  });

  const { data: products = [] } = useQuery({
    queryKey: ['products'],
    queryFn: () => base44.entities.Product.list(),
  });

  const createMutation = useMutation({
    mutationFn: (data) => base44.entities.ProductionBatch.create(data),
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['productionBatches'] });
      toast.success('Production batch scheduled');
      handleClose();
    },
  });

  const updateMutation = useMutation({
    mutationFn: ({ id, data }) => base44.entities.ProductionBatch.update(id, data),
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['productionBatches'] });
      toast.success('Batch updated');
      handleClose();
      setQcOpen(false);
    },
  });

  const deleteMutation = useMutation({
    mutationFn: (id) => base44.entities.ProductionBatch.delete(id),
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['productionBatches'] });
      toast.success('Batch deleted');
    },
  });

  const generateBatchNumber = () => {
    const date = new Date();
    const prefix = 'BAT';
    const year = date.getFullYear().toString().slice(-2);
    const month = (date.getMonth() + 1).toString().padStart(2, '0');
    const day = date.getDate().toString().padStart(2, '0');
    const random = Math.floor(Math.random() * 1000).toString().padStart(3, '0');
    return `${prefix}${year}${month}${day}-${random}`;
  };

  const handleOpen = (batch = null) => {
    if (batch) {
      setEditingBatch(batch);
      setFormData({
        product_id: batch.product_id || '',
        product_name: batch.product_name || '',
        planned_quantity: batch.planned_quantity || 0,
        scheduled_date: batch.scheduled_date || format(new Date(), 'yyyy-MM-dd'),
        production_line: batch.production_line || 'line_1',
        notes: batch.notes || ''
      });
    } else {
      setEditingBatch(null);
      setFormData({
        product_id: '',
        product_name: '',
        planned_quantity: 0,
        scheduled_date: format(new Date(), 'yyyy-MM-dd'),
        production_line: 'line_1',
        notes: ''
      });
    }
    setIsOpen(true);
  };

  const handleClose = () => {
    setIsOpen(false);
    setEditingBatch(null);
  };

  const handleProductChange = (productId) => {
    const product = products.find(p => p.id === productId);
    setFormData({
      ...formData,
      product_id: productId,
      product_name: product?.name || '',
      planned_quantity: product?.batch_size || 100
    });
  };

  const handleSubmit = (e) => {
    e.preventDefault();
    const product = products.find(p => p.id === formData.product_id);
    const expiryDate = product?.shelf_life_days 
      ? format(addDays(new Date(formData.scheduled_date), product.shelf_life_days), 'yyyy-MM-dd')
      : null;

    const data = {
      ...formData,
      batch_number: editingBatch?.batch_number || generateBatchNumber(),
      status: 'scheduled',
      expiry_date: expiryDate
    };

    if (editingBatch) {
      updateMutation.mutate({ id: editingBatch.id, data });
    } else {
      createMutation.mutate(data);
    }
  };

  const handleStatusChange = async (batch, newStatus) => {
    const updates = { status: newStatus };
    if (newStatus === 'in_progress') {
      updates.start_time = new Date().toISOString();
    }
    if (newStatus === 'completed') {
      updates.end_time = new Date().toISOString();
      updates.actual_quantity = batch.planned_quantity; // Can be edited
    }
    await updateMutation.mutateAsync({ id: batch.id, data: updates });
  };

  const openQC = (batch) => {
    setQcBatch(batch);
    setQcData({
      passed: batch.quality_check?.passed ?? true,
      temperature: batch.quality_check?.temperature || '',
      ph_level: batch.quality_check?.ph_level || '',
      visual_inspection: batch.quality_check?.visual_inspection || 'pass',
      notes: batch.quality_check?.notes || ''
    });
    setQcOpen(true);
  };

  const handleQCSubmit = (e) => {
    e.preventDefault();
    const quality_check = {
      ...qcData,
      checked_date: new Date().toISOString()
    };
    updateMutation.mutate({ 
      id: qcBatch.id, 
      data: { 
        quality_check,
        status: qcData.passed ? 'completed' : 'on_hold'
      } 
    });
  };

  const filteredBatches = batches.filter(b => {
    const matchesSearch = b.batch_number?.toLowerCase().includes(search.toLowerCase()) ||
      b.product_name?.toLowerCase().includes(search.toLowerCase());
    const matchesStatus = statusFilter === 'all' || b.status === statusFilter;
    return matchesSearch && matchesStatus;
  });

  const columns = [
    {
      header: 'Batch',
      cell: (row) => (
        <div className="flex items-center gap-3">
          <div className={`w-10 h-10 rounded-lg flex items-center justify-center ${
            row.status === 'in_progress' ? 'bg-amber-100' : 
            row.status === 'completed' ? 'bg-emerald-100' : 'bg-blue-100'
          }`}>
            <Factory className={`w-5 h-5 ${
              row.status === 'in_progress' ? 'text-amber-600' : 
              row.status === 'completed' ? 'text-emerald-600' : 'text-blue-600'
            }`} />
          </div>
          <div>
            <p className="font-medium text-slate-900">{row.batch_number}</p>
            <p className="text-sm text-slate-500">{row.product_name}</p>
          </div>
        </div>
      )
    },
    {
      header: 'Schedule',
      cell: (row) => (
        <div>
          <p className="text-slate-900">{row.scheduled_date ? format(new Date(row.scheduled_date), 'MMM dd, yyyy') : '-'}</p>
          <p className="text-xs text-slate-500 capitalize">{row.production_line?.replace(/_/g, ' ')}</p>
        </div>
      )
    },
    {
      header: 'Quantity',
      cell: (row) => (
        <div>
          <p className="font-medium text-slate-900">{row.actual_quantity || row.planned_quantity} units</p>
          {row.actual_quantity && row.actual_quantity !== row.planned_quantity && (
            <p className="text-xs text-slate-500">Planned: {row.planned_quantity}</p>
          )}
        </div>
      )
    },
    {
      header: 'Expiry',
      cell: (row) => (
        <span className="text-slate-600">
          {row.expiry_date ? format(new Date(row.expiry_date), 'MMM dd, yyyy') : '-'}
        </span>
      )
    },
    {
      header: 'Status',
      cell: (row) => <StatusBadge status={row.status} />
    },
    {
      header: '',
      className: 'w-12',
      cell: (row) => (
        <DropdownMenu>
          <DropdownMenuTrigger asChild>
            <Button variant="ghost" size="icon">
              <MoreVertical className="w-4 h-4" />
            </Button>
          </DropdownMenuTrigger>
          <DropdownMenuContent align="end">
            <DropdownMenuItem onClick={() => handleOpen(row)}>
              <Pencil className="w-4 h-4 mr-2" />
              Edit
            </DropdownMenuItem>
            <DropdownMenuSeparator />
            {row.status === 'scheduled' && (
              <DropdownMenuItem onClick={() => handleStatusChange(row, 'in_progress')}>
                <Play className="w-4 h-4 mr-2 text-blue-600" />
                Start Production
              </DropdownMenuItem>
            )}
            {row.status === 'in_progress' && (
              <>
                <DropdownMenuItem onClick={() => handleStatusChange(row, 'on_hold')}>
                  <Pause className="w-4 h-4 mr-2 text-orange-600" />
                  Put on Hold
                </DropdownMenuItem>
                <DropdownMenuItem onClick={() => handleStatusChange(row, 'quality_check')}>
                  <ClipboardCheck className="w-4 h-4 mr-2 text-purple-600" />
                  Send to QC
                </DropdownMenuItem>
              </>
            )}
            {row.status === 'on_hold' && (
              <DropdownMenuItem onClick={() => handleStatusChange(row, 'in_progress')}>
                <Play className="w-4 h-4 mr-2 text-blue-600" />
                Resume
              </DropdownMenuItem>
            )}
            {row.status === 'quality_check' && (
              <DropdownMenuItem onClick={() => openQC(row)}>
                <ClipboardCheck className="w-4 h-4 mr-2 text-purple-600" />
                Record QC Results
              </DropdownMenuItem>
            )}
            <DropdownMenuSeparator />
            <DropdownMenuItem 
              onClick={() => deleteMutation.mutate(row.id)}
              className="text-red-600"
            >
              <Trash2 className="w-4 h-4 mr-2" />
              Delete
            </DropdownMenuItem>
          </DropdownMenuContent>
        </DropdownMenu>
      )
    }
  ];

  return (
    <div>
      <PageHeader
        title="Production Batches"
        description="Schedule and track production batches"
        action={permissions.canEdit ? () => handleOpen() : null}
        actionLabel="Schedule Batch"
      >
        <Select value={statusFilter} onValueChange={setStatusFilter}>
          <SelectTrigger className="w-40">
            <SelectValue placeholder="Status" />
          </SelectTrigger>
          <SelectContent>
            <SelectItem value="all">All Status</SelectItem>
            <SelectItem value="scheduled">Scheduled</SelectItem>
            <SelectItem value="in_progress">In Progress</SelectItem>
            <SelectItem value="quality_check">Quality Check</SelectItem>
            <SelectItem value="completed">Completed</SelectItem>
            <SelectItem value="on_hold">On Hold</SelectItem>
          </SelectContent>
        </Select>
        <div className="relative">
          <Search className="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400" />
          <Input
            placeholder="Search batches..."
            value={search}
            onChange={(e) => setSearch(e.target.value)}
            className="pl-10 w-64"
          />
        </div>
      </PageHeader>

      <DataTable
        columns={columns}
        data={filteredBatches}
        isLoading={isLoading}
        emptyMessage="No production batches found."
      />

      {/* Create/Edit Dialog */}
      <Dialog open={isOpen} onOpenChange={setIsOpen}>
        <DialogContent className="max-w-lg">
          <DialogHeader>
            <DialogTitle>
              {editingBatch ? 'Edit Batch' : 'Schedule Production Batch'}
            </DialogTitle>
          </DialogHeader>
          <form onSubmit={handleSubmit} className="space-y-4">
            <div>
              <Label>Product *</Label>
              <Select
                value={formData.product_id}
                onValueChange={handleProductChange}
              >
                <SelectTrigger>
                  <SelectValue placeholder="Select product" />
                </SelectTrigger>
                <SelectContent>
                  {products.filter(p => p.status === 'active').map(p => (
                    <SelectItem key={p.id} value={p.id}>{p.name}</SelectItem>
                  ))}
                </SelectContent>
              </Select>
            </div>
            <div className="grid grid-cols-2 gap-4">
              <div>
                <Label>Planned Quantity *</Label>
                <Input
                  type="number"
                  min="1"
                  value={formData.planned_quantity}
                  onChange={(e) => setFormData({ ...formData, planned_quantity: parseInt(e.target.value) || 0 })}
                  required
                />
              </div>
              <div>
                <Label>Scheduled Date *</Label>
                <Input
                  type="date"
                  value={formData.scheduled_date}
                  onChange={(e) => setFormData({ ...formData, scheduled_date: e.target.value })}
                  required
                />
              </div>
            </div>
            <div>
              <Label>Production Line</Label>
              <Select
                value={formData.production_line}
                onValueChange={(value) => setFormData({ ...formData, production_line: value })}
              >
                <SelectTrigger>
                  <SelectValue />
                </SelectTrigger>
                <SelectContent>
                  {PRODUCTION_LINES.map(l => (
                    <SelectItem key={l.value} value={l.value}>{l.label}</SelectItem>
                  ))}
                </SelectContent>
              </Select>
            </div>
            <div>
              <Label>Notes</Label>
              <Textarea
                value={formData.notes}
                onChange={(e) => setFormData({ ...formData, notes: e.target.value })}
                rows={2}
              />
            </div>
            <div className="flex justify-end gap-3 pt-4">
              <Button type="button" variant="outline" onClick={handleClose}>
                Cancel
              </Button>
              <Button 
                type="submit" 
                className="bg-emerald-600 hover:bg-emerald-700"
                disabled={createMutation.isPending || updateMutation.isPending}
              >
                {editingBatch ? 'Update' : 'Schedule'} Batch
              </Button>
            </div>
          </form>
        </DialogContent>
      </Dialog>

      {/* QC Dialog */}
      <Dialog open={qcOpen} onOpenChange={setQcOpen}>
        <DialogContent className="max-w-md">
          <DialogHeader>
            <DialogTitle>Quality Check: {qcBatch?.batch_number}</DialogTitle>
          </DialogHeader>
          <form onSubmit={handleQCSubmit} className="space-y-4">
            <div className="grid grid-cols-2 gap-4">
              <div>
                <Label>Temperature (°C)</Label>
                <Input
                  type="number"
                  step="0.1"
                  value={qcData.temperature}
                  onChange={(e) => setQcData({ ...qcData, temperature: parseFloat(e.target.value) })}
                />
              </div>
              <div>
                <Label>pH Level</Label>
                <Input
                  type="number"
                  step="0.1"
                  value={qcData.ph_level}
                  onChange={(e) => setQcData({ ...qcData, ph_level: parseFloat(e.target.value) })}
                />
              </div>
            </div>
            <div>
              <Label>Visual Inspection</Label>
              <Select
                value={qcData.visual_inspection}
                onValueChange={(value) => setQcData({ ...qcData, visual_inspection: value })}
              >
                <SelectTrigger>
                  <SelectValue />
                </SelectTrigger>
                <SelectContent>
                  <SelectItem value="pass">Pass</SelectItem>
                  <SelectItem value="conditional">Conditional</SelectItem>
                  <SelectItem value="fail">Fail</SelectItem>
                </SelectContent>
              </Select>
            </div>
            <div>
              <Label>Overall Result</Label>
              <Select
                value={qcData.passed ? 'passed' : 'failed'}
                onValueChange={(value) => setQcData({ ...qcData, passed: value === 'passed' })}
              >
                <SelectTrigger>
                  <SelectValue />
                </SelectTrigger>
                <SelectContent>
                  <SelectItem value="passed">
                    <span className="flex items-center gap-2">
                      <CheckCircle className="w-4 h-4 text-green-600" />
                      Passed
                    </span>
                  </SelectItem>
                  <SelectItem value="failed">
                    <span className="flex items-center gap-2 text-red-600">
                      Failed
                    </span>
                  </SelectItem>
                </SelectContent>
              </Select>
            </div>
            <div>
              <Label>QC Notes</Label>
              <Textarea
                value={qcData.notes}
                onChange={(e) => setQcData({ ...qcData, notes: e.target.value })}
                rows={2}
              />
            </div>
            <div className="flex justify-end gap-3 pt-4">
              <Button type="button" variant="outline" onClick={() => setQcOpen(false)}>
                Cancel
              </Button>
              <Button 
                type="submit" 
                className="bg-emerald-600 hover:bg-emerald-700"
                disabled={updateMutation.isPending}
              >
                Save QC Results
              </Button>
            </div>
          </form>
        </DialogContent>
      </Dialog>
    </div>
  );
}

// PRODUCTION REPORT*****

import React, { useState } from 'react';
import { base44 } from '@/api/base44Client';
import { useQuery } from '@tanstack/react-query';
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { usePermissions } from '../components/shared/PermissionGuard';
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from "@/components/ui/select";
import StatCard from '../components/shared/StatCard';
import DataTable from '../components/shared/DataTable';
import StatusBadge from '../components/shared/StatusBadge';
import { 
  Factory, 
  Clock, 
  CheckCircle,
  AlertTriangle,
  Download,
  TrendingUp
} from 'lucide-react';
import { format, startOfMonth, endOfMonth, subMonths } from 'date-fns';
import { 
  BarChart, 
  Bar, 
  XAxis, 
  YAxis, 
  CartesianGrid, 
  Tooltip, 
  ResponsiveContainer,
  PieChart,
  Pie,
  Cell,
  LineChart,
  Line,
  Legend
} from 'recharts';

const COLORS = ['#10b981', '#3b82f6', '#f59e0b', '#ef4444', '#8b5cf6'];

export default function ProductionReport() {
  const permissions = usePermissions();
  const [dateRange, setDateRange] = useState('this_month');
  const [startDate, setStartDate] = useState(format(startOfMonth(new Date()), 'yyyy-MM-dd'));
  const [endDate, setEndDate] = useState(format(endOfMonth(new Date()), 'yyyy-MM-dd'));

  const { data: batches = [], isLoading } = useQuery({
    queryKey: ['productionBatches'],
    queryFn: () => base44.entities.ProductionBatch.list('-created_date', 500),
  });

  const { data: products = [] } = useQuery({
    queryKey: ['products'],
    queryFn: () => base44.entities.Product.list(),
  });

  // Filter batches by date
  const filteredBatches = batches.filter(b => {
    if (!b.scheduled_date) return false;
    const batchDate = new Date(b.scheduled_date);
    return batchDate >= new Date(startDate) && batchDate <= new Date(endDate);
  });

  // Stats
  const totalBatches = filteredBatches.length;
  const completedBatches = filteredBatches.filter(b => b.status === 'completed').length;
  const totalPlanned = filteredBatches.reduce((sum, b) => sum + (b.planned_quantity || 0), 0);
  const totalActual = filteredBatches.reduce((sum, b) => sum + (b.actual_quantity || b.planned_quantity || 0), 0);
  const efficiency = totalPlanned > 0 ? ((totalActual / totalPlanned) * 100).toFixed(1) : 0;
  const qcPassRate = completedBatches > 0 
    ? ((filteredBatches.filter(b => b.quality_check?.passed).length / completedBatches) * 100).toFixed(1)
    : 0;

  // By status
  const batchesByStatus = filteredBatches.reduce((acc, b) => {
    acc[b.status] = (acc[b.status] || 0) + 1;
    return acc;
  }, {});

  const statusPieData = Object.entries(batchesByStatus).map(([status, count]) => ({
    name: status.replace(/_/g, ' '),
    value: count
  }));

  // By production line
  const byProductionLine = filteredBatches.reduce((acc, b) => {
    const line = b.production_line || 'unknown';
    acc[line] = (acc[line] || 0) + (b.actual_quantity || b.planned_quantity || 0);
    return acc;
  }, {});

  const lineBarData = Object.entries(byProductionLine).map(([line, units]) => ({
    line: line.replace(/_/g, ' '),
    units
  }));

  // By product
  const byProduct = filteredBatches.reduce((acc, b) => {
    acc[b.product_name] = (acc[b.product_name] || 0) + (b.actual_quantity || b.planned_quantity || 0);
    return acc;
  }, {});

  const topProducts = Object.entries(byProduct)
    .sort(([,a], [,b]) => b - a)
    .slice(0, 5)
    .map(([name, units]) => ({ name, units }));

  // Daily production
  const dailyProduction = filteredBatches.reduce((acc, b) => {
    const date = b.scheduled_date;
    if (!acc[date]) {
      acc[date] = { planned: 0, actual: 0 };
    }
    acc[date].planned += b.planned_quantity || 0;
    acc[date].actual += b.actual_quantity || b.planned_quantity || 0;
    return acc;
  }, {});

  const dailyChartData = Object.entries(dailyProduction)
    .sort(([a], [b]) => new Date(a).getTime() - new Date(b).getTime())
    .map(([date, data]) => ({
      date: format(new Date(date), 'MMM dd'),
      planned: data.planned,
      actual: data.actual
    }));

  const handleDateRangeChange = (value) => {
    setDateRange(value);
    const today = new Date();
    switch (value) {
      case 'this_month':
        setStartDate(format(startOfMonth(today), 'yyyy-MM-dd'));
        setEndDate(format(endOfMonth(today), 'yyyy-MM-dd'));
        break;
      case 'last_month':
        const lastMonth = subMonths(today, 1);
        setStartDate(format(startOfMonth(lastMonth), 'yyyy-MM-dd'));
        setEndDate(format(endOfMonth(lastMonth), 'yyyy-MM-dd'));
        break;
      case 'last_3_months':
        setStartDate(format(subMonths(today, 3), 'yyyy-MM-dd'));
        setEndDate(format(today, 'yyyy-MM-dd'));
        break;
      default:
        break;
    }
  };

  const batchColumns = [
    {
      header: 'Batch',
      cell: (row) => (
        <div>
          <p className="font-medium">{row.batch_number}</p>
          <p className="text-sm text-slate-500">{row.product_name}</p>
        </div>
      )
    },
    {
      header: 'Date',
      cell: (row) => format(new Date(row.scheduled_date), 'MMM dd, yyyy')
    },
    {
      header: 'Line',
      cell: (row) => <span className="capitalize">{row.production_line?.replace(/_/g, ' ')}</span>
    },
    {
      header: 'Planned',
      cell: (row) => `${row.planned_quantity} units`
    },
    {
      header: 'Actual',
      cell: (row) => (
        <span className={row.actual_quantity < row.planned_quantity ? 'text-amber-600' : 'text-emerald-600'}>
          {row.actual_quantity || row.planned_quantity} units
        </span>
      )
    },
    {
      header: 'Status',
      cell: (row) => <StatusBadge status={row.status} />
    }
  ];

  return (
    <div className="space-y-6">
      {/* Header */}
      <div className="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
        <div>
          <h1 className="text-2xl font-bold text-slate-900">Production Report</h1>
          <p className="text-slate-500">Analyze production performance</p>
        </div>
        <div className="flex items-center gap-3 flex-wrap">
          <Select value={dateRange} onValueChange={handleDateRangeChange}>
            <SelectTrigger className="w-40">
              <SelectValue />
            </SelectTrigger>
            <SelectContent>
              <SelectItem value="this_month">This Month</SelectItem>
              <SelectItem value="last_month">Last Month</SelectItem>
              <SelectItem value="last_3_months">Last 3 Months</SelectItem>
              <SelectItem value="custom">Custom</SelectItem>
            </SelectContent>
          </Select>
          {dateRange === 'custom' && (
            <>
              <Input
                type="date"
                value={startDate}
                onChange={(e) => setStartDate(e.target.value)}
                className="w-36"
              />
              <Input
                type="date"
                value={endDate}
                onChange={(e) => setEndDate(e.target.value)}
                className="w-36"
              />
            </>
          )}
          {permissions.canExport && (
            <Button variant="outline">
              <Download className="w-4 h-4 mr-2" />
              Export
            </Button>
          )}
        </div>
      </div>

      {/* Stats */}
      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
        <StatCard
          title="Total Batches"
          value={totalBatches}
          icon={Factory}
          iconColor="bg-blue-100 text-blue-600"
          loading={isLoading}
        />
        <StatCard
          title="Completed"
          value={completedBatches}
          icon={CheckCircle}
          iconColor="bg-emerald-100 text-emerald-600"
          loading={isLoading}
        />
        <StatCard
          title="Production Efficiency"
          value={`${efficiency}%`}
          icon={TrendingUp}
          iconColor="bg-amber-100 text-amber-600"
          loading={isLoading}
        />
        <StatCard
          title="QC Pass Rate"
          value={`${qcPassRate}%`}
          icon={AlertTriangle}
          iconColor="bg-purple-100 text-purple-600"
          loading={isLoading}
        />
      </div>

      {/* Charts */}
      <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
        {/* Daily Production */}
        <Card>
          <CardHeader>
            <CardTitle>Daily Production Output</CardTitle>
          </CardHeader>
          <CardContent>
            <div className="h-[300px]">
              {dailyChartData.length > 0 ? (
                <ResponsiveContainer width="100%" height="100%">
                  <LineChart data={dailyChartData}>
                    <CartesianGrid strokeDasharray="3 3" stroke="#e2e8f0" />
                    <XAxis dataKey="date" stroke="#64748b" fontSize={12} />
                    <YAxis stroke="#64748b" fontSize={12} />
                    <Tooltip />
                    <Legend />
                    <Line type="monotone" dataKey="planned" stroke="#3b82f6" strokeWidth={2} name="Planned" />
                    <Line type="monotone" dataKey="actual" stroke="#10b981" strokeWidth={2} name="Actual" />
                  </LineChart>
                </ResponsiveContainer>
              ) : (
                <div className="h-full flex items-center justify-center text-slate-500">
                  No data for selected period
                </div>
              )}
            </div>
          </CardContent>
        </Card>

        {/* By Status */}
        <Card>
          <CardHeader>
            <CardTitle>Batches by Status</CardTitle>
          </CardHeader>
          <CardContent>
            <div className="h-[300px]">
              {statusPieData.length > 0 ? (
                <ResponsiveContainer width="100%" height="100%">
                  <PieChart>
                    <Pie
                      data={statusPieData}
                      cx="50%"
                      cy="50%"
                      innerRadius={60}
                      outerRadius={100}
                      paddingAngle={5}
                      dataKey="value"
                      label={({ name, percent }) => `${name} ${(percent * 100).toFixed(0)}%`}
                    >
                      {statusPieData.map((_, index) => (
                        <Cell key={`cell-${index}`} fill={COLORS[index % COLORS.length]} />
                      ))}
                    </Pie>
                    <Tooltip />
                  </PieChart>
                </ResponsiveContainer>
              ) : (
                <div className="h-full flex items-center justify-center text-slate-500">
                  No data available
                </div>
              )}
            </div>
          </CardContent>
        </Card>
      </div>

      <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
        {/* By Production Line */}
        <Card>
          <CardHeader>
            <CardTitle>Output by Production Line</CardTitle>
          </CardHeader>
          <CardContent>
            <div className="h-[250px]">
              {lineBarData.length > 0 ? (
                <ResponsiveContainer width="100%" height="100%">
                  <BarChart data={lineBarData}>
                    <CartesianGrid strokeDasharray="3 3" stroke="#e2e8f0" />
                    <XAxis dataKey="line" stroke="#64748b" fontSize={12} />
                    <YAxis stroke="#64748b" fontSize={12} />
                    <Tooltip />
                    <Bar dataKey="units" fill="#8b5cf6" radius={[4, 4, 0, 0]} />
                  </BarChart>
                </ResponsiveContainer>
              ) : (
                <div className="h-full flex items-center justify-center text-slate-500">
                  No data available
                </div>
              )}
            </div>
          </CardContent>
        </Card>

        {/* Top Products */}
        <Card>
          <CardHeader>
            <CardTitle>Top Products by Output</CardTitle>
          </CardHeader>
          <CardContent>
            <div className="space-y-4">
              {topProducts.length > 0 ? (
                topProducts.map((product, i) => (
                  <div key={product.name} className="flex items-center justify-between">
                    <div className="flex items-center gap-3">
                      <div className={`w-8 h-8 rounded-full flex items-center justify-center ${
                        ['bg-emerald-100', 'bg-blue-100', 'bg-amber-100', 'bg-purple-100', 'bg-pink-100'][i]
                      }`}>
                        <span className={`text-sm font-medium ${
                          ['text-emerald-600', 'text-blue-600', 'text-amber-600', 'text-purple-600', 'text-pink-600'][i]
                        }`}>
                          {i + 1}
                        </span>
                      </div>
                      <span className="font-medium text-slate-900">{product.name}</span>
                    </div>
                    <span className="font-semibold">{product.units.toLocaleString()} units</span>
                  </div>
                ))
              ) : (
                <p className="text-slate-500 text-center py-4">No production data</p>
              )}
            </div>
          </CardContent>
        </Card>
      </div>

      {/* Batch Details */}
      <Card>
        <CardHeader>
          <CardTitle>Batch Details</CardTitle>
        </CardHeader>
        <CardContent>
          <DataTable
            columns={batchColumns}
            data={filteredBatches.slice(0, 20)}
            isLoading={isLoading}
            emptyMessage="No batches in selected period"
          />
        </CardContent>
      </Card>
    </div>
  );
}

// PRODUCTION SCHEDULE
import React, { useState } from 'react';
import { base44 } from '@/api/base44Client';
import { useQuery } from '@tanstack/react-query';
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import StatusBadge from '../components/shared/StatusBadge';
import { 
  ChevronLeft, 
  ChevronRight, 
  Factory,
  Clock,
  Calendar as CalendarIcon
} from 'lucide-react';
import { format, startOfWeek, addDays, addWeeks, subWeeks, isSameDay } from 'date-fns';
import { cn } from "@/lib/utils";

const PRODUCTION_LINES = ['line_1', 'line_2', 'line_3', 'line_4'];

export default function ProductionSchedule() {
  const [currentWeek, setCurrentWeek] = useState(startOfWeek(new Date(), { weekStartsOn: 1 }));

  const { data: batches = [], isLoading } = useQuery({
    queryKey: ['productionBatches'],
    queryFn: () => base44.entities.ProductionBatch.list('-scheduled_date', 100),
  });

  const weekDays = Array.from({ length: 7 }, (_, i) => addDays(currentWeek, i));

  const getBatchesForDay = (date, line) => {
    return batches.filter(b => {
      const batchDate = b.scheduled_date ? new Date(b.scheduled_date) : null;
      return batchDate && isSameDay(batchDate, date) && b.production_line === line;
    });
  };

  const getStatusColor = (status) => {
    switch (status) {
      case 'completed': return 'bg-emerald-100 border-emerald-300 text-emerald-800';
      case 'in_progress': return 'bg-amber-100 border-amber-300 text-amber-800';
      case 'scheduled': return 'bg-blue-100 border-blue-300 text-blue-800';
      case 'on_hold': return 'bg-orange-100 border-orange-300 text-orange-800';
      case 'quality_check': return 'bg-purple-100 border-purple-300 text-purple-800';
      default: return 'bg-slate-100 border-slate-300 text-slate-800';
    }
  };

  // Stats for the week
  const weekBatches = batches.filter(b => {
    const batchDate = b.scheduled_date ? new Date(b.scheduled_date) : null;
    return batchDate && batchDate >= currentWeek && batchDate < addWeeks(currentWeek, 1);
  });

  const scheduledCount = weekBatches.filter(b => b.status === 'scheduled').length;
  const inProgressCount = weekBatches.filter(b => b.status === 'in_progress').length;
  const completedCount = weekBatches.filter(b => b.status === 'completed').length;
  const totalUnits = weekBatches.reduce((sum, b) => sum + (b.planned_quantity || 0), 0);

  return (
    <div className="space-y-6">
      {/* Header */}
      <div className="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
        <div>
          <h1 className="text-2xl font-bold text-slate-900">Production Schedule</h1>
          <p className="text-slate-500">Weekly production calendar view</p>
        </div>
        <div className="flex items-center gap-2">
          <Button variant="outline" size="icon" onClick={() => setCurrentWeek(subWeeks(currentWeek, 1))}>
            <ChevronLeft className="w-4 h-4" />
          </Button>
          <Button 
            variant="outline" 
            className="min-w-[200px]"
            onClick={() => setCurrentWeek(startOfWeek(new Date(), { weekStartsOn: 1 }))}
          >
            <CalendarIcon className="w-4 h-4 mr-2" />
            {format(currentWeek, 'MMM dd')} - {format(addDays(currentWeek, 6), 'MMM dd, yyyy')}
          </Button>
          <Button variant="outline" size="icon" onClick={() => setCurrentWeek(addWeeks(currentWeek, 1))}>
            <ChevronRight className="w-4 h-4" />
          </Button>
        </div>
      </div>

      {/* Week Summary */}
      <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
        <Card>
          <CardContent className="pt-6">
            <div className="flex items-center gap-3">
              <div className="w-10 h-10 rounded-lg bg-blue-100 flex items-center justify-center">
                <CalendarIcon className="w-5 h-5 text-blue-600" />
              </div>
              <div>
                <p className="text-sm text-slate-500">Scheduled</p>
                <p className="text-xl font-bold text-slate-900">{scheduledCount}</p>
              </div>
            </div>
          </CardContent>
        </Card>
        <Card>
          <CardContent className="pt-6">
            <div className="flex items-center gap-3">
              <div className="w-10 h-10 rounded-lg bg-amber-100 flex items-center justify-center">
                <Clock className="w-5 h-5 text-amber-600" />
              </div>
              <div>
                <p className="text-sm text-slate-500">In Progress</p>
                <p className="text-xl font-bold text-slate-900">{inProgressCount}</p>
              </div>
            </div>
          </CardContent>
        </Card>
        <Card>
          <CardContent className="pt-6">
            <div className="flex items-center gap-3">
              <div className="w-10 h-10 rounded-lg bg-emerald-100 flex items-center justify-center">
                <Factory className="w-5 h-5 text-emerald-600" />
              </div>
              <div>
                <p className="text-sm text-slate-500">Completed</p>
                <p className="text-xl font-bold text-slate-900">{completedCount}</p>
              </div>
            </div>
          </CardContent>
        </Card>
        <Card>
          <CardContent className="pt-6">
            <div className="flex items-center gap-3">
              <div className="w-10 h-10 rounded-lg bg-purple-100 flex items-center justify-center">
                <Factory className="w-5 h-5 text-purple-600" />
              </div>
              <div>
                <p className="text-sm text-slate-500">Total Units</p>
                <p className="text-xl font-bold text-slate-900">{totalUnits.toLocaleString()}</p>
              </div>
            </div>
          </CardContent>
        </Card>
      </div>

      {/* Calendar Grid */}
      <Card className="overflow-hidden">
        <CardContent className="p-0">
          {/* Days Header */}
          <div className="grid grid-cols-8 border-b">
            <div className="p-3 bg-slate-50 border-r font-medium text-sm text-slate-600">
              Production Line
            </div>
            {weekDays.map((day) => (
              <div 
                key={day.toISOString()} 
                className={cn(
                  "p-3 text-center border-r last:border-r-0",
                  isSameDay(day, new Date()) ? "bg-emerald-50" : "bg-slate-50"
                )}
              >
                <p className="text-xs text-slate-500">{format(day, 'EEE')}</p>
                <p className={cn(
                  "text-lg font-semibold",
                  isSameDay(day, new Date()) ? "text-emerald-600" : "text-slate-900"
                )}>
                  {format(day, 'd')}
                </p>
              </div>
            ))}
          </div>

          {/* Production Lines */}
          {PRODUCTION_LINES.map((line) => (
            <div key={line} className="grid grid-cols-8 border-b last:border-b-0">
              <div className="p-3 bg-slate-50 border-r font-medium text-sm flex items-center gap-2">
                <Factory className="w-4 h-4 text-slate-400" />
                <span className="capitalize">{line.replace(/_/g, ' ')}</span>
              </div>
              {weekDays.map((day) => {
                const dayBatches = getBatchesForDay(day, line);
                return (
                  <div 
                    key={`${line}-${day.toISOString()}`} 
                    className={cn(
                      "p-2 border-r last:border-r-0 min-h-[100px]",
                      isSameDay(day, new Date()) && "bg-emerald-50/30"
                    )}
                  >
                    <div className="space-y-1">
                      {dayBatches.map((batch) => (
                        <div
                          key={batch.id}
                          className={cn(
                            "p-2 rounded-lg border text-xs cursor-pointer hover:shadow-sm transition-shadow",
                            getStatusColor(batch.status)
                          )}
                        >
                          <p className="font-medium truncate">{batch.product_name}</p>
                          <p className="text-[10px] opacity-75">
                            {batch.batch_number} • {batch.planned_quantity} units
                          </p>
                        </div>
                      ))}
                    </div>
                  </div>
                );
              })}
            </div>
          ))}
        </CardContent>
      </Card>

      {/* Legend */}
      <div className="flex flex-wrap gap-4 text-sm">
        <div className="flex items-center gap-2">
          <div className="w-4 h-4 rounded bg-blue-100 border border-blue-300" />
          <span className="text-slate-600">Scheduled</span>
        </div>
        <div className="flex items-center gap-2">
          <div className="w-4 h-4 rounded bg-amber-100 border border-amber-300" />
          <span className="text-slate-600">In Progress</span>
        </div>
        <div className="flex items-center gap-2">
          <div className="w-4 h-4 rounded bg-purple-100 border border-purple-300" />
          <span className="text-slate-600">Quality Check</span>
        </div>
        <div className="flex items-center gap-2">
          <div className="w-4 h-4 rounded bg-emerald-100 border border-emerald-300" />
          <span className="text-slate-600">Completed</span>
        </div>
        <div className="flex items-center gap-2">
          <div className="w-4 h-4 rounded bg-orange-100 border border-orange-300" />
          <span className="text-slate-600">On Hold</span>
        </div>
      </div>
    </div>
  );
}

// PRODUCTS*****

import React, { useState } from 'react';
import { base44 } from '@/api/base44Client';
import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';
import PageHeader from '../components/shared/PageHeader';
import DataTable from '../components/shared/DataTable';
import StatusBadge from '../components/shared/StatusBadge';
import { usePermissions } from '../components/shared/PermissionGuard';
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Textarea } from "@/components/ui/textarea";
import {
  Dialog,
  DialogContent,
  DialogHeader,
  DialogTitle,
} from "@/components/ui/dialog";
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from "@/components/ui/select";
import { Search, Package, MoreVertical, Pencil, Trash2, Plus, X } from 'lucide-react';
import {
  DropdownMenu,
  DropdownMenuContent,
  DropdownMenuItem,
  DropdownMenuTrigger,
} from "@/components/ui/dropdown-menu";
import { Badge } from "@/components/ui/badge";
import { Card } from "@/components/ui/card";
import { toast } from "sonner";

const CATEGORIES = [
  { value: 'beverages', label: 'Beverages' },
  { value: 'snacks', label: 'Snacks' },
  { value: 'dairy', label: 'Dairy' },
  { value: 'bakery', label: 'Bakery' },
  { value: 'frozen', label: 'Frozen' },
  { value: 'canned', label: 'Canned' },
  { value: 'condiments', label: 'Condiments' },
  { value: 'other', label: 'Other' }
];

const UNITS = ['pcs', 'pack', 'box', 'case', 'kg', 'l'];

export default function Products() {
  const permissions = usePermissions();
  const [isOpen, setIsOpen] = useState(false);
  const [editingProduct, setEditingProduct] = useState(null);
  const [search, setSearch] = useState('');
  const [categoryFilter, setCategoryFilter] = useState('all');
  const [formData, setFormData] = useState({
    name: '',
    sku: '',
    category: 'snacks',
    description: '',
    unit: 'pcs',
    unit_price: 0,
    cost_price: 0,
    current_stock: 0,
    minimum_stock: 0,
    shelf_life_days: 90,
    batch_size: 100,
    production_time_minutes: 60,
    recipe: [],
    status: 'active'
  });

  const queryClient = useQueryClient();

  const { data: products = [], isLoading } = useQuery({
    queryKey: ['products'],
    queryFn: () => base44.entities.Product.list('-created_date'),
  });

  const { data: materials = [] } = useQuery({
    queryKey: ['rawMaterials'],
    queryFn: () => base44.entities.RawMaterial.list(),
  });

  const createMutation = useMutation({
    mutationFn: (data) => base44.entities.Product.create(data),
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['products'] });
      toast.success('Product created successfully');
      handleClose();
    },
  });

  const updateMutation = useMutation({
    mutationFn: ({ id, data }) => base44.entities.Product.update(id, data),
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['products'] });
      toast.success('Product updated successfully');
      handleClose();
    },
  });

  const deleteMutation = useMutation({
    mutationFn: (id) => base44.entities.Product.delete(id),
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['products'] });
      toast.success('Product deleted successfully');
    },
  });

  const handleOpen = (product = null) => {
    if (product) {
      setEditingProduct(product);
      setFormData({
        name: product.name || '',
        sku: product.sku || '',
        category: product.category || 'snacks',
        description: product.description || '',
        unit: product.unit || 'pcs',
        unit_price: product.unit_price || 0,
        cost_price: product.cost_price || 0,
        current_stock: product.current_stock || 0,
        minimum_stock: product.minimum_stock || 0,
        shelf_life_days: product.shelf_life_days || 90,
        batch_size: product.batch_size || 100,
        production_time_minutes: product.production_time_minutes || 60,
        recipe: product.recipe || [],
        status: product.status || 'active'
      });
    } else {
      setEditingProduct(null);
      setFormData({
        name: '',
        sku: '',
        category: 'snacks',
        description: '',
        unit: 'pcs',
        unit_price: 0,
        cost_price: 0,
        current_stock: 0,
        minimum_stock: 0,
        shelf_life_days: 90,
        batch_size: 100,
        production_time_minutes: 60,
        recipe: [],
        status: 'active'
      });
    }
    setIsOpen(true);
  };

  const handleClose = () => {
    setIsOpen(false);
    setEditingProduct(null);
  };

  const handleSubmit = (e) => {
    e.preventDefault();
    if (editingProduct) {
      updateMutation.mutate({ id: editingProduct.id, data: formData });
    } else {
      createMutation.mutate(formData);
    }
  };

  const addRecipeItem = () => {
    setFormData({
      ...formData,
      recipe: [...formData.recipe, { material_id: '', material_name: '', quantity: 0, unit: 'kg' }]
    });
  };

  const updateRecipeItem = (index, field, value) => {
    const newRecipe = [...formData.recipe];
    if (field === 'material_id') {
      const material = materials.find(m => m.id === value);
      newRecipe[index] = {
        ...newRecipe[index],
        material_id: value,
        material_name: material?.name || '',
        unit: material?.unit || 'kg'
      };
    } else {
      newRecipe[index] = { ...newRecipe[index], [field]: value };
    }
    setFormData({ ...formData, recipe: newRecipe });
  };

  const removeRecipeItem = (index) => {
    setFormData({
      ...formData,
      recipe: formData.recipe.filter((_, i) => i !== index)
    });
  };

  const filteredProducts = products.filter(p => {
    const matchesSearch = p.name?.toLowerCase().includes(search.toLowerCase()) ||
      p.sku?.toLowerCase().includes(search.toLowerCase());
    const matchesCategory = categoryFilter === 'all' || p.category === categoryFilter;
    return matchesSearch && matchesCategory;
  });

  const columns = [
    {
      header: 'Product',
      cell: (row) => (
        <div className="flex items-center gap-3">
          <div className="w-10 h-10 rounded-lg bg-indigo-100 flex items-center justify-center">
            <Package className="w-5 h-5 text-indigo-600" />
          </div>
          <div>
            <p className="font-medium text-slate-900">{row.name}</p>
            <p className="text-sm text-slate-500">{row.sku}</p>
          </div>
        </div>
      )
    },
    {
      header: 'Category',
      cell: (row) => (
        <Badge variant="outline" className="capitalize">
          {row.category}
        </Badge>
      )
    },
    {
      header: 'Price',
      cell: (row) => (
        <div>
          <p className="font-medium text-slate-900">₱{(row.unit_price || 0).toFixed(2)}</p>
          <p className="text-xs text-slate-500">Cost: ₱{(row.cost_price || 0).toFixed(2)}</p>
        </div>
      )
    },
    {
      header: 'Stock',
      cell: (row) => (
        <div>
          <p className={`font-medium ${
            (row.current_stock || 0) <= (row.minimum_stock || 0) 
              ? 'text-red-600' 
              : 'text-slate-900'
          }`}>
            {row.current_stock || 0} {row.unit}
          </p>
          <p className="text-xs text-slate-500">Min: {row.minimum_stock || 0}</p>
        </div>
      )
    },
    {
      header: 'Batch Size',
      cell: (row) => (
        <span className="text-slate-600">{row.batch_size || '-'} units</span>
      )
    },
    {
      header: 'Status',
      cell: (row) => <StatusBadge status={row.status} />
    },
    {
      header: '',
      className: 'w-12',
      cell: (row) => (
        <DropdownMenu>
          <DropdownMenuTrigger asChild>
            <Button variant="ghost" size="icon">
              <MoreVertical className="w-4 h-4" />
            </Button>
          </DropdownMenuTrigger>
          <DropdownMenuContent align="end">
            <DropdownMenuItem onClick={() => handleOpen(row)}>
              <Pencil className="w-4 h-4 mr-2" />
              Edit
            </DropdownMenuItem>
            <DropdownMenuItem 
              onClick={() => deleteMutation.mutate(row.id)}
              className="text-red-600"
            >
              <Trash2 className="w-4 h-4 mr-2" />
              Delete
            </DropdownMenuItem>
          </DropdownMenuContent>
        </DropdownMenu>
      )
    }
  ];

  return (
    <div>
      <PageHeader
        title="Products"
        description="Manage your finished products catalog"
        action={permissions.canEdit ? () => handleOpen() : null}
        actionLabel="Add Product"
      >
        <Select value={categoryFilter} onValueChange={setCategoryFilter}>
          <SelectTrigger className="w-40">
            <SelectValue placeholder="Category" />
          </SelectTrigger>
          <SelectContent>
            <SelectItem value="all">All Categories</SelectItem>
            {CATEGORIES.map(cat => (
              <SelectItem key={cat.value} value={cat.value}>{cat.label}</SelectItem>
            ))}
          </SelectContent>
        </Select>
        <div className="relative">
          <Search className="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400" />
          <Input
            placeholder="Search products..."
            value={search}
            onChange={(e) => setSearch(e.target.value)}
            className="pl-10 w-64"
          />
        </div>
      </PageHeader>

      <DataTable
        columns={columns}
        data={filteredProducts}
        isLoading={isLoading}
        emptyMessage="No products found. Add your first product to get started."
      />

      <Dialog open={isOpen} onOpenChange={setIsOpen}>
        <DialogContent className="max-w-2xl max-h-[90vh] overflow-y-auto">
          <DialogHeader>
            <DialogTitle>
              {editingProduct ? 'Edit Product' : 'Add New Product'}
            </DialogTitle>
          </DialogHeader>
          <form onSubmit={handleSubmit} className="space-y-6">
            <div className="grid grid-cols-2 gap-4">
              <div className="col-span-2">
                <Label>Product Name *</Label>
                <Input
                  value={formData.name}
                  onChange={(e) => setFormData({ ...formData, name: e.target.value })}
                  required
                />
              </div>
              <div>
                <Label>SKU *</Label>
                <Input
                  value={formData.sku}
                  onChange={(e) => setFormData({ ...formData, sku: e.target.value })}
                  required
                />
              </div>
              <div>
                <Label>Category</Label>
                <Select
                  value={formData.category}
                  onValueChange={(value) => setFormData({ ...formData, category: value })}
                >
                  <SelectTrigger>
                    <SelectValue />
                  </SelectTrigger>
                  <SelectContent>
                    {CATEGORIES.map(cat => (
                      <SelectItem key={cat.value} value={cat.value}>{cat.label}</SelectItem>
                    ))}
                  </SelectContent>
                </Select>
              </div>
              <div className="col-span-2">
                <Label>Description</Label>
                <Textarea
                  value={formData.description}
                  onChange={(e) => setFormData({ ...formData, description: e.target.value })}
                  rows={2}
                />
              </div>
              <div>
                <Label>Unit</Label>
                <Select
                  value={formData.unit}
                  onValueChange={(value) => setFormData({ ...formData, unit: value })}
                >
                  <SelectTrigger>
                    <SelectValue />
                  </SelectTrigger>
                  <SelectContent>
                    {UNITS.map(u => (
                      <SelectItem key={u} value={u}>{u}</SelectItem>
                    ))}
                  </SelectContent>
                </Select>
              </div>
              <div>
                <Label>Selling Price (₱) *</Label>
                <Input
                  type="number"
                  step="0.01"
                  min="0"
                  value={formData.unit_price}
                  onChange={(e) => setFormData({ ...formData, unit_price: parseFloat(e.target.value) || 0 })}
                  required
                />
              </div>
              <div>
                <Label>Cost Price (₱)</Label>
                <Input
                  type="number"
                  step="0.01"
                  min="0"
                  value={formData.cost_price}
                  onChange={(e) => setFormData({ ...formData, cost_price: parseFloat(e.target.value) || 0 })}
                />
              </div>
              <div>
                <Label>Minimum Stock</Label>
                <Input
                  type="number"
                  min="0"
                  value={formData.minimum_stock}
                  onChange={(e) => setFormData({ ...formData, minimum_stock: parseFloat(e.target.value) || 0 })}
                />
              </div>
              <div>
                <Label>Batch Size</Label>
                <Input
                  type="number"
                  min="1"
                  value={formData.batch_size}
                  onChange={(e) => setFormData({ ...formData, batch_size: parseInt(e.target.value) || 100 })}
                />
              </div>
              <div>
                <Label>Production Time (min)</Label>
                <Input
                  type="number"
                  min="1"
                  value={formData.production_time_minutes}
                  onChange={(e) => setFormData({ ...formData, production_time_minutes: parseInt(e.target.value) || 60 })}
                />
              </div>
              <div>
                <Label>Shelf Life (days)</Label>
                <Input
                  type="number"
                  min="1"
                  value={formData.shelf_life_days}
                  onChange={(e) => setFormData({ ...formData, shelf_life_days: parseInt(e.target.value) || 90 })}
                />
              </div>
              <div>
                <Label>Status</Label>
                <Select
                  value={formData.status}
                  onValueChange={(value) => setFormData({ ...formData, status: value })}
                >
                  <SelectTrigger>
                    <SelectValue />
                  </SelectTrigger>
                  <SelectContent>
                    <SelectItem value="active">Active</SelectItem>
                    <SelectItem value="discontinued">Discontinued</SelectItem>
                    <SelectItem value="development">In Development</SelectItem>
                  </SelectContent>
                </Select>
              </div>
            </div>

            {/* Recipe/BOM Section */}
            <div>
              <div className="flex items-center justify-between mb-3">
                <Label className="text-base">Recipe (Bill of Materials)</Label>
                <Button type="button" variant="outline" size="sm" onClick={addRecipeItem}>
                  <Plus className="w-4 h-4 mr-1" />
                  Add Material
                </Button>
              </div>
              {formData.recipe.length === 0 ? (
                <Card className="p-4 text-center text-slate-500 border-dashed">
                  No materials added. Click "Add Material" to build the recipe.
                </Card>
              ) : (
                <div className="space-y-2">
                  {formData.recipe.map((item, index) => (
                    <Card key={index} className="p-3">
                      <div className="flex items-center gap-3">
                        <div className="flex-1">
                          <Select
                            value={item.material_id}
                            onValueChange={(value) => updateRecipeItem(index, 'material_id', value)}
                          >
                            <SelectTrigger>
                              <SelectValue placeholder="Select material" />
                            </SelectTrigger>
                            <SelectContent>
                              {materials.map(m => (
                                <SelectItem key={m.id} value={m.id}>{m.name}</SelectItem>
                              ))}
                            </SelectContent>
                          </Select>
                        </div>
                        <Input
                          type="number"
                          placeholder="Qty"
                          className="w-24"
                          value={item.quantity}
                          onChange={(e) => updateRecipeItem(index, 'quantity', parseFloat(e.target.value) || 0)}
                        />
                        <span className="text-sm text-slate-500 w-12">{item.unit}</span>
                        <Button
                          type="button"
                          variant="ghost"
                          size="icon"
                          onClick={() => removeRecipeItem(index)}
                        >
                          <X className="w-4 h-4 text-red-500" />
                        </Button>
                      </div>
                    </Card>
                  ))}
                </div>
              )}
            </div>

            <div className="flex justify-end gap-3 pt-4">
              <Button type="button" variant="outline" onClick={handleClose}>
                Cancel
              </Button>
              <Button 
                type="submit" 
                className="bg-emerald-600 hover:bg-emerald-700"
                disabled={createMutation.isPending || updateMutation.isPending}
              >
                {editingProduct ? 'Update' : 'Create'} Product
              </Button>
            </div>
          </form>
        </DialogContent>
      </Dialog>
    </div>
  );
}

//PRODUCTS INVENTORY*****
import React, { useState } from 'react';
import { base44 } from '@/api/base44Client';
import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';
import PageHeader from '../components/shared/PageHeader';
import DataTable from '../components/shared/DataTable';
import { usePermissions } from '../components/shared/PermissionGuard';
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Textarea } from "@/components/ui/textarea";
import { Card, CardContent } from "@/components/ui/card";
import {
  Dialog,
  DialogContent,
  DialogHeader,
  DialogTitle,
} from "@/components/ui/dialog";
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from "@/components/ui/select";
import { Search, Package, AlertTriangle, Plus, Minus, RefreshCw, DollarSign } from 'lucide-react';
import { Badge } from "@/components/ui/badge";
import { Progress } from "@/components/ui/progress";
import { toast } from "sonner";

export default function ProductsInventory() {
  const permissions = usePermissions();
  const [adjustOpen, setAdjustOpen] = useState(false);
  const [selectedProduct, setSelectedProduct] = useState(null);
  const [search, setSearch] = useState('');
  const [stockFilter, setStockFilter] = useState('all');
  const [adjustData, setAdjustData] = useState({
    adjustment_type: 'add',
    quantity: 0,
    reason: ''
  });

  const queryClient = useQueryClient();

  const { data: products = [], isLoading } = useQuery({
    queryKey: ['products'],
    queryFn: () => base44.entities.Product.list(),
  });

  const updateProductMutation = useMutation({
    mutationFn: ({ id, data }) => base44.entities.Product.update(id, data),
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['products'] });
    },
  });

  const createTransactionMutation = useMutation({
    mutationFn: (data) => base44.entities.InventoryTransaction.create(data),
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['inventoryTransactions'] });
    },
  });

  const handleAdjust = (product) => {
    setSelectedProduct(product);
    setAdjustData({
      adjustment_type: 'add',
      quantity: 0,
      reason: ''
    });
    setAdjustOpen(true);
  };

  const handleAdjustSubmit = async (e) => {
    e.preventDefault();
    
    const currentStock = selectedProduct.current_stock || 0;
    const adjustQty = adjustData.quantity || 0;
    const newStock = adjustData.adjustment_type === 'add' 
      ? currentStock + adjustQty 
      : currentStock - adjustQty;

    if (newStock < 0) {
      toast.error('Cannot reduce stock below 0');
      return;
    }

    await updateProductMutation.mutateAsync({
      id: selectedProduct.id,
      data: { current_stock: newStock }
    });

    await createTransactionMutation.mutateAsync({
      transaction_type: adjustData.adjustment_type === 'add' ? 'receipt' : 'issue',
      item_type: 'finished_product',
      item_id: selectedProduct.id,
      item_name: selectedProduct.name,
      quantity: adjustQty,
      unit: selectedProduct.unit,
      reference_type: 'manual',
      before_quantity: currentStock,
      after_quantity: newStock,
      unit_cost: selectedProduct.cost_price || 0,
      total_value: adjustQty * (selectedProduct.cost_price || 0),
      reason: adjustData.reason
    });

    toast.success('Stock adjusted successfully');
    setAdjustOpen(false);
  };

  const getStockLevel = (product) => {
    const current = product.current_stock || 0;
    const minimum = product.minimum_stock || 0;
    if (current <= 0) return 'out';
    if (current <= minimum) return 'low';
    if (current <= minimum * 1.5) return 'warning';
    return 'healthy';
  };

  const filteredProducts = products.filter(p => {
    const matchesSearch = p.name?.toLowerCase().includes(search.toLowerCase()) ||
      p.sku?.toLowerCase().includes(search.toLowerCase());
    const stockLevel = getStockLevel(p);
    const matchesStock = stockFilter === 'all' || 
      (stockFilter === 'low' && ['low', 'out'].includes(stockLevel)) ||
      (stockFilter === 'healthy' && stockLevel === 'healthy');
    return matchesSearch && matchesStock;
  });

  const totalItems = products.length;
  const lowStockItems = products.filter(p => getStockLevel(p) === 'low' || getStockLevel(p) === 'out').length;
  const totalValue = products.reduce((sum, p) => sum + ((p.current_stock || 0) * (p.cost_price || 0)), 0);
  const totalRetailValue = products.reduce((sum, p) => sum + ((p.current_stock || 0) * (p.unit_price || 0)), 0);

  const columns = [
    {
      header: 'Product',
      cell: (row) => {
        const stockLevel = getStockLevel(row);
        return (
          <div className="flex items-center gap-3">
            <div className={`w-10 h-10 rounded-lg flex items-center justify-center ${
              stockLevel === 'out' || stockLevel === 'low' ? 'bg-red-100' : 
              stockLevel === 'warning' ? 'bg-amber-100' : 'bg-indigo-100'
            }`}>
              {stockLevel === 'out' || stockLevel === 'low' ? (
                <AlertTriangle className="w-5 h-5 text-red-600" />
              ) : (
                <Package className={`w-5 h-5 ${stockLevel === 'warning' ? 'text-amber-600' : 'text-indigo-600'}`} />
              )}
            </div>
            <div>
              <p className="font-medium text-slate-900">{row.name}</p>
              <p className="text-sm text-slate-500">{row.sku}</p>
            </div>
          </div>
        );
      }
    },
    {
      header: 'Category',
      cell: (row) => (
        <Badge variant="outline" className="capitalize">
          {row.category}
        </Badge>
      )
    },
    {
      header: 'Stock Level',
      cell: (row) => {
        const current = row.current_stock || 0;
        const minimum = row.minimum_stock || 1;
        const percentage = Math.min((current / (minimum * 2)) * 100, 100);
        const stockLevel = getStockLevel(row);
        
        return (
          <div className="w-32">
            <div className="flex justify-between text-sm mb-1">
              <span className={`font-medium ${
                stockLevel === 'out' || stockLevel === 'low' ? 'text-red-600' : 'text-slate-900'
              }`}>
                {current} {row.unit}
              </span>
            </div>
            <Progress 
              value={percentage} 
              className={`h-2 ${
                stockLevel === 'out' || stockLevel === 'low' ? '[&>div]:bg-red-500' : 
                stockLevel === 'warning' ? '[&>div]:bg-amber-500' : '[&>div]:bg-indigo-500'
              }`}
            />
            <p className="text-xs text-slate-500 mt-1">Min: {minimum} {row.unit}</p>
          </div>
        );
      }
    },
    {
      header: 'Pricing',
      cell: (row) => (
        <div>
          <p className="font-medium text-slate-900">₱{(row.unit_price || 0).toFixed(2)}</p>
          <p className="text-xs text-slate-500">Cost: ₱{(row.cost_price || 0).toFixed(2)}</p>
        </div>
      )
    },
    {
      header: 'Stock Value',
      cell: (row) => (
        <span className="font-semibold text-slate-900">
          ₱{((row.current_stock || 0) * (row.cost_price || 0)).toFixed(2)}
        </span>
      )
    },
    {
      header: 'Retail Value',
      cell: (row) => (
        <span className="font-semibold text-emerald-600">
          ₱{((row.current_stock || 0) * (row.unit_price || 0)).toFixed(2)}
        </span>
      )
    },
    {
      header: '',
      cell: (row) => (
        permissions.canEdit ? (
          <Button 
            variant="outline" 
            size="sm"
            onClick={() => handleAdjust(row)}
          >
            <RefreshCw className="w-4 h-4 mr-1" />
            Adjust
          </Button>
        ) : null
      )
    }
  ];

  return (
    <div>
      <PageHeader
        title="Finished Goods Inventory"
        description="Monitor product stock levels"
      >
        <Select value={stockFilter} onValueChange={setStockFilter}>
          <SelectTrigger className="w-36">
            <SelectValue placeholder="Stock" />
          </SelectTrigger>
          <SelectContent>
            <SelectItem value="all">All Stock</SelectItem>
            <SelectItem value="low">Low Stock</SelectItem>
            <SelectItem value="healthy">Healthy</SelectItem>
          </SelectContent>
        </Select>
        <div className="relative">
          <Search className="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400" />
          <Input
            placeholder="Search products..."
            value={search}
            onChange={(e) => setSearch(e.target.value)}
            className="pl-10 w-64"
          />
        </div>
      </PageHeader>

      {/* Summary Cards */}
      <div className="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
        <Card>
          <CardContent className="pt-6">
            <div className="flex justify-between">
              <div>
                <p className="text-sm text-slate-500">Total Products</p>
                <p className="text-2xl font-bold text-slate-900">{totalItems}</p>
              </div>
              <div className="w-10 h-10 rounded-lg bg-indigo-100 flex items-center justify-center">
                <Package className="w-5 h-5 text-indigo-600" />
              </div>
            </div>
          </CardContent>
        </Card>
        <Card>
          <CardContent className="pt-6">
            <div className="flex justify-between">
              <div>
                <p className="text-sm text-slate-500">Low Stock</p>
                <p className="text-2xl font-bold text-red-600">{lowStockItems}</p>
              </div>
              <div className="w-10 h-10 rounded-lg bg-red-100 flex items-center justify-center">
                <AlertTriangle className="w-5 h-5 text-red-600" />
              </div>
            </div>
          </CardContent>
        </Card>
        <Card>
          <CardContent className="pt-6">
            <div className="flex justify-between">
              <div>
                <p className="text-sm text-slate-500">Cost Value</p>
                <p className="text-2xl font-bold text-slate-900">₱{totalValue.toLocaleString()}</p>
              </div>
              <div className="w-10 h-10 rounded-lg bg-amber-100 flex items-center justify-center">
                <DollarSign className="w-5 h-5 text-amber-600" />
              </div>
            </div>
          </CardContent>
        </Card>
        <Card>
          <CardContent className="pt-6">
            <div className="flex justify-between">
              <div>
                <p className="text-sm text-slate-500">Retail Value</p>
                <p className="text-2xl font-bold text-emerald-600">₱{totalRetailValue.toLocaleString()}</p>
              </div>
              <div className="w-10 h-10 rounded-lg bg-emerald-100 flex items-center justify-center">
                <DollarSign className="w-5 h-5 text-emerald-600" />
              </div>
            </div>
          </CardContent>
        </Card>
      </div>

      <DataTable
        columns={columns}
        data={filteredProducts}
        isLoading={isLoading}
        emptyMessage="No products found."
      />

      {/* Stock Adjustment Dialog */}
      <Dialog open={adjustOpen} onOpenChange={setAdjustOpen}>
        <DialogContent className="max-w-md">
          <DialogHeader>
            <DialogTitle>Adjust Stock: {selectedProduct?.name}</DialogTitle>
          </DialogHeader>
          <form onSubmit={handleAdjustSubmit} className="space-y-4">
            <div className="p-3 bg-slate-50 rounded-lg">
              <p className="text-sm text-slate-500">Current Stock</p>
              <p className="font-semibold text-lg">
                {selectedProduct?.current_stock || 0} {selectedProduct?.unit}
              </p>
            </div>
            
            <div>
              <Label>Adjustment Type</Label>
              <Select
                value={adjustData.adjustment_type}
                onValueChange={(value) => setAdjustData({ ...adjustData, adjustment_type: value })}
              >
                <SelectTrigger>
                  <SelectValue />
                </SelectTrigger>
                <SelectContent>
                  <SelectItem value="add">
                    <span className="flex items-center gap-2">
                      <Plus className="w-4 h-4 text-green-600" />
                      Add Stock
                    </span>
                  </SelectItem>
                  <SelectItem value="remove">
                    <span className="flex items-center gap-2">
                      <Minus className="w-4 h-4 text-red-600" />
                      Remove Stock
                    </span>
                  </SelectItem>
                </SelectContent>
              </Select>
            </div>
            <div>
              <Label>Quantity ({selectedProduct?.unit})</Label>
              <Input
                type="number"
                min="0"
                value={adjustData.quantity}
                onChange={(e) => setAdjustData({ ...adjustData, quantity: parseInt(e.target.value) || 0 })}
              />
            </div>
            <div>
              <Label>Reason</Label>
              <Textarea
                value={adjustData.reason}
                onChange={(e) => setAdjustData({ ...adjustData, reason: e.target.value })}
                rows={2}
                placeholder="e.g., Production completed, Damaged goods..."
              />
            </div>

            <div className="p-3 bg-indigo-50 rounded-lg">
              <p className="text-sm text-slate-500">New Stock Level</p>
              <p className="font-semibold text-lg text-indigo-600">
                {adjustData.adjustment_type === 'add' 
                  ? (selectedProduct?.current_stock || 0) + (adjustData.quantity || 0)
                  : (selectedProduct?.current_stock || 0) - (adjustData.quantity || 0)
                } {selectedProduct?.unit}
              </p>
            </div>

            <div className="flex justify-end gap-3 pt-4">
              <Button type="button" variant="outline" onClick={() => setAdjustOpen(false)}>
                Cancel
              </Button>
              <Button 
                type="submit" 
                className="bg-emerald-600 hover:bg-emerald-700"
                disabled={updateProductMutation.isPending}
              >
                Confirm Adjustment
              </Button>
            </div>
          </form>
        </DialogContent>
      </Dialog>
    </div>
  );
}

//PROFILE*****

import React, { useState, useEffect } from 'react';
import { base44 } from '@/api/base44Client';
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Badge } from "@/components/ui/badge";
import { UserCircle, Mail, Phone, Building2, Shield, Save } from 'lucide-react';
import { toast } from "sonner";

export default function Profile() {
  const [user, setUser] = useState(null);
  const [loading, setLoading] = useState(true);
  const [saving, setSaving] = useState(false);
  const [formData, setFormData] = useState({
    phone: '',
    job_title: ''
  });

  useEffect(() => {
    loadUser();
  }, []);

  const loadUser = async () => {
    try {
      const userData = await base44.auth.me();
      setUser(userData);
      setFormData({
        phone: userData.phone || '',
        job_title: userData.job_title || ''
      });
    } catch (error) {
      console.error('Error loading user:', error);
    } finally {
      setLoading(false);
    }
  };

  const handleSave = async (e) => {
    e.preventDefault();
    setSaving(true);
    try {
      await base44.auth.updateMe(formData);
      toast.success('Profile updated successfully');
      await loadUser();
    } catch (error) {
      toast.error('Failed to update profile');
    } finally {
      setSaving(false);
    }
  };

  if (loading) {
    return (
      <div className="flex items-center justify-center min-h-[400px]">
        <div className="animate-spin w-8 h-8 border-4 border-emerald-500 border-t-transparent rounded-full" />
      </div>
    );
  }

  return (
    <div className="max-w-2xl mx-auto space-y-6">
      <div>
        <h1 className="text-2xl font-bold text-slate-900">My Profile</h1>
        <p className="text-slate-500">Manage your account settings</p>
      </div>

      {/* Profile Overview */}
      <Card>
        <CardContent className="pt-6">
          <div className="flex items-center gap-6">
            <div className="w-20 h-20 rounded-full bg-gradient-to-br from-emerald-400 to-teal-500 flex items-center justify-center">
              <UserCircle className="w-12 h-12 text-white" />
            </div>
            <div>
              <h2 className="text-xl font-semibold text-slate-900">{user?.full_name || 'User'}</h2>
              <p className="text-slate-500">{user?.email}</p>
              <div className="flex items-center gap-2 mt-2">
                <Badge variant="outline" className={
                  user?.custom_role === 'admin' ? 'bg-purple-100 text-purple-700 border-purple-200' : 
                  user?.custom_role === 'management' ? 'bg-emerald-100 text-emerald-700 border-emerald-200' :
                  user?.custom_role === 'sales' ? 'bg-blue-100 text-blue-700 border-blue-200' :
                  user?.custom_role === 'concessionaire' ? 'bg-amber-100 text-amber-700 border-amber-200' :
                  'bg-slate-100 text-slate-700 border-slate-200'
                }>
                  <Shield className="w-3 h-3 mr-1" />
                  {(user?.custom_role || user?.role || 'guest').charAt(0).toUpperCase() + (user?.custom_role || user?.role || 'guest').slice(1)}
                </Badge>
                {user?.department && (
                  <Badge variant="outline" className="capitalize">
                    <Building2 className="w-3 h-3 mr-1" />
                    {user.department}
                  </Badge>
                )}
              </div>
            </div>
          </div>
        </CardContent>
      </Card>

      {/* Edit Profile */}
      <Card>
        <CardHeader>
          <CardTitle>Profile Information</CardTitle>
        </CardHeader>
        <CardContent>
          <form onSubmit={handleSave} className="space-y-4">
            <div className="grid grid-cols-2 gap-4">
              <div className="col-span-2">
                <Label>Full Name</Label>
                <Input
                  value={user?.full_name || ''}
                  disabled
                  className="bg-slate-50"
                />
                <p className="text-xs text-slate-500 mt-1">Name cannot be changed here</p>
              </div>
              <div className="col-span-2">
                <Label>Email</Label>
                <Input
                  value={user?.email || ''}
                  disabled
                  className="bg-slate-50"
                />
              </div>
              <div>
                <Label>Phone</Label>
                <Input
                  value={formData.phone}
                  onChange={(e) => setFormData({ ...formData, phone: e.target.value })}
                  placeholder="Your phone number"
                />
              </div>
              <div>
                <Label>Job Title</Label>
                <Input
                  value={formData.job_title}
                  onChange={(e) => setFormData({ ...formData, job_title: e.target.value })}
                  placeholder="Your job title"
                />
              </div>
            </div>
            <div className="flex justify-end pt-4">
              <Button 
                type="submit" 
                className="bg-emerald-600 hover:bg-emerald-700"
                disabled={saving}
              >
                <Save className="w-4 h-4 mr-2" />
                {saving ? 'Saving...' : 'Save Changes'}
              </Button>
            </div>
          </form>
        </CardContent>
      </Card>

      {/* Permissions */}
      <Card>
        <CardHeader>
          <CardTitle>Permissions</CardTitle>
        </CardHeader>
        <CardContent>
          <div className="space-y-4">
            <div className="flex items-center justify-between p-3 bg-slate-50 rounded-lg">
              <div>
                <p className="font-medium">Approve Purchase Orders</p>
                <p className="text-sm text-slate-500">Can approve PO requests</p>
              </div>
              <Badge variant={user?.can_approve_po ? 'default' : 'secondary'}>
                {user?.can_approve_po ? 'Enabled' : 'Disabled'}
              </Badge>
            </div>
            {user?.can_approve_po && user?.po_approval_limit && (
              <div className="flex items-center justify-between p-3 bg-blue-50 rounded-lg">
                <div>
                  <p className="font-medium">PO Approval Limit</p>
                  <p className="text-sm text-slate-500">Maximum amount you can approve</p>
                </div>
                <span className="font-semibold text-blue-600">
                  ${user.po_approval_limit.toLocaleString()}
                </span>
              </div>
            )}
            <div className="flex items-center justify-between p-3 bg-slate-50 rounded-lg">
              <div>
                <p className="font-medium">Approve Sales Orders</p>
                <p className="text-sm text-slate-500">Can approve customer orders</p>
              </div>
              <Badge variant={user?.can_approve_orders ? 'default' : 'secondary'}>
                {user?.can_approve_orders ? 'Enabled' : 'Disabled'}
              </Badge>
            </div>
          </div>
          <p className="text-sm text-slate-500 mt-4">
            Contact your administrator to update permissions.
          </p>
        </CardContent>
      </Card>

      {/* Sign Out */}
      <Card>
        <CardContent className="pt-6">
          <div className="flex items-center justify-between">
            <div>
              <p className="font-medium text-slate-900">Sign Out</p>
              <p className="text-sm text-slate-500">Sign out of your account</p>
            </div>
            <Button 
              variant="outline" 
              className="text-red-600 hover:text-red-700 hover:bg-red-50"
              onClick={() => base44.auth.logout()}
            >
              Sign Out
            </Button>
          </div>
        </CardContent>
      </Card>
    </div>
  );
}

// PURCHASE ORDERS 

import React, { useState } from 'react';
import { base44 } from '@/api/base44Client';
import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';
import PageHeader from '../components/shared/PageHeader';
import DataTable from '../components/shared/DataTable';
import StatusBadge from '../components/shared/StatusBadge';
import { usePermissions } from '../components/shared/PermissionGuard';
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Textarea } from "@/components/ui/textarea";
import { Card } from "@/components/ui/card";
import {
  Dialog,
  DialogContent,
  DialogHeader,
  DialogTitle,
} from "@/components/ui/dialog";
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from "@/components/ui/select";
import { 
  Search, 
  ShoppingCart, 
  MoreVertical, 
  Pencil, 
  Trash2, 
  Plus, 
  X, 
  CheckCircle,
  Eye 
} from 'lucide-react';
import {
  DropdownMenu,
  DropdownMenuContent,
  DropdownMenuItem,
  DropdownMenuSeparator,
  DropdownMenuTrigger,
} from "@/components/ui/dropdown-menu";
import { format } from 'date-fns';
import { toast } from "sonner";

export default function PurchaseOrders() {
  const permissions = usePermissions();
  const [isOpen, setIsOpen] = useState(false);
  const [viewOpen, setViewOpen] = useState(false);
  const [editingPO, setEditingPO] = useState(null);
  const [viewingPO, setViewingPO] = useState(null);
  const [search, setSearch] = useState('');
  const [statusFilter, setStatusFilter] = useState('all');
  const [formData, setFormData] = useState({
    supplier_id: '',
    supplier_name: '',
    order_date: format(new Date(), 'yyyy-MM-dd'),
    expected_delivery: '',
    items: [],
    tax: 0,
    notes: '',
    status: 'draft'
  });

  const queryClient = useQueryClient();

  const { data: purchaseOrders = [], isLoading } = useQuery({
    queryKey: ['purchaseOrders'],
    queryFn: () => base44.entities.PurchaseOrder.list('-created_date'),
  });

  const { data: suppliers = [] } = useQuery({
    queryKey: ['suppliers'],
    queryFn: () => base44.entities.Supplier.list(),
  });

  const { data: materials = [] } = useQuery({
    queryKey: ['rawMaterials'],
    queryFn: () => base44.entities.RawMaterial.list(),
  });

  const createMutation = useMutation({
    mutationFn: (data) => base44.entities.PurchaseOrder.create(data),
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['purchaseOrders'] });
      toast.success('Purchase order created');
      handleClose();
    },
  });

  const updateMutation = useMutation({
    mutationFn: ({ id, data }) => base44.entities.PurchaseOrder.update(id, data),
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['purchaseOrders'] });
      toast.success('Purchase order updated');
      handleClose();
    },
  });

  const deleteMutation = useMutation({
    mutationFn: (id) => base44.entities.PurchaseOrder.delete(id),
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['purchaseOrders'] });
      toast.success('Purchase order deleted');
    },
  });

  const generatePONumber = () => {
    const date = new Date();
    const prefix = 'PO';
    const year = date.getFullYear().toString().slice(-2);
    const month = (date.getMonth() + 1).toString().padStart(2, '0');
    const random = Math.floor(Math.random() * 1000).toString().padStart(3, '0');
    return `${prefix}${year}${month}-${random}`;
  };

  const handleOpen = (po = null) => {
    if (po) {
      setEditingPO(po);
      setFormData({
        supplier_id: po.supplier_id || '',
        supplier_name: po.supplier_name || '',
        order_date: po.order_date || format(new Date(), 'yyyy-MM-dd'),
        expected_delivery: po.expected_delivery || '',
        items: po.items || [],
        tax: po.tax || 0,
        notes: po.notes || '',
        status: po.status || 'draft'
      });
    } else {
      setEditingPO(null);
      setFormData({
        supplier_id: '',
        supplier_name: '',
        order_date: format(new Date(), 'yyyy-MM-dd'),
        expected_delivery: '',
        items: [],
        tax: 0,
        notes: '',
        status: 'draft'
      });
    }
    setIsOpen(true);
  };

  const handleClose = () => {
    setIsOpen(false);
    setEditingPO(null);
  };

  const handleSubmit = (e) => {
    e.preventDefault();
    const subtotal = formData.items.reduce((sum, item) => sum + (item.total || 0), 0);
    const total = subtotal + (formData.tax || 0);
    
    const data = {
      ...formData,
      po_number: editingPO?.po_number || generatePONumber(),
      subtotal,
      total_amount: total
    };

    if (editingPO) {
      updateMutation.mutate({ id: editingPO.id, data });
    } else {
      createMutation.mutate(data);
    }
  };

  const handleSupplierChange = (supplierId) => {
    const supplier = suppliers.find(s => s.id === supplierId);
    setFormData({
      ...formData,
      supplier_id: supplierId,
      supplier_name: supplier?.name || ''
    });
  };

  const addItem = () => {
    setFormData({
      ...formData,
      items: [...formData.items, { 
        material_id: '', 
        material_name: '', 
        quantity: 0, 
        unit: 'kg', 
        unit_price: 0, 
        total: 0 
      }]
    });
  };

  const updateItem = (index, field, value) => {
    const newItems = [...formData.items];
    if (field === 'material_id') {
      const material = materials.find(m => m.id === value);
      newItems[index] = {
        ...newItems[index],
        material_id: value,
        material_name: material?.name || '',
        unit: material?.unit || 'kg',
        unit_price: material?.unit_cost || 0
      };
    } else {
      newItems[index] = { ...newItems[index], [field]: value };
    }
    // Calculate total
    newItems[index].total = (newItems[index].quantity || 0) * (newItems[index].unit_price || 0);
    setFormData({ ...formData, items: newItems });
  };

  const removeItem = (index) => {
    setFormData({
      ...formData,
      items: formData.items.filter((_, i) => i !== index)
    });
  };

  const handleStatusChange = async (po, newStatus) => {
    const updates = { status: newStatus };
    if (newStatus === 'approved') {
      updates.approved_date = new Date().toISOString();
    }
    await updateMutation.mutateAsync({ id: po.id, data: updates });
  };

  const filteredOrders = purchaseOrders.filter(po => {
    const matchesSearch = po.po_number?.toLowerCase().includes(search.toLowerCase()) ||
      po.supplier_name?.toLowerCase().includes(search.toLowerCase());
    const matchesStatus = statusFilter === 'all' || po.status === statusFilter;
    return matchesSearch && matchesStatus;
  });

  const columns = [
    {
      header: 'PO Number',
      cell: (row) => (
        <div className="flex items-center gap-3">
          <div className="w-10 h-10 rounded-lg bg-blue-100 flex items-center justify-center">
            <ShoppingCart className="w-5 h-5 text-blue-600" />
          </div>
          <div>
            <p className="font-medium text-slate-900">{row.po_number || `#${row.id?.slice(-6)}`}</p>
            <p className="text-sm text-slate-500">{row.supplier_name}</p>
          </div>
        </div>
      )
    },
    {
      header: 'Date',
      cell: (row) => (
        <div>
          <p className="text-slate-900">{row.order_date ? format(new Date(row.order_date), 'MMM dd, yyyy') : '-'}</p>
          {row.expected_delivery && (
            <p className="text-xs text-slate-500">Due: {format(new Date(row.expected_delivery), 'MMM dd')}</p>
          )}
        </div>
      )
    },
    {
      header: 'Items',
      cell: (row) => (
        <span className="text-slate-600">{row.items?.length || 0} items</span>
      )
    },
    {
      header: 'Total',
      cell: (row) => (
        <span className="font-semibold text-slate-900">
          ₱{(row.total_amount || 0).toLocaleString()}
        </span>
      )
    },
    {
      header: 'Status',
      cell: (row) => <StatusBadge status={row.status} />
    },
    {
      header: '',
      className: 'w-12',
      cell: (row) => (
        <DropdownMenu>
          <DropdownMenuTrigger asChild>
            <Button variant="ghost" size="icon">
              <MoreVertical className="w-4 h-4" />
            </Button>
          </DropdownMenuTrigger>
          <DropdownMenuContent align="end">
            <DropdownMenuItem onClick={() => { setViewingPO(row); setViewOpen(true); }}>
              <Eye className="w-4 h-4 mr-2" />
              View Details
            </DropdownMenuItem>
            {permissions.canEdit && (
              <DropdownMenuItem onClick={() => handleOpen(row)}>
                <Pencil className="w-4 h-4 mr-2" />
                Edit
              </DropdownMenuItem>
            )}
            <DropdownMenuSeparator />
            {permissions.canEdit && row.status === 'draft' && (
              <DropdownMenuItem onClick={() => handleStatusChange(row, 'pending_approval')}>
                Submit for Approval
              </DropdownMenuItem>
            )}
            {permissions.canApprove && row.status === 'pending_approval' && (
              <DropdownMenuItem onClick={() => handleStatusChange(row, 'approved')}>
                <CheckCircle className="w-4 h-4 mr-2 text-green-600" />
                Approve
              </DropdownMenuItem>
            )}
            {row.status === 'approved' && (
              <DropdownMenuItem onClick={() => handleStatusChange(row, 'ordered')}>
                Mark as Ordered
              </DropdownMenuItem>
            )}
            {row.status === 'ordered' && (
              <DropdownMenuItem onClick={() => handleStatusChange(row, 'received')}>
                Mark as Received
              </DropdownMenuItem>
            )}
            {permissions.canDelete && (
              <>
                <DropdownMenuSeparator />
                <DropdownMenuItem 
                  onClick={() => deleteMutation.mutate(row.id)}
                  className="text-red-600"
                >
                  <Trash2 className="w-4 h-4 mr-2" />
                  Delete
                </DropdownMenuItem>
              </>
            )}
          </DropdownMenuContent>
        </DropdownMenu>
      )
    }
  ];

  const subtotal = formData.items.reduce((sum, item) => sum + (item.total || 0), 0);

  return (
    <div>
      <PageHeader
        title="Purchase Orders"
        description="Manage raw material purchase orders"
        action={permissions.canEdit ? () => handleOpen() : null}
        actionLabel="New Purchase Order"
      >
        <Select value={statusFilter} onValueChange={setStatusFilter}>
          <SelectTrigger className="w-44">
            <SelectValue placeholder="Status" />
          </SelectTrigger>
          <SelectContent>
            <SelectItem value="all">All Status</SelectItem>
            <SelectItem value="draft">Draft</SelectItem>
            <SelectItem value="pending_approval">Pending Approval</SelectItem>
            <SelectItem value="approved">Approved</SelectItem>
            <SelectItem value="ordered">Ordered</SelectItem>
            <SelectItem value="received">Received</SelectItem>
          </SelectContent>
        </Select>
        <div className="relative">
          <Search className="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400" />
          <Input
            placeholder="Search orders..."
            value={search}
            onChange={(e) => setSearch(e.target.value)}
            className="pl-10 w-64"
          />
        </div>
      </PageHeader>

      <DataTable
        columns={columns}
        data={filteredOrders}
        isLoading={isLoading}
        emptyMessage="No purchase orders found."
      />

      {/* Create/Edit Dialog */}
      <Dialog open={isOpen} onOpenChange={setIsOpen}>
        <DialogContent className="max-w-3xl max-h-[90vh] overflow-y-auto">
          <DialogHeader>
            <DialogTitle>
              {editingPO ? 'Edit Purchase Order' : 'New Purchase Order'}
            </DialogTitle>
          </DialogHeader>
          <form onSubmit={handleSubmit} className="space-y-6">
            <div className="grid grid-cols-2 gap-4">
              <div className="col-span-2 md:col-span-1">
                <Label>Supplier *</Label>
                <Select
                  value={formData.supplier_id}
                  onValueChange={handleSupplierChange}
                >
                  <SelectTrigger>
                    <SelectValue placeholder="Select supplier" />
                  </SelectTrigger>
                  <SelectContent>
                    {suppliers.map(s => (
                      <SelectItem key={s.id} value={s.id}>{s.name}</SelectItem>
                    ))}
                  </SelectContent>
                </Select>
              </div>
              <div>
                <Label>Order Date</Label>
                <Input
                  type="date"
                  value={formData.order_date}
                  onChange={(e) => setFormData({ ...formData, order_date: e.target.value })}
                />
              </div>
              <div>
                <Label>Expected Delivery</Label>
                <Input
                  type="date"
                  value={formData.expected_delivery}
                  onChange={(e) => setFormData({ ...formData, expected_delivery: e.target.value })}
                />
              </div>
            </div>

            {/* Items */}
            <div>
              <div className="flex items-center justify-between mb-3">
                <Label className="text-base">Order Items</Label>
                <Button type="button" variant="outline" size="sm" onClick={addItem}>
                  <Plus className="w-4 h-4 mr-1" />
                  Add Item
                </Button>
              </div>
              {formData.items.length === 0 ? (
                <Card className="p-4 text-center text-slate-500 border-dashed">
                  No items added. Click "Add Item" to start.
                </Card>
              ) : (
                <div className="space-y-2">
                  {formData.items.map((item, index) => (
                    <Card key={index} className="p-3">
                      <div className="flex items-center gap-3 flex-wrap">
                        <div className="flex-1 min-w-[200px]">
                          <Select
                            value={item.material_id}
                            onValueChange={(value) => updateItem(index, 'material_id', value)}
                          >
                            <SelectTrigger>
                              <SelectValue placeholder="Select material" />
                            </SelectTrigger>
                            <SelectContent>
                              {materials.map(m => (
                                <SelectItem key={m.id} value={m.id}>{m.name}</SelectItem>
                              ))}
                            </SelectContent>
                          </Select>
                        </div>
                        <Input
                          type="number"
                          placeholder="Qty"
                          className="w-20"
                          value={item.quantity}
                          onChange={(e) => updateItem(index, 'quantity', parseFloat(e.target.value) || 0)}
                        />
                        <span className="text-sm text-slate-500 w-10">{item.unit}</span>
                        <Input
                          type="number"
                          placeholder="Price"
                          className="w-24"
                          step="0.01"
                          value={item.unit_price}
                          onChange={(e) => updateItem(index, 'unit_price', parseFloat(e.target.value) || 0)}
                        />
                        <span className="font-medium text-slate-900 w-20 text-right">
                          ₱{(item.total || 0).toFixed(2)}
                        </span>
                        <Button
                          type="button"
                          variant="ghost"
                          size="icon"
                          onClick={() => removeItem(index)}
                        >
                          <X className="w-4 h-4 text-red-500" />
                        </Button>
                      </div>
                    </Card>
                  ))}
                </div>
              )}
            </div>

            {/* Totals */}
            <Card className="p-4 bg-slate-50">
              <div className="space-y-2">
                <div className="flex justify-between">
                  <span className="text-slate-600">Subtotal</span>
                  <span className="font-medium">₱{subtotal.toFixed(2)}</span>
                </div>
                <div className="flex justify-between items-center">
                  <span className="text-slate-600">Tax</span>
                  <Input
                    type="number"
                    step="0.01"
                    className="w-24 text-right"
                    value={formData.tax}
                    onChange={(e) => setFormData({ ...formData, tax: parseFloat(e.target.value) || 0 })}
                  />
                </div>
                <div className="flex justify-between border-t pt-2">
                  <span className="font-semibold">Total</span>
                  <span className="font-bold text-lg">₱{(subtotal + (formData.tax || 0)).toFixed(2)}</span>
                </div>
              </div>
            </Card>

            <div>
              <Label>Notes</Label>
              <Textarea
                value={formData.notes}
                onChange={(e) => setFormData({ ...formData, notes: e.target.value })}
                rows={2}
              />
            </div>

            <div className="flex justify-end gap-3 pt-4">
              <Button type="button" variant="outline" onClick={handleClose}>
                Cancel
              </Button>
              <Button 
                type="submit" 
                className="bg-emerald-600 hover:bg-emerald-700"
                disabled={createMutation.isPending || updateMutation.isPending}
              >
                {editingPO ? 'Update' : 'Create'} Order
              </Button>
            </div>
          </form>
        </DialogContent>
      </Dialog>

      {/* View Dialog */}
      <Dialog open={viewOpen} onOpenChange={setViewOpen}>
        <DialogContent className="max-w-2xl max-h-[90vh] overflow-y-auto">
          <DialogHeader>
            <DialogTitle>
              Purchase Order: {viewingPO?.po_number}
            </DialogTitle>
          </DialogHeader>
          {viewingPO && (
            <div className="space-y-6">
              <div className="grid grid-cols-2 gap-4">
                <div>
                  <p className="text-sm text-slate-500">Supplier</p>
                  <p className="font-medium">{viewingPO.supplier_name}</p>
                </div>
                <div>
                  <p className="text-sm text-slate-500">Status</p>
                  <StatusBadge status={viewingPO.status} />
                </div>
                <div>
                  <p className="text-sm text-slate-500">Order Date</p>
                  <p className="font-medium">{viewingPO.order_date ? format(new Date(viewingPO.order_date), 'MMM dd, yyyy') : '-'}</p>
                </div>
                <div>
                  <p className="text-sm text-slate-500">Expected Delivery</p>
                  <p className="font-medium">{viewingPO.expected_delivery ? format(new Date(viewingPO.expected_delivery), 'MMM dd, yyyy') : '-'}</p>
                </div>
              </div>

              <div>
                <h4 className="font-medium mb-3">Items</h4>
                <div className="space-y-2">
                  {viewingPO.items?.map((item, i) => (
                    <div key={i} className="flex justify-between p-3 bg-slate-50 rounded-lg">
                      <div>
                        <p className="font-medium">{item.material_name}</p>
                        <p className="text-sm text-slate-500">{item.quantity} {item.unit} @ ₱{item.unit_price}</p>
                      </div>
                      <p className="font-medium">₱{item.total?.toFixed(2)}</p>
                    </div>
                  ))}
                </div>
              </div>

              <div className="border-t pt-4">
                <div className="flex justify-between mb-2">
                  <span className="text-slate-600">Subtotal</span>
                  <span>₱{viewingPO.subtotal?.toFixed(2)}</span>
                </div>
                <div className="flex justify-between mb-2">
                  <span className="text-slate-600">Tax</span>
                  <span>₱{viewingPO.tax?.toFixed(2)}</span>
                </div>
                <div className="flex justify-between font-bold">
                  <span>Total</span>
                  <span>₱{viewingPO.total_amount?.toFixed(2)}</span>
                </div>
              </div>

              {viewingPO.notes && (
                <div>
                  <p className="text-sm text-slate-500">Notes</p>
                  <p className="text-slate-700">{viewingPO.notes}</p>
                </div>
              )}
            </div>
          )}
        </DialogContent>
      </Dialog>
    </div>
  );
}

//RAW MATERIALS*****
import React, { useState } from 'react';
import { base44 } from '@/api/base44Client';
import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';
import PageHeader from '../components/shared/PageHeader';
import DataTable from '../components/shared/DataTable';
import StatusBadge from '../components/shared/StatusBadge';
import { usePermissions } from '../components/shared/PermissionGuard';
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import {
  Dialog,
  DialogContent,
  DialogHeader,
  DialogTitle,
} from "@/components/ui/dialog";
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from "@/components/ui/select";
import { Search, Package, MoreVertical, Pencil, Trash2, AlertTriangle } from 'lucide-react';
import {
  DropdownMenu,
  DropdownMenuContent,
  DropdownMenuItem,
  DropdownMenuTrigger,
} from "@/components/ui/dropdown-menu";
import { Badge } from "@/components/ui/badge";
import { toast } from "sonner";

const CATEGORIES = [
  { value: 'ingredients', label: 'Ingredients' },
  { value: 'packaging', label: 'Packaging' },
  { value: 'additives', label: 'Additives' },
  { value: 'flavorings', label: 'Flavorings' },
  { value: 'preservatives', label: 'Preservatives' },
  { value: 'other', label: 'Other' }
];

const UNITS = ['kg', 'g', 'l', 'ml', 'pcs', 'box', 'pallet'];
const STORAGE = ['ambient', 'refrigerated', 'frozen'];

export default function RawMaterials() {
  const permissions = usePermissions();
  const [isOpen, setIsOpen] = useState(false);
  const [editingMaterial, setEditingMaterial] = useState(null);
  const [search, setSearch] = useState('');
  const [categoryFilter, setCategoryFilter] = useState('all');
  const [formData, setFormData] = useState({
    name: '',
    sku: '',
    category: 'ingredients',
    unit: 'kg',
    current_stock: 0,
    minimum_stock: 0,
    unit_cost: 0,
    preferred_supplier_id: '',
    shelf_life_days: 30,
    storage_requirements: 'ambient',
    status: 'active'
  });

  const queryClient = useQueryClient();

  const { data: materials = [], isLoading } = useQuery({
    queryKey: ['rawMaterials'],
    queryFn: () => base44.entities.RawMaterial.list('-created_date'),
  });

  const { data: suppliers = [] } = useQuery({
    queryKey: ['suppliers'],
    queryFn: () => base44.entities.Supplier.list(),
  });

  const createMutation = useMutation({
    mutationFn: (data) => base44.entities.RawMaterial.create(data),
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['rawMaterials'] });
      toast.success('Material created successfully');
      handleClose();
    },
  });

  const updateMutation = useMutation({
    mutationFn: ({ id, data }) => base44.entities.RawMaterial.update(id, data),
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['rawMaterials'] });
      toast.success('Material updated successfully');
      handleClose();
    },
  });

  const deleteMutation = useMutation({
    mutationFn: (id) => base44.entities.RawMaterial.delete(id),
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['rawMaterials'] });
      toast.success('Material deleted successfully');
    },
  });

  const handleOpen = (material = null) => {
    if (material) {
      setEditingMaterial(material);
      setFormData({
        name: material.name || '',
        sku: material.sku || '',
        category: material.category || 'ingredients',
        unit: material.unit || 'kg',
        current_stock: material.current_stock || 0,
        minimum_stock: material.minimum_stock || 0,
        unit_cost: material.unit_cost || 0,
        preferred_supplier_id: material.preferred_supplier_id || '',
        shelf_life_days: material.shelf_life_days || 30,
        storage_requirements: material.storage_requirements || 'ambient',
        status: material.status || 'active'
      });
    } else {
      setEditingMaterial(null);
      setFormData({
        name: '',
        sku: '',
        category: 'ingredients',
        unit: 'kg',
        current_stock: 0,
        minimum_stock: 0,
        unit_cost: 0,
        preferred_supplier_id: '',
        shelf_life_days: 30,
        storage_requirements: 'ambient',
        status: 'active'
      });
    }
    setIsOpen(true);
  };

  const handleClose = () => {
    setIsOpen(false);
    setEditingMaterial(null);
  };

  const handleSubmit = (e) => {
    e.preventDefault();
    if (editingMaterial) {
      updateMutation.mutate({ id: editingMaterial.id, data: formData });
    } else {
      createMutation.mutate(formData);
    }
  };

  const filteredMaterials = materials.filter(m => {
    const matchesSearch = m.name?.toLowerCase().includes(search.toLowerCase()) ||
      m.sku?.toLowerCase().includes(search.toLowerCase());
    const matchesCategory = categoryFilter === 'all' || m.category === categoryFilter;
    return matchesSearch && matchesCategory;
  });

  const columns = [
    {
      header: 'Material',
      cell: (row) => (
        <div className="flex items-center gap-3">
          <div className={`w-10 h-10 rounded-lg flex items-center justify-center ${
            (row.current_stock || 0) <= (row.minimum_stock || 0) 
              ? 'bg-red-100' 
              : 'bg-blue-100'
          }`}>
            {(row.current_stock || 0) <= (row.minimum_stock || 0) ? (
              <AlertTriangle className="w-5 h-5 text-red-600" />
            ) : (
              <Package className="w-5 h-5 text-blue-600" />
            )}
          </div>
          <div>
            <p className="font-medium text-slate-900">{row.name}</p>
            <p className="text-sm text-slate-500">{row.sku}</p>
          </div>
        </div>
      )
    },
    {
      header: 'Category',
      cell: (row) => (
        <Badge variant="outline" className="capitalize">
          {row.category?.replace(/_/g, ' ')}
        </Badge>
      )
    },
    {
      header: 'Stock',
      cell: (row) => (
        <div>
          <p className={`font-medium ${
            (row.current_stock || 0) <= (row.minimum_stock || 0) 
              ? 'text-red-600' 
              : 'text-slate-900'
          }`}>
            {row.current_stock || 0} {row.unit}
          </p>
          <p className="text-xs text-slate-500">Min: {row.minimum_stock || 0} {row.unit}</p>
        </div>
      )
    },
    {
      header: 'Unit Cost',
      cell: (row) => (
        <span className="font-medium text-slate-900">
          ₱{(row.unit_cost || 0).toFixed(2)}
        </span>
      )
    },
    {
      header: 'Storage',
      cell: (row) => (
        <span className="text-sm text-slate-600 capitalize">
          {row.storage_requirements}
        </span>
      )
    },
    {
      header: 'Status',
      cell: (row) => <StatusBadge status={row.status} />
    },
    {
      header: '',
      className: 'w-12',
      cell: (row) => (
        <DropdownMenu>
          <DropdownMenuTrigger asChild>
            <Button variant="ghost" size="icon">
              <MoreVertical className="w-4 h-4" />
            </Button>
          </DropdownMenuTrigger>
          <DropdownMenuContent align="end">
            <DropdownMenuItem onClick={() => handleOpen(row)}>
              <Pencil className="w-4 h-4 mr-2" />
              Edit
            </DropdownMenuItem>
            <DropdownMenuItem 
              onClick={() => deleteMutation.mutate(row.id)}
              className="text-red-600"
            >
              <Trash2 className="w-4 h-4 mr-2" />
              Delete
            </DropdownMenuItem>
          </DropdownMenuContent>
        </DropdownMenu>
      )
    }
  ];

  return (
    <div>
      <PageHeader
        title="Raw Materials"
        description="Manage your inventory of raw materials"
        action={permissions.canEdit ? () => handleOpen() : null}
        actionLabel="Add Material"
      >
        <Select value={categoryFilter} onValueChange={setCategoryFilter}>
          <SelectTrigger className="w-40">
            <SelectValue placeholder="Category" />
          </SelectTrigger>
          <SelectContent>
            <SelectItem value="all">All Categories</SelectItem>
            {CATEGORIES.map(cat => (
              <SelectItem key={cat.value} value={cat.value}>{cat.label}</SelectItem>
            ))}
          </SelectContent>
        </Select>
        <div className="relative">
          <Search className="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400" />
          <Input
            placeholder="Search materials..."
            value={search}
            onChange={(e) => setSearch(e.target.value)}
            className="pl-10 w-64"
          />
        </div>
      </PageHeader>

      <DataTable
        columns={columns}
        data={filteredMaterials}
        isLoading={isLoading}
        emptyMessage="No materials found. Add your first raw material to get started."
      />

      <Dialog open={isOpen} onOpenChange={setIsOpen}>
        <DialogContent className="max-w-lg">
          <DialogHeader>
            <DialogTitle>
              {editingMaterial ? 'Edit Material' : 'Add New Material'}
            </DialogTitle>
          </DialogHeader>
          <form onSubmit={handleSubmit} className="space-y-4">
            <div className="grid grid-cols-2 gap-4">
              <div className="col-span-2">
                <Label>Material Name *</Label>
                <Input
                  value={formData.name}
                  onChange={(e) => setFormData({ ...formData, name: e.target.value })}
                  required
                />
              </div>
              <div>
                <Label>SKU *</Label>
                <Input
                  value={formData.sku}
                  onChange={(e) => setFormData({ ...formData, sku: e.target.value })}
                  required
                />
              </div>
              <div>
                <Label>Category</Label>
                <Select
                  value={formData.category}
                  onValueChange={(value) => setFormData({ ...formData, category: value })}
                >
                  <SelectTrigger>
                    <SelectValue />
                  </SelectTrigger>
                  <SelectContent>
                    {CATEGORIES.map(cat => (
                      <SelectItem key={cat.value} value={cat.value}>{cat.label}</SelectItem>
                    ))}
                  </SelectContent>
                </Select>
              </div>
              <div>
                <Label>Unit</Label>
                <Select
                  value={formData.unit}
                  onValueChange={(value) => setFormData({ ...formData, unit: value })}
                >
                  <SelectTrigger>
                    <SelectValue />
                  </SelectTrigger>
                  <SelectContent>
                    {UNITS.map(u => (
                      <SelectItem key={u} value={u}>{u}</SelectItem>
                    ))}
                  </SelectContent>
                </Select>
              </div>
              <div>
                <Label>Unit Cost (₱)</Label>
                <Input
                  type="number"
                  step="0.01"
                  min="0"
                  value={formData.unit_cost}
                  onChange={(e) => setFormData({ ...formData, unit_cost: parseFloat(e.target.value) || 0 })}
                />
              </div>
              <div>
                <Label>Minimum Stock Level</Label>
                <Input
                  type="number"
                  min="0"
                  value={formData.minimum_stock}
                  onChange={(e) => setFormData({ ...formData, minimum_stock: parseFloat(e.target.value) || 0 })}
                />
              </div>
              <div>
                <Label>Shelf Life (days)</Label>
                <Input
                  type="number"
                  min="1"
                  value={formData.shelf_life_days}
                  onChange={(e) => setFormData({ ...formData, shelf_life_days: parseInt(e.target.value) || 30 })}
                />
              </div>
              <div>
                <Label>Storage</Label>
                <Select
                  value={formData.storage_requirements}
                  onValueChange={(value) => setFormData({ ...formData, storage_requirements: value })}
                >
                  <SelectTrigger>
                    <SelectValue />
                  </SelectTrigger>
                  <SelectContent>
                    {STORAGE.map(s => (
                      <SelectItem key={s} value={s} className="capitalize">{s}</SelectItem>
                    ))}
                  </SelectContent>
                </Select>
              </div>
              <div>
                <Label>Preferred Supplier</Label>
                <Select
                  value={formData.preferred_supplier_id}
                  onValueChange={(value) => setFormData({ ...formData, preferred_supplier_id: value })}
                >
                  <SelectTrigger>
                    <SelectValue placeholder="Select supplier" />
                  </SelectTrigger>
                  <SelectContent>
                    <SelectItem value={null}>None</SelectItem>
                    {suppliers.map(s => (
                      <SelectItem key={s.id} value={s.id}>{s.name}</SelectItem>
                    ))}
                  </SelectContent>
                </Select>
              </div>
              <div>
                <Label>Status</Label>
                <Select
                  value={formData.status}
                  onValueChange={(value) => setFormData({ ...formData, status: value })}
                >
                  <SelectTrigger>
                    <SelectValue />
                  </SelectTrigger>
                  <SelectContent>
                    <SelectItem value="active">Active</SelectItem>
                    <SelectItem value="discontinued">Discontinued</SelectItem>
                    <SelectItem value="pending_approval">Pending Approval</SelectItem>
                  </SelectContent>
                </Select>
              </div>
            </div>
            <div className="flex justify-end gap-3 pt-4">
              <Button type="button" variant="outline" onClick={handleClose}>
                Cancel
              </Button>
              <Button 
                type="submit" 
                className="bg-emerald-600 hover:bg-emerald-700"
                disabled={createMutation.isPending || updateMutation.isPending}
              >
                {editingMaterial ? 'Update' : 'Create'} Material
              </Button>
            </div>
          </form>
        </DialogContent>
      </Dialog>
    </div>
  );
}

// RAW MATERIALS INVENTORY
import React, { useState } from 'react';
import { base44 } from '@/api/base44Client';
import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';
import PageHeader from '../components/shared/PageHeader';
import DataTable from '../components/shared/DataTable';
import { usePermissions } from '../components/shared/PermissionGuard';
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Textarea } from "@/components/ui/textarea";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import {
  Dialog,
  DialogContent,
  DialogHeader,
  DialogTitle,
} from "@/components/ui/dialog";
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from "@/components/ui/select";
import { Search, Package, AlertTriangle, Plus, Minus, RefreshCw } from 'lucide-react';
import { Badge } from "@/components/ui/badge";
import { Progress } from "@/components/ui/progress";
import { toast } from "sonner";

export default function RawMaterialsInventory() {
  const permissions = usePermissions();
  const [adjustOpen, setAdjustOpen] = useState(false);
  const [selectedMaterial, setSelectedMaterial] = useState(null);
  const [search, setSearch] = useState('');
  const [stockFilter, setStockFilter] = useState('all');
  const [adjustData, setAdjustData] = useState({
    adjustment_type: 'add',
    quantity: 0,
    reason: ''
  });

  const queryClient = useQueryClient();

  const { data: materials = [], isLoading } = useQuery({
    queryKey: ['rawMaterials'],
    queryFn: () => base44.entities.RawMaterial.list(),
  });

  const updateMaterialMutation = useMutation({
    mutationFn: ({ id, data }) => base44.entities.RawMaterial.update(id, data),
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['rawMaterials'] });
    },
  });

  const createTransactionMutation = useMutation({
    mutationFn: (data) => base44.entities.InventoryTransaction.create(data),
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['inventoryTransactions'] });
    },
  });

  const handleAdjust = (material) => {
    setSelectedMaterial(material);
    setAdjustData({
      adjustment_type: 'add',
      quantity: 0,
      reason: ''
    });
    setAdjustOpen(true);
  };

  const handleAdjustSubmit = async (e) => {
    e.preventDefault();
    
    const currentStock = selectedMaterial.current_stock || 0;
    const adjustQty = adjustData.quantity || 0;
    const newStock = adjustData.adjustment_type === 'add' 
      ? currentStock + adjustQty 
      : currentStock - adjustQty;

    if (newStock < 0) {
      toast.error('Cannot reduce stock below 0');
      return;
    }

    // Update material stock
    await updateMaterialMutation.mutateAsync({
      id: selectedMaterial.id,
      data: { current_stock: newStock }
    });

    // Create transaction record
    await createTransactionMutation.mutateAsync({
      transaction_type: adjustData.adjustment_type === 'add' ? 'receipt' : 'issue',
      item_type: 'raw_material',
      item_id: selectedMaterial.id,
      item_name: selectedMaterial.name,
      quantity: adjustQty,
      unit: selectedMaterial.unit,
      reference_type: 'manual',
      before_quantity: currentStock,
      after_quantity: newStock,
      unit_cost: selectedMaterial.unit_cost || 0,
      total_value: adjustQty * (selectedMaterial.unit_cost || 0),
      reason: adjustData.reason
    });

    toast.success('Stock adjusted successfully');
    setAdjustOpen(false);
  };

  const getStockLevel = (material) => {
    const current = material.current_stock || 0;
    const minimum = material.minimum_stock || 0;
    if (current <= 0) return 'out';
    if (current <= minimum) return 'low';
    if (current <= minimum * 1.5) return 'warning';
    return 'healthy';
  };

  const filteredMaterials = materials.filter(m => {
    const matchesSearch = m.name?.toLowerCase().includes(search.toLowerCase()) ||
      m.sku?.toLowerCase().includes(search.toLowerCase());
    const stockLevel = getStockLevel(m);
    const matchesStock = stockFilter === 'all' || 
      (stockFilter === 'low' && ['low', 'out'].includes(stockLevel)) ||
      (stockFilter === 'healthy' && stockLevel === 'healthy');
    return matchesSearch && matchesStock;
  });

  // Stats
  const totalItems = materials.length;
  const lowStockItems = materials.filter(m => getStockLevel(m) === 'low' || getStockLevel(m) === 'out').length;
  const totalValue = materials.reduce((sum, m) => sum + ((m.current_stock || 0) * (m.unit_cost || 0)), 0);

  const columns = [
    {
      header: 'Material',
      cell: (row) => {
        const stockLevel = getStockLevel(row);
        return (
          <div className="flex items-center gap-3">
            <div className={`w-10 h-10 rounded-lg flex items-center justify-center ${
              stockLevel === 'out' || stockLevel === 'low' ? 'bg-red-100' : 
              stockLevel === 'warning' ? 'bg-amber-100' : 'bg-emerald-100'
            }`}>
              {stockLevel === 'out' || stockLevel === 'low' ? (
                <AlertTriangle className="w-5 h-5 text-red-600" />
              ) : (
                <Package className={`w-5 h-5 ${stockLevel === 'warning' ? 'text-amber-600' : 'text-emerald-600'}`} />
              )}
            </div>
            <div>
              <p className="font-medium text-slate-900">{row.name}</p>
              <p className="text-sm text-slate-500">{row.sku}</p>
            </div>
          </div>
        );
      }
    },
    {
      header: 'Category',
      cell: (row) => (
        <Badge variant="outline" className="capitalize">
          {row.category?.replace(/_/g, ' ')}
        </Badge>
      )
    },
    {
      header: 'Stock Level',
      cell: (row) => {
        const current = row.current_stock || 0;
        const minimum = row.minimum_stock || 1;
        const percentage = Math.min((current / (minimum * 2)) * 100, 100);
        const stockLevel = getStockLevel(row);
        
        return (
          <div className="w-32">
            <div className="flex justify-between text-sm mb-1">
              <span className={`font-medium ${
                stockLevel === 'out' || stockLevel === 'low' ? 'text-red-600' : 'text-slate-900'
              }`}>
                {current} {row.unit}
              </span>
            </div>
            <Progress 
              value={percentage} 
              className={`h-2 ${
                stockLevel === 'out' || stockLevel === 'low' ? '[&>div]:bg-red-500' : 
                stockLevel === 'warning' ? '[&>div]:bg-amber-500' : '[&>div]:bg-emerald-500'
              }`}
            />
            <p className="text-xs text-slate-500 mt-1">Min: {minimum} {row.unit}</p>
          </div>
        );
      }
    },
    {
      header: 'Unit Cost',
      cell: (row) => (
        <span className="font-medium">₱{(row.unit_cost || 0).toFixed(2)}</span>
      )
    },
    {
      header: 'Total Value',
      cell: (row) => (
        <span className="font-semibold text-slate-900">
          ₱{((row.current_stock || 0) * (row.unit_cost || 0)).toFixed(2)}
        </span>
      )
    },
    {
      header: 'Storage',
      cell: (row) => (
        <Badge variant="outline" className="capitalize">
          {row.storage_requirements}
        </Badge>
      )
    },
    {
      header: '',
      cell: (row) => (
        permissions.canEdit ? (
          <Button 
            variant="outline" 
            size="sm"
            onClick={() => handleAdjust(row)}
          >
            <RefreshCw className="w-4 h-4 mr-1" />
            Adjust
          </Button>
        ) : null
      )
    }
  ];

  return (
    <div>
      <PageHeader
        title="Raw Materials Inventory"
        description="Monitor and adjust raw material stock levels"
      >
        <Select value={stockFilter} onValueChange={setStockFilter}>
          <SelectTrigger className="w-36">
            <SelectValue placeholder="Stock" />
          </SelectTrigger>
          <SelectContent>
            <SelectItem value="all">All Stock</SelectItem>
            <SelectItem value="low">Low Stock</SelectItem>
            <SelectItem value="healthy">Healthy</SelectItem>
          </SelectContent>
        </Select>
        <div className="relative">
          <Search className="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400" />
          <Input
            placeholder="Search materials..."
            value={search}
            onChange={(e) => setSearch(e.target.value)}
            className="pl-10 w-64"
          />
        </div>
      </PageHeader>

      {/* Summary Cards */}
      <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
        <Card>
          <CardContent className="pt-6">
            <div className="flex justify-between">
              <div>
                <p className="text-sm text-slate-500">Total Items</p>
                <p className="text-2xl font-bold text-slate-900">{totalItems}</p>
              </div>
              <div className="w-10 h-10 rounded-lg bg-blue-100 flex items-center justify-center">
                <Package className="w-5 h-5 text-blue-600" />
              </div>
            </div>
          </CardContent>
        </Card>
        <Card>
          <CardContent className="pt-6">
            <div className="flex justify-between">
              <div>
                <p className="text-sm text-slate-500">Low Stock Items</p>
                <p className="text-2xl font-bold text-red-600">{lowStockItems}</p>
              </div>
              <div className="w-10 h-10 rounded-lg bg-red-100 flex items-center justify-center">
                <AlertTriangle className="w-5 h-5 text-red-600" />
              </div>
            </div>
          </CardContent>
        </Card>
        <Card>
          <CardContent className="pt-6">
            <div className="flex justify-between">
              <div>
                <p className="text-sm text-slate-500">Total Inventory Value</p>
                <p className="text-2xl font-bold text-slate-900">₱{totalValue.toLocaleString()}</p>
              </div>
              <div className="w-10 h-10 rounded-lg bg-emerald-100 flex items-center justify-center">
                <Package className="w-5 h-5 text-emerald-600" />
              </div>
            </div>
          </CardContent>
        </Card>
      </div>

      <DataTable
        columns={columns}
        data={filteredMaterials}
        isLoading={isLoading}
        emptyMessage="No materials found."
      />

      {/* Stock Adjustment Dialog */}
      <Dialog open={adjustOpen} onOpenChange={setAdjustOpen}>
        <DialogContent className="max-w-md">
          <DialogHeader>
            <DialogTitle>Adjust Stock: {selectedMaterial?.name}</DialogTitle>
          </DialogHeader>
          <form onSubmit={handleAdjustSubmit} className="space-y-4">
            <div className="p-3 bg-slate-50 rounded-lg">
              <p className="text-sm text-slate-500">Current Stock</p>
              <p className="font-semibold text-lg">
                {selectedMaterial?.current_stock || 0} {selectedMaterial?.unit}
              </p>
            </div>
            
            <div>
              <Label>Adjustment Type</Label>
              <Select
                value={adjustData.adjustment_type}
                onValueChange={(value) => setAdjustData({ ...adjustData, adjustment_type: value })}
              >
                <SelectTrigger>
                  <SelectValue />
                </SelectTrigger>
                <SelectContent>
                  <SelectItem value="add">
                    <span className="flex items-center gap-2">
                      <Plus className="w-4 h-4 text-green-600" />
                      Add Stock
                    </span>
                  </SelectItem>
                  <SelectItem value="remove">
                    <span className="flex items-center gap-2">
                      <Minus className="w-4 h-4 text-red-600" />
                      Remove Stock
                    </span>
                  </SelectItem>
                </SelectContent>
              </Select>
            </div>
            <div>
              <Label>Quantity ({selectedMaterial?.unit})</Label>
              <Input
                type="number"
                min="0"
                step="0.01"
                value={adjustData.quantity}
                onChange={(e) => setAdjustData({ ...adjustData, quantity: parseFloat(e.target.value) || 0 })}
              />
            </div>
            <div>
              <Label>Reason</Label>
              <Textarea
                value={adjustData.reason}
                onChange={(e) => setAdjustData({ ...adjustData, reason: e.target.value })}
                rows={2}
                placeholder="e.g., Received from supplier, Used in production..."
              />
            </div>

            <div className="p-3 bg-blue-50 rounded-lg">
              <p className="text-sm text-slate-500">New Stock Level</p>
              <p className="font-semibold text-lg text-blue-600">
                {adjustData.adjustment_type === 'add' 
                  ? (selectedMaterial?.current_stock || 0) + (adjustData.quantity || 0)
                  : (selectedMaterial?.current_stock || 0) - (adjustData.quantity || 0)
                } {selectedMaterial?.unit}
              </p>
            </div>

            <div className="flex justify-end gap-3 pt-4">
              <Button type="button" variant="outline" onClick={() => setAdjustOpen(false)}>
                Cancel
              </Button>
              <Button 
                type="submit" 
                className="bg-emerald-600 hover:bg-emerald-700"
                disabled={updateMaterialMutation.isPending}
              >
                Confirm Adjustment
              </Button>
            </div>
          </form>
        </DialogContent>
      </Dialog>
    </div>
  );
}

//SALES ORDERS
import React, { useState } from 'react';
import { base44 } from '@/api/base44Client';
import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';
import { Link } from 'react-router-dom';
import { createPageUrl } from '../utils';
import PageHeader from '../components/shared/PageHeader';
import DataTable from '../components/shared/DataTable';
import StatusBadge from '../components/shared/StatusBadge';
import { usePermissions } from '../components/shared/PermissionGuard';
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import {
  Dialog,
  DialogContent,
  DialogHeader,
  DialogTitle,
} from "@/components/ui/dialog";
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from "@/components/ui/select";
import { 
  Search, 
  ShoppingCart, 
  MoreVertical, 
  Eye,
  Pencil, 
  Trash2,
  CheckCircle,
  Truck,
  Package,
  Ban
} from 'lucide-react';
import { Label } from "@/components/ui/label";
import {
  DropdownMenu,
  DropdownMenuContent,
  DropdownMenuItem,
  DropdownMenuSeparator,
  DropdownMenuTrigger,
} from "@/components/ui/dropdown-menu";
import { format } from 'date-fns';
import { toast } from "sonner";

export default function SalesOrders() {
  const permissions = usePermissions();
  const [viewOpen, setViewOpen] = useState(false);
  const [viewingOrder, setViewingOrder] = useState(null);
  const [editedOrder, setEditedOrder] = useState(null);
  const [search, setSearch] = useState('');
  const [statusFilter, setStatusFilter] = useState('all');

  const queryClient = useQueryClient();

  const { data: orders = [], isLoading } = useQuery({
    queryKey: ['salesOrders'],
    queryFn: () => base44.entities.SalesOrder.list('-created_date'),
  });

  const updateMutation = useMutation({
    mutationFn: ({ id, data }) => base44.entities.SalesOrder.update(id, data),
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['salesOrders'] });
      toast.success('Order updated');
    },
  });

  const deleteMutation = useMutation({
    mutationFn: (id) => base44.entities.SalesOrder.delete(id),
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['salesOrders'] });
      toast.success('Order deleted');
    },
  });

  const handleStatusChange = async (order, newStatus) => {
    const updates = { status: newStatus };
    if (newStatus === 'approved') {
      updates.approved_by = 'current_user'; // Would be actual user
    }
    await updateMutation.mutateAsync({ id: order.id, data: updates });
  };

  const handlePaymentStatus = async (order, newStatus) => {
    await updateMutation.mutateAsync({ id: order.id, data: { payment_status: newStatus } });
  };

  const filteredOrders = orders.filter(o => {
    const matchesSearch = o.order_number?.toLowerCase().includes(search.toLowerCase()) ||
      o.customer_name?.toLowerCase().includes(search.toLowerCase());
    const matchesStatus = statusFilter === 'all' || o.status === statusFilter;
    return matchesSearch && matchesStatus;
  });

  const columns = [
    {
      header: 'Order',
      cell: (row) => (
        <div className="flex items-center gap-3">
          <div className={`w-10 h-10 rounded-lg flex items-center justify-center ${
            row.status === 'delivered' ? 'bg-emerald-100' : 
            row.status === 'dispatched' ? 'bg-blue-100' : 'bg-amber-100'
          }`}>
            <ShoppingCart className={`w-5 h-5 ${
              row.status === 'delivered' ? 'text-emerald-600' : 
              row.status === 'dispatched' ? 'text-blue-600' : 'text-amber-600'
            }`} />
          </div>
          <div>
            <p className="font-medium text-slate-900">{row.order_number || `#${row.id?.slice(-6)}`}</p>
            <p className="text-sm text-slate-500">{row.customer_name}</p>
          </div>
        </div>
      )
    },
    {
      header: 'Date',
      cell: (row) => (
        <div>
          <p className="text-slate-900">{row.order_date ? format(new Date(row.order_date), 'MMM dd, yyyy') : '-'}</p>
          {row.requested_delivery_date && (
            <p className="text-xs text-slate-500">
              Delivery: {format(new Date(row.requested_delivery_date), 'MMM dd')}
            </p>
          )}
        </div>
      )
    },
    {
      header: 'Type',
      cell: (row) => (
        <span className="text-sm text-slate-600 capitalize">{row.order_type}</span>
      )
    },
    {
      header: 'Items',
      cell: (row) => (
        <span className="text-slate-600">{row.items?.length || 0} items</span>
      )
    },
    {
      header: 'Total',
      cell: (row) => (
        <span className="font-semibold text-slate-900">
          ₱{(row.total_amount || 0).toLocaleString()}
        </span>
      )
    },
    {
      header: 'Payment',
      cell: (row) => <StatusBadge status={row.payment_status} />
    },
    {
      header: 'Status',
      cell: (row) => <StatusBadge status={row.status} />
    },
    {
      header: '',
      className: 'w-12',
      cell: (row) => (
        <DropdownMenu>
          <DropdownMenuTrigger asChild>
            <Button variant="ghost" size="icon">
              <MoreVertical className="w-4 h-4" />
            </Button>
          </DropdownMenuTrigger>
          <DropdownMenuContent align="end">
            <DropdownMenuItem onClick={() => { setViewingOrder(row); setEditedOrder(row); setViewOpen(true); }}>
              <Eye className="w-4 h-4 mr-2" />
              View Details
            </DropdownMenuItem>
            <DropdownMenuSeparator />
            {row.status === 'draft' && (
              <DropdownMenuItem onClick={() => handleStatusChange(row, 'pending_approval')}>
                Submit for Approval
              </DropdownMenuItem>
            )}
            {permissions.canApprove && row.status === 'pending_approval' && (
              <DropdownMenuItem onClick={() => handleStatusChange(row, 'approved')}>
                <CheckCircle className="w-4 h-4 mr-2 text-green-600" />
                Approve
              </DropdownMenuItem>
            )}
            {row.status === 'approved' && (
              <DropdownMenuItem onClick={() => handleStatusChange(row, 'processing')}>
                <Package className="w-4 h-4 mr-2" />
                Start Processing
              </DropdownMenuItem>
            )}
            {row.status === 'processing' && (
              <DropdownMenuItem onClick={() => handleStatusChange(row, 'ready')}>
                <Package className="w-4 h-4 mr-2 text-cyan-600" />
                Mark Ready
              </DropdownMenuItem>
            )}
            {row.status === 'ready' && (
              <DropdownMenuItem onClick={() => handleStatusChange(row, 'dispatched')}>
                <Truck className="w-4 h-4 mr-2 text-blue-600" />
                Dispatch
              </DropdownMenuItem>
            )}
            {row.status === 'dispatched' && (
              <DropdownMenuItem onClick={() => handleStatusChange(row, 'delivered')}>
                <CheckCircle className="w-4 h-4 mr-2 text-green-600" />
                Mark Delivered
              </DropdownMenuItem>
            )}
            <DropdownMenuSeparator />
            {row.payment_status === 'pending' && (
              <DropdownMenuItem onClick={() => handlePaymentStatus(row, 'paid')}>
                Mark as Paid
              </DropdownMenuItem>
            )}
            {!['delivered', 'cancelled'].includes(row.status) && (
              <DropdownMenuItem 
                onClick={() => handleStatusChange(row, 'cancelled')}
                className="text-red-600"
              >
                <Ban className="w-4 h-4 mr-2" />
                Cancel Order
              </DropdownMenuItem>
            )}
            {permissions.canDelete && (
              <>
                <DropdownMenuSeparator />
                <DropdownMenuItem 
                  onClick={() => deleteMutation.mutate(row.id)}
                  className="text-red-600"
                >
                  <Trash2 className="w-4 h-4 mr-2" />
                  Delete
                </DropdownMenuItem>
              </>
            )}
          </DropdownMenuContent>
        </DropdownMenu>
      )
    }
  ];

  return (
    <div>
      <PageHeader
        title="Sales Orders"
        description="Manage customer orders"
        action={permissions.canCreate ? () => window.location.href = createPageUrl('NewSalesOrder') : null}
        actionLabel="New Order"
      >
        <Select value={statusFilter} onValueChange={setStatusFilter}>
          <SelectTrigger className="w-40">
            <SelectValue placeholder="Status" />
          </SelectTrigger>
          <SelectContent>
            <SelectItem value="all">All Status</SelectItem>
            <SelectItem value="draft">Draft</SelectItem>
            <SelectItem value="pending_approval">Pending Approval</SelectItem>
            <SelectItem value="approved">Approved</SelectItem>
            <SelectItem value="processing">Processing</SelectItem>
            <SelectItem value="ready">Ready</SelectItem>
            <SelectItem value="dispatched">Dispatched</SelectItem>
            <SelectItem value="delivered">Delivered</SelectItem>
          </SelectContent>
        </Select>
        <div className="relative">
          <Search className="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400" />
          <Input
            placeholder="Search orders..."
            value={search}
            onChange={(e) => setSearch(e.target.value)}
            className="pl-10 w-64"
          />
        </div>
      </PageHeader>

      <DataTable
        columns={columns}
        data={filteredOrders}
        isLoading={isLoading}
        emptyMessage="No sales orders found."
      />

      {/* View Dialog */}
      <Dialog open={viewOpen} onOpenChange={setViewOpen}>
        <DialogContent className="max-w-2xl max-h-[90vh] overflow-y-auto">
          <DialogHeader>
            <DialogTitle>
              Order: {viewingOrder?.order_number || `#${viewingOrder?.id?.slice(-6)}`}
            </DialogTitle>
          </DialogHeader>
          {editedOrder && (
            <div className="space-y-6">
              <div className="grid grid-cols-2 gap-4">
                <div>
                  <p className="text-sm text-slate-500">Customer</p>
                  <p className="font-medium">{editedOrder.customer_name}</p>
                </div>
                <div>
                  <p className="text-sm text-slate-500">Order Type</p>
                  <p className="font-medium capitalize">{editedOrder.order_type}</p>
                </div>
                <div>
                  <p className="text-sm text-slate-500">Order Date</p>
                  <p className="font-medium">
                    {editedOrder.order_date ? format(new Date(editedOrder.order_date), 'MMM dd, yyyy') : '-'}
                  </p>
                </div>
                <div>
                  <p className="text-sm text-slate-500">Requested Delivery</p>
                  <p className="font-medium">
                    {editedOrder.requested_delivery_date ? format(new Date(editedOrder.requested_delivery_date), 'MMM dd, yyyy') : '-'}
                  </p>
                </div>
                <div>
                  <p className="text-sm text-slate-500">Order Status</p>
                  <StatusBadge status={editedOrder.status} />
                </div>
                <div>
                  <p className="text-sm text-slate-500">Payment Status</p>
                  <StatusBadge status={editedOrder.payment_status} />
                </div>
              </div>

              {editedOrder.shipping_address && (
                <div>
                  <p className="text-sm text-slate-500">Shipping Address</p>
                  <p className="font-medium">{editedOrder.shipping_address}</p>
                </div>
              )}

              <div>
                <h4 className="font-medium mb-3">Order Items</h4>
                <div className="space-y-2">
                  {editedOrder.items?.map((item, i) => (
                    <div key={i} className="flex justify-between p-3 bg-slate-50 rounded-lg">
                      <div>
                        <p className="font-medium">{item.product_name}</p>
                        <p className="text-sm text-slate-500">
                          {item.quantity} {item.unit} @ ₱{item.unit_price}
                          {item.discount > 0 && ` (-${item.discount}%)`}
                        </p>
                      </div>
                      <p className="font-medium">₱{item.total?.toFixed(2)}</p>
                    </div>
                  ))}
                </div>
              </div>

              <div className="border-t pt-4 space-y-2">
                <div className="flex justify-between">
                  <span className="text-slate-600">Subtotal</span>
                  <span>₱{editedOrder.subtotal?.toFixed(2)}</span>
                </div>
                {editedOrder.discount_amount > 0 && (
                  <div className="flex justify-between text-green-600">
                    <span>Discount</span>
                    <span>-₱{editedOrder.discount_amount?.toFixed(2)}</span>
                  </div>
                )}
                <div className="flex justify-between">
                  <span className="text-slate-600">Tax</span>
                  <span>₱{editedOrder.tax_amount?.toFixed(2)}</span>
                </div>
                {editedOrder.delivery_fee > 0 && (
                  <div className="flex justify-between">
                    <span className="text-slate-600">Delivery Fee</span>
                    <span>₱{editedOrder.delivery_fee?.toFixed(2)}</span>
                  </div>
                )}
                <div className="flex justify-between font-bold text-lg">
                  <span>Total</span>
                  <span>₱{editedOrder.total_amount?.toFixed(2)}</span>
                </div>
              </div>

              {editedOrder.notes && (
                <div>
                  <p className="text-sm text-slate-500">Notes</p>
                  <p className="text-slate-700">{editedOrder.notes}</p>
                </div>
              )}

              <div>
                <Label>Payment Proof</Label>
                {editedOrder.payment_proof_url ? (
                  <div className="space-y-2">
                    <img 
                      src={editedOrder.payment_proof_url} 
                      alt="Payment proof" 
                      className="w-full max-w-md h-64 object-cover rounded-lg border"
                    />
                    {permissions.canEdit && (
                      <Button
                        type="button"
                        variant="outline"
                        size="sm"
                        className="w-full text-red-600 hover:text-red-700"
                        onClick={() => setEditedOrder({ ...editedOrder, payment_proof_url: '' })}
                      >
                        <Trash2 className="w-4 h-4 mr-2" />
                        Remove Payment Proof
                      </Button>
                    )}
                  </div>
                ) : (
                  permissions.canEdit && (
                    <Input
                      type="file"
                      accept="image/*"
                      onChange={async (e) => {
                        const file = e.target.files?.[0];
                        if (file) {
                          const { file_url } = await base44.integrations.Core.UploadFile({ file });
                          setEditedOrder({ ...editedOrder, payment_proof_url: file_url });
                          toast.success('Payment proof uploaded');
                        }
                      }}
                    />
                  )
                )}
              </div>

              {permissions.canEdit && (
                <div className="flex justify-end gap-3 pt-4 border-t">
                  <Button 
                    variant="outline" 
                    onClick={() => setViewOpen(false)}
                  >
                    Cancel
                  </Button>
                  <Button
                    onClick={async () => {
                      await updateMutation.mutateAsync({ 
                        id: editedOrder.id, 
                        data: editedOrder
                      });
                      
                      // Send email to admins
                      const adminUsers = await base44.entities.User.filter({ role: 'admin' });
                      const emailBody = `
                        <h2>Order Updated</h2>
                        <p><strong>Order Number:</strong> ${editedOrder.order_number}</p>
                        <p><strong>Customer:</strong> ${editedOrder.customer_name}</p>
                        <p><strong>Total Amount:</strong> ₱${editedOrder.total_amount?.toLocaleString()}</p>
                        <p><strong>Status:</strong> ${editedOrder.status}</p>
                        <p><strong>Payment Status:</strong> ${editedOrder.payment_status}</p>
                        ${editedOrder.payment_proof_url ? `
                          <br/>
                          <p><strong>Payment Proof:</strong></p>
                          <img src="${editedOrder.payment_proof_url}" alt="Payment Proof" style="max-width: 400px; border: 1px solid #ddd; border-radius: 8px;"/>
                        ` : ''}
                      `;
                      
                      for (const admin of adminUsers) {
                        await base44.integrations.Core.SendEmail({
                          to: admin.email,
                          subject: `Order Updated - ${editedOrder.order_number}`,
                          body: emailBody
                        });
                      }
                      
                      setViewOpen(false);
                      toast.success('Order saved and admins notified');
                    }}
                    className="bg-emerald-600 hover:bg-emerald-700"
                  >
                    Save Changes
                  </Button>
                </div>
              )}
            </div>
          )}
        </DialogContent>
      </Dialog>
    </div>
  );
}

//SALES REPORT
import React, { useState } from 'react';
import { base44 } from '@/api/base44Client';
import { useQuery } from '@tanstack/react-query';
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { usePermissions } from '../components/shared/PermissionGuard';
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from "@/components/ui/select";
import StatCard from '../components/shared/StatCard';
import DataTable from '../components/shared/DataTable';
import StatusBadge from '../components/shared/StatusBadge';
import { 
  DollarSign, 
  ShoppingCart, 
  Users, 
  TrendingUp,
  Download,
  Calendar
} from 'lucide-react';
import { format, startOfMonth, endOfMonth, subMonths } from 'date-fns';
import { 
  AreaChart, 
  Area, 
  XAxis, 
  YAxis, 
  CartesianGrid, 
  Tooltip, 
  ResponsiveContainer,
  BarChart,
  Bar,
  PieChart,
  Pie,
  Cell,
  Legend
} from 'recharts';

const COLORS = ['#10b981', '#3b82f6', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899'];

export default function SalesReport() {
  const permissions = usePermissions();
  const [dateRange, setDateRange] = useState('this_month');
  const [startDate, setStartDate] = useState(format(startOfMonth(new Date()), 'yyyy-MM-dd'));
  const [endDate, setEndDate] = useState(format(endOfMonth(new Date()), 'yyyy-MM-dd'));

  const { data: orders = [], isLoading } = useQuery({
    queryKey: ['salesOrders'],
    queryFn: () => base44.entities.SalesOrder.list('-created_date', 500),
  });

  const { data: customers = [] } = useQuery({
    queryKey: ['customers'],
    queryFn: () => base44.entities.Customer.list(),
  });

  // Filter orders by date range
  const filteredOrders = orders.filter(o => {
    if (!o.order_date) return false;
    const orderDate = new Date(o.order_date);
    return orderDate >= new Date(startDate) && orderDate <= new Date(endDate);
  });

  // Calculate stats
  const totalSales = filteredOrders.reduce((sum, o) => sum + (o.total_amount || 0), 0);
  const totalOrders = filteredOrders.length;
  const averageOrderValue = totalOrders > 0 ? totalSales / totalOrders : 0;
  const paidOrders = filteredOrders.filter(o => o.payment_status === 'paid').length;
  const deliveredOrders = filteredOrders.filter(o => o.status === 'delivered').length;

  // Sales by customer type
  const salesByCustomerType = filteredOrders.reduce((acc, order) => {
    const customer = customers.find(c => c.id === order.customer_id);
    const type = customer?.customer_type || 'other';
    acc[type] = (acc[type] || 0) + (order.total_amount || 0);
    return acc;
  }, {});

  const customerTypePieData = Object.entries(salesByCustomerType).map(([type, value]) => ({
    name: type.charAt(0).toUpperCase() + type.slice(1),
    value
  }));

  // Sales by day
  const salesByDay = filteredOrders.reduce((acc, order) => {
    const date = order.order_date;
    acc[date] = (acc[date] || 0) + (order.total_amount || 0);
    return acc;
  }, {});

  const salesChartData = Object.entries(salesByDay)
    .sort(([a], [b]) => new Date(a).getTime() - new Date(b).getTime())
    .map(([date, amount]) => ({
      date: format(new Date(date), 'MMM dd'),
      amount
    }));

  // Top customers
  const customerSales = filteredOrders.reduce((acc, order) => {
    acc[order.customer_name] = (acc[order.customer_name] || 0) + (order.total_amount || 0);
    return acc;
  }, {});

  const topCustomers = Object.entries(customerSales)
    .sort(([,a], [,b]) => b - a)
    .slice(0, 5)
    .map(([name, total]) => ({ name, total }));

  // Orders by status
  const ordersByStatus = filteredOrders.reduce((acc, order) => {
    acc[order.status] = (acc[order.status] || 0) + 1;
    return acc;
  }, {});

  const statusBarData = Object.entries(ordersByStatus).map(([status, count]) => ({
    status: status.replace(/_/g, ' '),
    count
  }));

  const handleDateRangeChange = (value) => {
    setDateRange(value);
    const today = new Date();
    switch (value) {
      case 'this_month':
        setStartDate(format(startOfMonth(today), 'yyyy-MM-dd'));
        setEndDate(format(endOfMonth(today), 'yyyy-MM-dd'));
        break;
      case 'last_month':
        const lastMonth = subMonths(today, 1);
        setStartDate(format(startOfMonth(lastMonth), 'yyyy-MM-dd'));
        setEndDate(format(endOfMonth(lastMonth), 'yyyy-MM-dd'));
        break;
      case 'last_3_months':
        setStartDate(format(subMonths(today, 3), 'yyyy-MM-dd'));
        setEndDate(format(today, 'yyyy-MM-dd'));
        break;
      default:
        break;
    }
  };

  const orderColumns = [
    {
      header: 'Order',
      cell: (row) => (
        <div>
          <p className="font-medium">{row.order_number || `#${row.id?.slice(-6)}`}</p>
          <p className="text-sm text-slate-500">{row.customer_name}</p>
        </div>
      )
    },
    {
      header: 'Date',
      cell: (row) => format(new Date(row.order_date), 'MMM dd, yyyy')
    },
    {
      header: 'Items',
      cell: (row) => `${row.items?.length || 0} items`
    },
    {
      header: 'Total',
      cell: (row) => <span className="font-semibold">₱{(row.total_amount || 0).toFixed(2)}</span>
    },
    {
      header: 'Payment',
      cell: (row) => <StatusBadge status={row.payment_status} />
    },
    {
      header: 'Status',
      cell: (row) => <StatusBadge status={row.status} />
    }
  ];

  return (
    <div className="space-y-6">
      {/* Header with filters */}
      <div className="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
        <div>
          <h1 className="text-2xl font-bold text-slate-900">Sales Report</h1>
          <p className="text-slate-500">Analyze your sales performance</p>
        </div>
        <div className="flex items-center gap-3 flex-wrap">
          <Select value={dateRange} onValueChange={handleDateRangeChange}>
            <SelectTrigger className="w-40">
              <SelectValue />
            </SelectTrigger>
            <SelectContent>
              <SelectItem value="this_month">This Month</SelectItem>
              <SelectItem value="last_month">Last Month</SelectItem>
              <SelectItem value="last_3_months">Last 3 Months</SelectItem>
              <SelectItem value="custom">Custom</SelectItem>
            </SelectContent>
          </Select>
          {dateRange === 'custom' && (
            <>
              <Input
                type="date"
                value={startDate}
                onChange={(e) => setStartDate(e.target.value)}
                className="w-36"
              />
              <Input
                type="date"
                value={endDate}
                onChange={(e) => setEndDate(e.target.value)}
                className="w-36"
              />
            </>
          )}
          {permissions.canExport && (
            <Button variant="outline">
              <Download className="w-4 h-4 mr-2" />
              Export
            </Button>
          )}
        </div>
      </div>

      {/* Stats Grid */}
      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
        <StatCard
          title="Total Sales"
          value={`₱${totalSales.toLocaleString()}`}
          icon={DollarSign}
          iconColor="bg-emerald-100 text-emerald-600"
          loading={isLoading}
        />
        <StatCard
          title="Total Orders"
          value={totalOrders}
          icon={ShoppingCart}
          iconColor="bg-blue-100 text-blue-600"
          loading={isLoading}
        />
        <StatCard
          title="Average Order Value"
          value={`₱${averageOrderValue.toFixed(2)}`}
          icon={TrendingUp}
          iconColor="bg-amber-100 text-amber-600"
          loading={isLoading}
        />
        <StatCard
          title="Delivered Orders"
          value={`${deliveredOrders} / ${totalOrders}`}
          icon={Users}
          iconColor="bg-purple-100 text-purple-600"
          loading={isLoading}
        />
      </div>

      {/* Charts */}
      <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
        {/* Sales Trend */}
        <Card>
          <CardHeader>
            <CardTitle>Sales Trend</CardTitle>
          </CardHeader>
          <CardContent>
            <div className="h-[300px]">
              {salesChartData.length > 0 ? (
                <ResponsiveContainer width="100%" height="100%">
                  <AreaChart data={salesChartData}>
                    <CartesianGrid strokeDasharray="3 3" stroke="#e2e8f0" />
                    <XAxis dataKey="date" stroke="#64748b" fontSize={12} />
                    <YAxis stroke="#64748b" fontSize={12} />
                    <Tooltip />
                    <Area 
                      type="monotone" 
                      dataKey="amount" 
                      stroke="#10b981" 
                      fill="#d1fae5" 
                      strokeWidth={2}
                    />
                  </AreaChart>
                </ResponsiveContainer>
              ) : (
                <div className="h-full flex items-center justify-center text-slate-500">
                  No data for selected period
                </div>
              )}
            </div>
          </CardContent>
        </Card>

        {/* Sales by Customer Type */}
        <Card>
          <CardHeader>
            <CardTitle>Sales by Customer Type</CardTitle>
          </CardHeader>
          <CardContent>
            <div className="h-[300px]">
              {customerTypePieData.length > 0 ? (
                <ResponsiveContainer width="100%" height="100%">
                  <PieChart>
                    <Pie
                      data={customerTypePieData}
                      cx="50%"
                      cy="50%"
                      innerRadius={60}
                      outerRadius={100}
                      paddingAngle={5}
                      dataKey="value"
                      label={({ name, percent }) => `${name} ${(percent * 100).toFixed(0)}%`}
                    >
                      {customerTypePieData.map((_, index) => (
                        <Cell key={`cell-${index}`} fill={COLORS[index % COLORS.length]} />
                      ))}
                    </Pie>
                    <Tooltip formatter={(value) => `₱${value.toLocaleString()}`} />
                  </PieChart>
                </ResponsiveContainer>
              ) : (
                <div className="h-full flex items-center justify-center text-slate-500">
                  No data available
                </div>
              )}
            </div>
          </CardContent>
        </Card>
      </div>

      <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
        {/* Orders by Status */}
        <Card>
          <CardHeader>
            <CardTitle>Orders by Status</CardTitle>
          </CardHeader>
          <CardContent>
            <div className="h-[250px]">
              {statusBarData.length > 0 ? (
                <ResponsiveContainer width="100%" height="100%">
                  <BarChart data={statusBarData}>
                    <CartesianGrid strokeDasharray="3 3" stroke="#e2e8f0" />
                    <XAxis dataKey="status" stroke="#64748b" fontSize={11} />
                    <YAxis stroke="#64748b" fontSize={12} />
                    <Tooltip />
                    <Bar dataKey="count" fill="#3b82f6" radius={[4, 4, 0, 0]} />
                  </BarChart>
                </ResponsiveContainer>
              ) : (
                <div className="h-full flex items-center justify-center text-slate-500">
                  No data available
                </div>
              )}
            </div>
          </CardContent>
        </Card>

        {/* Top Customers */}
        <Card>
          <CardHeader>
            <CardTitle>Top Customers</CardTitle>
          </CardHeader>
          <CardContent>
            <div className="space-y-4">
              {topCustomers.length > 0 ? (
                topCustomers.map((customer, i) => (
                  <div key={customer.name} className="flex items-center justify-between">
                    <div className="flex items-center gap-3">
                      <div className={`w-8 h-8 rounded-full flex items-center justify-center ${
                        ['bg-emerald-100', 'bg-blue-100', 'bg-amber-100', 'bg-purple-100', 'bg-pink-100'][i]
                      }`}>
                        <span className={`text-sm font-medium ${
                          ['text-emerald-600', 'text-blue-600', 'text-amber-600', 'text-purple-600', 'text-pink-600'][i]
                        }`}>
                          {i + 1}
                        </span>
                      </div>
                      <span className="font-medium text-slate-900">{customer.name}</span>
                    </div>
                    <span className="font-semibold">₱{customer.total.toLocaleString()}</span>
                  </div>
                ))
              ) : (
                <p className="text-slate-500 text-center py-4">No sales data</p>
              )}
            </div>
          </CardContent>
        </Card>
      </div>

      {/* Orders Table */}
      <Card>
        <CardHeader>
          <CardTitle>Order Details</CardTitle>
        </CardHeader>
        <CardContent>
          <DataTable
            columns={orderColumns}
            data={filteredOrders.slice(0, 20)}
            isLoading={isLoading}
            emptyMessage="No orders in selected period"
          />
        </CardContent>
      </Card>
    </div>
  );
}

//SUPPLIERS

import React, { useState } from 'react';
import { base44 } from '@/api/base44Client';
import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';
import PageHeader from '../components/shared/PageHeader';
import DataTable from '../components/shared/DataTable';
import StatusBadge from '../components/shared/StatusBadge';
import PermissionGuard, { usePermissions } from '../components/shared/PermissionGuard';
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Textarea } from "@/components/ui/textarea";
import {
  Dialog,
  DialogContent,
  DialogHeader,
  DialogTitle,
} from "@/components/ui/dialog";
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from "@/components/ui/select";
import { Search, Building2, Phone, Mail, MapPin, MoreVertical, Pencil, Trash2 } from 'lucide-react';
import {
  DropdownMenu,
  DropdownMenuContent,
  DropdownMenuItem,
  DropdownMenuTrigger,
} from "@/components/ui/dropdown-menu";
import { toast } from "sonner";

export default function Suppliers() {
  const permissions = usePermissions();
  const [isOpen, setIsOpen] = useState(false);
  const [editingSupplier, setEditingSupplier] = useState(null);
  const [search, setSearch] = useState('');
  const [formData, setFormData] = useState({
    name: '',
    contact_person: '',
    email: '',
    phone: '',
    address: '',
    payment_terms: 'net_30',
    status: 'active',
    notes: ''
  });

  const queryClient = useQueryClient();

  const { data: suppliers = [], isLoading } = useQuery({
    queryKey: ['suppliers'],
    queryFn: () => base44.entities.Supplier.list('-created_date'),
  });

  const createMutation = useMutation({
    mutationFn: (data) => base44.entities.Supplier.create(data),
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['suppliers'] });
      toast.success('Supplier created successfully');
      handleClose();
    },
  });

  const updateMutation = useMutation({
    mutationFn: ({ id, data }) => base44.entities.Supplier.update(id, data),
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['suppliers'] });
      toast.success('Supplier updated successfully');
      handleClose();
    },
  });

  const deleteMutation = useMutation({
    mutationFn: (id) => base44.entities.Supplier.delete(id),
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['suppliers'] });
      toast.success('Supplier deleted successfully');
    },
  });

  const handleOpen = (supplier = null) => {
    if (supplier) {
      setEditingSupplier(supplier);
      setFormData({
        name: supplier.name || '',
        contact_person: supplier.contact_person || '',
        email: supplier.email || '',
        phone: supplier.phone || '',
        address: supplier.address || '',
        payment_terms: supplier.payment_terms || 'net_30',
        status: supplier.status || 'active',
        notes: supplier.notes || ''
      });
    } else {
      setEditingSupplier(null);
      setFormData({
        name: '',
        contact_person: '',
        email: '',
        phone: '',
        address: '',
        payment_terms: 'net_30',
        status: 'active',
        notes: ''
      });
    }
    setIsOpen(true);
  };

  const handleClose = () => {
    setIsOpen(false);
    setEditingSupplier(null);
    setFormData({
      name: '',
      contact_person: '',
      email: '',
      phone: '',
      address: '',
      payment_terms: 'net_30',
      status: 'active',
      notes: ''
    });
  };

  const handleSubmit = (e) => {
    e.preventDefault();
    if (editingSupplier) {
      updateMutation.mutate({ id: editingSupplier.id, data: formData });
    } else {
      createMutation.mutate(formData);
    }
  };

  const filteredSuppliers = suppliers.filter(s => 
    s.name?.toLowerCase().includes(search.toLowerCase()) ||
    s.email?.toLowerCase().includes(search.toLowerCase()) ||
    s.contact_person?.toLowerCase().includes(search.toLowerCase())
  );

  const columns = [
    {
      header: 'Supplier',
      cell: (row) => (
        <div className="flex items-center gap-3">
          <div className="w-10 h-10 rounded-lg bg-emerald-100 flex items-center justify-center">
            <Building2 className="w-5 h-5 text-emerald-600" />
          </div>
          <div>
            <p className="font-medium text-slate-900">{row.name}</p>
            <p className="text-sm text-slate-500">{row.contact_person}</p>
          </div>
        </div>
      )
    },
    {
      header: 'Contact',
      cell: (row) => (
        <div className="space-y-1">
          <div className="flex items-center gap-2 text-sm text-slate-600">
            <Mail className="w-4 h-4" />
            {row.email}
          </div>
          {row.phone && (
            <div className="flex items-center gap-2 text-sm text-slate-500">
              <Phone className="w-4 h-4" />
              {row.phone}
            </div>
          )}
        </div>
      )
    },
    {
      header: 'Payment Terms',
      cell: (row) => (
        <span className="text-sm text-slate-600 capitalize">
          {row.payment_terms?.replace(/_/g, ' ')}
        </span>
      )
    },
    {
      header: 'Status',
      cell: (row) => <StatusBadge status={row.status} />
    },
    {
      header: '',
      className: 'w-12',
      cell: (row) => (
        <DropdownMenu>
          <DropdownMenuTrigger asChild>
            <Button variant="ghost" size="icon">
              <MoreVertical className="w-4 h-4" />
            </Button>
          </DropdownMenuTrigger>
          <DropdownMenuContent align="end">
            {permissions.canEdit && (
              <DropdownMenuItem onClick={() => handleOpen(row)}>
                <Pencil className="w-4 h-4 mr-2" />
                Edit
              </DropdownMenuItem>
            )}
            {permissions.canDelete && (
              <DropdownMenuItem 
                onClick={() => deleteMutation.mutate(row.id)}
                className="text-red-600"
              >
                <Trash2 className="w-4 h-4 mr-2" />
                Delete
              </DropdownMenuItem>
            )}
          </DropdownMenuContent>
        </DropdownMenu>
      )
    }
  ];

  return (
    <div>
      <PageHeader
        title="Suppliers"
        description="Manage your raw material suppliers"
        action={permissions.canEdit ? () => handleOpen() : null}
        actionLabel="Add Supplier"
      >
        <div className="relative">
          <Search className="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400" />
          <Input
            placeholder="Search suppliers..."
            value={search}
            onChange={(e) => setSearch(e.target.value)}
            className="pl-10 w-64"
          />
        </div>
      </PageHeader>

      <DataTable
        columns={columns}
        data={filteredSuppliers}
        isLoading={isLoading}
        emptyMessage="No suppliers found. Add your first supplier to get started."
      />

      <Dialog open={isOpen} onOpenChange={setIsOpen}>
        <DialogContent className="max-w-lg">
          <DialogHeader>
            <DialogTitle>
              {editingSupplier ? 'Edit Supplier' : 'Add New Supplier'}
            </DialogTitle>
          </DialogHeader>
          <form onSubmit={handleSubmit} className="space-y-4">
            <div className="grid grid-cols-2 gap-4">
              <div className="col-span-2">
                <Label>Company Name *</Label>
                <Input
                  value={formData.name}
                  onChange={(e) => setFormData({ ...formData, name: e.target.value })}
                  required
                />
              </div>
              <div>
                <Label>Contact Person *</Label>
                <Input
                  value={formData.contact_person}
                  onChange={(e) => setFormData({ ...formData, contact_person: e.target.value })}
                  required
                />
              </div>
              <div>
                <Label>Email *</Label>
                <Input
                  type="email"
                  value={formData.email}
                  onChange={(e) => setFormData({ ...formData, email: e.target.value })}
                  required
                />
              </div>
              <div>
                <Label>Phone</Label>
                <Input
                  value={formData.phone}
                  onChange={(e) => setFormData({ ...formData, phone: e.target.value })}
                />
              </div>
              <div>
                <Label>Payment Terms</Label>
                <Select
                  value={formData.payment_terms}
                  onValueChange={(value) => setFormData({ ...formData, payment_terms: value })}
                >
                  <SelectTrigger>
                    <SelectValue />
                  </SelectTrigger>
                  <SelectContent>
                    <SelectItem value="cod">Cash on Delivery</SelectItem>
                    <SelectItem value="net_15">Net 15</SelectItem>
                    <SelectItem value="net_30">Net 30</SelectItem>
                    <SelectItem value="net_45">Net 45</SelectItem>
                    <SelectItem value="net_60">Net 60</SelectItem>
                  </SelectContent>
                </Select>
              </div>
              <div className="col-span-2">
                <Label>Address</Label>
                <Textarea
                  value={formData.address}
                  onChange={(e) => setFormData({ ...formData, address: e.target.value })}
                  rows={2}
                />
              </div>
              <div>
                <Label>Status</Label>
                <Select
                  value={formData.status}
                  onValueChange={(value) => setFormData({ ...formData, status: value })}
                >
                  <SelectTrigger>
                    <SelectValue />
                  </SelectTrigger>
                  <SelectContent>
                    <SelectItem value="active">Active</SelectItem>
                    <SelectItem value="inactive">Inactive</SelectItem>
                    <SelectItem value="pending_approval">Pending Approval</SelectItem>
                  </SelectContent>
                </Select>
              </div>
              <div className="col-span-2">
                <Label>Notes</Label>
                <Textarea
                  value={formData.notes}
                  onChange={(e) => setFormData({ ...formData, notes: e.target.value })}
                  rows={2}
                />
              </div>
            </div>
            <div className="flex justify-end gap-3 pt-4">
              <Button type="button" variant="outline" onClick={handleClose}>
                Cancel
              </Button>
              <Button 
                type="submit" 
                className="bg-emerald-600 hover:bg-emerald-700"
                disabled={createMutation.isPending || updateMutation.isPending}
              >
                {editingSupplier ? 'Update' : 'Create'} Supplier
              </Button>
            </div>
          </form>
        </DialogContent>
      </Dialog>
    </div>
  );
}

// USER MANAGEMENT 

import React, { useState } from 'react';
import { base44 } from '@/api/base44Client';
import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';
import PageHeader from '../components/shared/PageHeader';
import DataTable from '../components/shared/DataTable';
import StatusBadge from '../components/shared/StatusBadge';
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Switch } from "@/components/ui/switch";
import {
  Dialog,
  DialogContent,
  DialogHeader,
  DialogTitle,
} from "@/components/ui/dialog";
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from "@/components/ui/select";
import { Search, UserCircle, MoreVertical, Pencil, Mail, Phone, Shield } from 'lucide-react';
import {
  DropdownMenu,
  DropdownMenuContent,
  DropdownMenuItem,
  DropdownMenuTrigger,
} from "@/components/ui/dropdown-menu";
import { Badge } from "@/components/ui/badge";
import { toast } from "sonner";

const DEPARTMENTS = [
  { value: 'production', label: 'Production' },
  { value: 'sales', label: 'Sales' },
  { value: 'accounting', label: 'Accounting' },
  { value: 'management', label: 'Management' },
  { value: 'warehouse', label: 'Warehouse' },
  { value: 'delivery', label: 'Delivery' },
  { value: 'quality', label: 'Quality Control' }
];

const SYSTEM_ROLES = [
  { value: 'admin', label: 'Admin', description: 'Full access, all approvals, all edits' },
  { value: 'sales', label: 'Sales', description: 'Sales, Delivery, Reports, Dashboard' },
  { value: 'management', label: 'Management', description: 'View all, approve flows, no edits' },
  { value: 'concessionaire', label: 'Concessionaire', description: 'Dashboard and Reports only, no edits' },
  { value: 'guest', label: 'Guest', description: 'Dashboard only, read-only, no exports' }
];

export default function UserManagement() {
  const [isOpen, setIsOpen] = useState(false);
  const [inviteOpen, setInviteOpen] = useState(false);
  const [editingUser, setEditingUser] = useState(null);
  const [search, setSearch] = useState('');
  const [departmentFilter, setDepartmentFilter] = useState('all');
  const [inviteEmail, setInviteEmail] = useState('');
  const [inviteRole, setInviteRole] = useState('user');
  const [formData, setFormData] = useState({
    custom_role: 'guest',
    department: '',
    job_title: '',
    phone: '',
    can_approve_po: false,
    can_approve_orders: false,
    po_approval_limit: 0,
    status: 'active'
  });

  const queryClient = useQueryClient();

  const { data: users = [], isLoading } = useQuery({
    queryKey: ['users'],
    queryFn: () => base44.entities.User.list('-created_date'),
  });

  const updateMutation = useMutation({
    mutationFn: ({ id, data }) => base44.entities.User.update(id, data),
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['users'] });
      toast.success('User updated successfully');
      handleClose();
    },
  });

  const handleOpen = (user) => {
    setEditingUser(user);
    setFormData({
      custom_role: user.custom_role || user.role || 'guest',
      department: user.department || '',
      job_title: user.job_title || '',
      phone: user.phone || '',
      can_approve_po: user.can_approve_po || false,
      can_approve_orders: user.can_approve_orders || false,
      po_approval_limit: user.po_approval_limit || 0,
      status: user.status || 'active'
    });
    setIsOpen(true);
  };

  const handleClose = () => {
    setIsOpen(false);
    setEditingUser(null);
  };

  const handleSubmit = (e) => {
    e.preventDefault();
    updateMutation.mutate({ id: editingUser.id, data: formData });
  };

  const handleInvite = async (e) => {
    e.preventDefault();
    try {
      await base44.users.inviteUser(inviteEmail, inviteRole);
      toast.success(`Invitation sent to ${inviteEmail}`);
      setInviteOpen(false);
      setInviteEmail('');
      setInviteRole('user');
    } catch (error) {
      toast.error('Failed to send invitation');
    }
  };

  const filteredUsers = users.filter(u => {
    const matchesSearch = u.full_name?.toLowerCase().includes(search.toLowerCase()) ||
      u.email?.toLowerCase().includes(search.toLowerCase());
    const matchesDepartment = departmentFilter === 'all' || u.department === departmentFilter;
    return matchesSearch && matchesDepartment;
  });

  const columns = [
    {
      header: 'User',
      cell: (row) => (
        <div className="flex items-center gap-3">
          <div className="w-10 h-10 rounded-full bg-gradient-to-br from-slate-200 to-slate-300 flex items-center justify-center">
            <UserCircle className="w-6 h-6 text-slate-600" />
          </div>
          <div>
            <p className="font-medium text-slate-900">{row.full_name || 'Unnamed'}</p>
            <p className="text-sm text-slate-500">{row.email}</p>
          </div>
        </div>
      )
    },
    {
      header: 'System Role',
      cell: (row) => {
        const role = row.custom_role || row.role || 'guest';
        const roleConfig = {
          admin: { color: 'bg-purple-100 text-purple-700 border-purple-200', label: 'Admin' },
          sales: { color: 'bg-blue-100 text-blue-700 border-blue-200', label: 'Sales' },
          management: { color: 'bg-emerald-100 text-emerald-700 border-emerald-200', label: 'Management' },
          concessionaire: { color: 'bg-amber-100 text-amber-700 border-amber-200', label: 'Concessionaire' },
          guest: { color: 'bg-slate-100 text-slate-700 border-slate-200', label: 'Guest' }
        };
        const config = roleConfig[role] || roleConfig.guest;
        return (
          <Badge variant="outline" className={config.color}>
            <Shield className="w-3 h-3 mr-1" />
            {config.label}
          </Badge>
        );
      }
    },
    {
      header: 'Department',
      cell: (row) => (
        <span className="text-slate-600 capitalize">
          {row.department || '-'}
        </span>
      )
    },
    {
      header: 'Job Title',
      cell: (row) => (
        <span className="text-slate-600">{row.job_title || '-'}</span>
      )
    },
    {
      header: 'Permissions',
      cell: (row) => (
        <div className="flex gap-1">
          {row.can_approve_po && (
            <Badge variant="outline" className="text-xs">PO Approval</Badge>
          )}
          {row.can_approve_orders && (
            <Badge variant="outline" className="text-xs">Order Approval</Badge>
          )}
          {!row.can_approve_po && !row.can_approve_orders && (
            <span className="text-slate-400 text-sm">No special permissions</span>
          )}
        </div>
      )
    },
    {
      header: 'Status',
      cell: (row) => <StatusBadge status={row.status || 'active'} />
    },
    {
      header: '',
      className: 'w-12',
      cell: (row) => (
        <DropdownMenu>
          <DropdownMenuTrigger asChild>
            <Button variant="ghost" size="icon">
              <MoreVertical className="w-4 h-4" />
            </Button>
          </DropdownMenuTrigger>
          <DropdownMenuContent align="end">
            <DropdownMenuItem onClick={() => handleOpen(row)}>
              <Pencil className="w-4 h-4 mr-2" />
              Edit Permissions
            </DropdownMenuItem>
          </DropdownMenuContent>
        </DropdownMenu>
      )
    }
  ];

  return (
    <div>
      <PageHeader
        title="User Management"
        description="Manage users and their permissions"
        action={() => setInviteOpen(true)}
        actionLabel="Invite User"
      >
        <Select value={departmentFilter} onValueChange={setDepartmentFilter}>
          <SelectTrigger className="w-40">
            <SelectValue placeholder="Department" />
          </SelectTrigger>
          <SelectContent>
            <SelectItem value="all">All Departments</SelectItem>
            {DEPARTMENTS.map(d => (
              <SelectItem key={d.value} value={d.value}>{d.label}</SelectItem>
            ))}
          </SelectContent>
        </Select>
        <div className="relative">
          <Search className="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400" />
          <Input
            placeholder="Search users..."
            value={search}
            onChange={(e) => setSearch(e.target.value)}
            className="pl-10 w-64"
          />
        </div>
      </PageHeader>

      <DataTable
        columns={columns}
        data={filteredUsers}
        isLoading={isLoading}
        emptyMessage="No users found."
      />

      {/* Edit User Dialog */}
      <Dialog open={isOpen} onOpenChange={setIsOpen}>
        <DialogContent className="max-w-md">
          <DialogHeader>
            <DialogTitle>Edit User Permissions</DialogTitle>
          </DialogHeader>
          <form onSubmit={handleSubmit} className="space-y-4">
            <div className="p-3 bg-slate-50 rounded-lg">
              <p className="font-medium">{editingUser?.full_name}</p>
              <p className="text-sm text-slate-500">{editingUser?.email}</p>
            </div>
            
            <div className="grid grid-cols-2 gap-4">
              <div>
                <Label>Department</Label>
                <Select
                  value={formData.department}
                  onValueChange={(value) => setFormData({ ...formData, department: value })}
                >
                  <SelectTrigger>
                    <SelectValue placeholder="Select department" />
                  </SelectTrigger>
                  <SelectContent>
                    {DEPARTMENTS.map(d => (
                      <SelectItem key={d.value} value={d.value}>{d.label}</SelectItem>
                    ))}
                  </SelectContent>
                </Select>
              </div>
              <div>
                <Label>Job Title</Label>
                <Input
                  value={formData.job_title}
                  onChange={(e) => setFormData({ ...formData, job_title: e.target.value })}
                />
              </div>
            </div>
            <div>
              <Label>Phone</Label>
              <Input
                value={formData.phone}
                onChange={(e) => setFormData({ ...formData, phone: e.target.value })}
              />
            </div>

            <div className="space-y-4 pt-4 border-t">
              <h4 className="font-medium">Approval Permissions</h4>
              {(formData.custom_role === 'admin' || formData.custom_role === 'management') && (
                <div className="p-3 bg-emerald-50 rounded-lg text-sm text-emerald-700">
                  This role has automatic approval permissions
                </div>
              )}
              <div className="flex items-center justify-between">
                <div>
                  <p className="font-medium text-sm">Approve Purchase Orders</p>
                  <p className="text-xs text-slate-500">Can approve PO requests</p>
                </div>
                <Switch
                  checked={formData.can_approve_po}
                  onCheckedChange={(checked) => setFormData({ ...formData, can_approve_po: checked })}
                  disabled={formData.custom_role === 'admin' || formData.custom_role === 'management'}
                />
              </div>
              {formData.can_approve_po && (
                <div>
                  <Label>PO Approval Limit ($)</Label>
                  <Input
                    type="number"
                    min="0"
                    value={formData.po_approval_limit}
                    onChange={(e) => setFormData({ ...formData, po_approval_limit: parseFloat(e.target.value) || 0 })}
                  />
                </div>
              )}
              <div className="flex items-center justify-between">
                <div>
                  <p className="font-medium text-sm">Approve Sales Orders</p>
                  <p className="text-xs text-slate-500">Can approve customer orders</p>
                </div>
                <Switch
                  checked={formData.can_approve_orders}
                  onCheckedChange={(checked) => setFormData({ ...formData, can_approve_orders: checked })}
                  disabled={formData.custom_role === 'admin' || formData.custom_role === 'management'}
                />
              </div>
            </div>

            <div>
              <Label>Status</Label>
              <Select
                value={formData.status}
                onValueChange={(value) => setFormData({ ...formData, status: value })}
              >
                <SelectTrigger>
                  <SelectValue />
                </SelectTrigger>
                <SelectContent>
                  <SelectItem value="active">Active</SelectItem>
                  <SelectItem value="inactive">Inactive</SelectItem>
                </SelectContent>
              </Select>
            </div>

            <div className="flex justify-end gap-3 pt-4">
              <Button type="button" variant="outline" onClick={handleClose}>
                Cancel
              </Button>
              <Button 
                type="submit" 
                className="bg-emerald-600 hover:bg-emerald-700"
                disabled={updateMutation.isPending}
              >
                Save Changes
              </Button>
            </div>
          </form>
        </DialogContent>
      </Dialog>

      {/* Invite User Dialog */}
      <Dialog open={inviteOpen} onOpenChange={setInviteOpen}>
        <DialogContent className="max-w-md">
          <DialogHeader>
            <DialogTitle>Invite New User</DialogTitle>
          </DialogHeader>
          <form onSubmit={handleInvite} className="space-y-4">
            <div>
              <Label>Email Address *</Label>
              <Input
                type="email"
                value={inviteEmail}
                onChange={(e) => setInviteEmail(e.target.value)}
                placeholder="user@example.com"
                required
              />
            </div>
            <div>
              <Label>Role</Label>
              <Select value={inviteRole} onValueChange={setInviteRole}>
                <SelectTrigger>
                  <SelectValue />
                </SelectTrigger>
                <SelectContent>
                  <SelectItem value="user">User</SelectItem>
                  <SelectItem value="admin">Admin</SelectItem>
                </SelectContent>
              </Select>
            </div>
            <div className="flex justify-end gap-3 pt-4">
              <Button type="button" variant="outline" onClick={() => setInviteOpen(false)}>
                Cancel
              </Button>
              <Button type="submit" className="bg-emerald-600 hover:bg-emerald-700">
                Send Invitation
              </Button>
            </div>
          </form>
        </DialogContent>
      </Dialog>
    </div>
  );
}



